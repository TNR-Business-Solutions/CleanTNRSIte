<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - TNR Business Solutions</title>
    <link rel="stylesheet" href="assets/styles.css">
    <style>
        .admin-dashboard {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--tnr-primary), var(--tnr-secondary));
            padding: 2rem 0;
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .dashboard-header {
            text-align: center;
            margin-bottom: 3rem;
            color: white;
        }
        
        .dashboard-header h1 {
            color: var(--tnr-gold);
            margin-bottom: 0.5rem;
            font-size: 2.5rem;
        }
        
        .dashboard-header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
        }
        
        .dashboard-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .tab-button {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .tab-button.active {
            background: var(--tnr-gold);
            border-color: var(--tnr-gold);
            color: var(--tnr-navy);
        }
        
        .tab-button:hover:not(.active) {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .dashboard-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .card-icon {
            font-size: 2rem;
            margin-right: 1rem;
        }
        
        .card-title {
            color: var(--tnr-gold);
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        .card-description {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }
        
        .card-actions {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        
        .card-btn {
            background: var(--tnr-gold);
            color: var(--tnr-navy);
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            text-decoration: none;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .card-btn:hover {
            background: #ffd700;
            transform: translateY(-2px);
        }
        
        .card-btn.secondary {
            background: transparent;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .card-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .crm-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .crm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .crm-title {
            color: var(--tnr-gold);
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .crm-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            color: var(--tnr-gold);
            font-size: 2rem;
            font-weight: bold;
        }
        
        .stat-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }
        
        .crm-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .crm-tab {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .crm-tab.active {
            background: var(--tnr-gold);
            color: var(--tnr-navy);
        }
        
        .crm-content {
            display: none;
        }
        
        .crm-content.active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .client-list {
            min-height: 200px;
        }
        
        .no-data {
            padding: 2rem;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
        }
        
        .client-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .client-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .client-info h4 {
            color: var(--tnr-gold);
            margin-bottom: 0.5rem;
        }
        
        .client-info p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }
        
        .client-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-active {
            background: #28a745;
            color: white;
        }
        
        .status-lead {
            background: #ffc107;
            color: var(--tnr-navy);
        }
        
        .status-prospect {
            background: #17a2b8;
            color: white;
        }
        
        .status-closed {
            background: #6c757d;
            color: white;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            color: var(--tnr-gold);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
        }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--tnr-gold);
        }
        
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .btn {
            background: var(--tnr-gold);
            color: var(--tnr-navy);
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 2px;
        }
        
        .btn:hover {
            background: #ffd700;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: var(--tnr-primary);
            color: white;
        }
        
        .btn-secondary:hover {
            background: var(--tnr-secondary);
        }
        
        .automation-workflow {
            background: rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 1rem;
        }
        
        .workflow-step {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .step-number {
            background: var(--tnr-gold);
            color: var(--tnr-navy);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }
        
        .step-content h4 {
            color: var(--tnr-gold);
            margin-bottom: 0.5rem;
        }
        
        .step-content p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }
        
        .live-demo {
            background: linear-gradient(135deg, #28a745, #20c997);
            padding: 2rem;
            border-radius: 20px;
            margin-top: 2rem;
            text-align: center;
        }
        
        .live-demo h3 {
            color: white;
            margin-bottom: 1rem;
        }
        
        .live-demo p {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 1.5rem;
        }
        
        .demo-btn {
            background: white;
            color: #28a745;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
        }
        
        .demo-btn:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-tabs {
                flex-direction: column;
                align-items: center;
            }
            
            .crm-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn-group {
                flex-direction: column;
            }
        }
        
        /* Modal Styles */
        .modal {
            display: block;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            background: var(--tnr-primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
        }
        
        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            opacity: 0.7;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            background: #f8f9fa;
            border-radius: 0 0 10px 10px;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--tnr-navy);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--tnr-accent);
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            margin-bottom: 0;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            margin: 0.25rem;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .client-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-end;
        }
        
        .no-data {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header-placeholder"></div>
    <div class="admin-dashboard">
        <div class="dashboard-container">
            <div class="dashboard-header">
                <h1>üéØ TNR Business Solutions Admin Dashboard</h1>
                <p>Complete CRM, Automation & Social Media Management System</p>
            </div>
            
            <div class="dashboard-tabs">
                <button class="tab-button active" onclick="showTab('overview')">üìä Overview</button>
                <button class="tab-button" onclick="showTab('crm')">üë• CRM System</button>
                <button class="tab-button" onclick="showTab('campaigns')">üìß Email Campaigns</button>
                <button class="tab-button" onclick="showTab('automation')">ü§ñ Automation</button>
                <button class="tab-button" onclick="showTab('email-templates')">üìù Templates</button>
                <button class="tab-button" onclick="showTab('social')">üì± Social Media</button>
                <button class="tab-button" onclick="showTab('analytics')">üìà Analytics</button>
                <button class="tab-button" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
            </div>
            
            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">üë•</div>
                            <div class="card-title">Client Management</div>
                        </div>
                        <div class="card-description">
                            Manage your client relationships, track interactions, and monitor pipeline progress.
                        </div>
                        <div class="card-actions">
                            <a href="#" class="card-btn" onclick="showTab('crm')">Open CRM</a>
                            <a href="#" class="card-btn secondary">Add New Client</a>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">üì±</div>
                            <div class="card-title">Social Media Automation</div>
                        </div>
                        <div class="card-description">
                            Automate your social media posting, content generation, and engagement across all platforms.
                        </div>
                        <div class="card-actions">
                            <a href="social-media-automation-dashboard.html" class="card-btn">Open Dashboard</a>
                            <a href="tnr-social-media-setup.html" class="card-btn secondary">Connect Platforms</a>
                            <a href="social-media-content-templates.html" class="card-btn secondary">Content Templates</a>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">üìç</div>
                            <div class="card-title">GMB Automation</div>
                        </div>
                        <div class="card-description">
                            Automate Google My Business posts, reviews, and reporting for better local visibility.
                        </div>
                        <div class="card-actions">
                            <a href="gmb-post-generator.html" class="card-btn">Post Generator</a>
                            <a href="review-request-system.html" class="card-btn secondary">Review System</a>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">üìß</div>
                            <div class="card-title">Email Marketing</div>
                        </div>
                        <div class="card-description">
                            Create and send automated email campaigns, newsletters, and follow-up sequences.
                        </div>
                        <div class="card-actions">
                            <a href="#" class="card-btn" onclick="createEmailCampaign()">Create Campaign</a>
                            <a href="#" class="card-btn secondary">View Templates</a>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">üìä</div>
                            <div class="card-title">Analytics & Reports</div>
                        </div>
                        <div class="card-description">
                            Track performance metrics, generate reports, and monitor ROI across all channels.
                        </div>
                        <div class="card-actions">
                            <a href="#" class="card-btn" onclick="showTab('analytics')">View Analytics</a>
                            <a href="#" class="card-btn secondary">Generate Report</a>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">üîå</div>
                            <div class="card-title">API Management</div>
                        </div>
                        <div class="card-description">
                            Configure and manage API integrations for seamless automation across platforms.
                        </div>
                        <div class="card-actions">
                            <a href="real-automation-setup.html" class="card-btn">API Setup</a>
                            <a href="#" class="card-btn secondary">System Status</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CRM Tab -->
            <div id="crm" class="tab-content">
                <div class="crm-section">
                    <div class="crm-header">
                        <h2 class="crm-title">üë• Client Relationship Management</h2>
                        <div>
                            <button class="btn" onclick="showAddClientModal()">+ Add New Client</button>
                        </div>
                    </div>
                    
                    <div class="crm-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="totalClients">0</div>
                            <div class="stat-label">Total Clients</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="activeClients">0</div>
                            <div class="stat-label">Active Clients</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="newLeads">0</div>
                            <div class="stat-label">New Leads</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalOrders">0</div>
                            <div class="stat-label">Total Orders</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalRevenue">$0</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                    </div>
                    
                    <div class="crm-tabs">
                        <button class="crm-tab active" onclick="showCrmTab('clients')">All Clients</button>
                        <button class="crm-tab" onclick="showCrmTab('leads')">Leads</button>
                        <button class="crm-tab" onclick="showCrmTab('orders')">Orders</button>
                    </div>
                    
                    <div id="clients" class="crm-content active">
                        <div style="margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 8px; align-items: flex-end;">
                            <div>
                                <label style="display:block;color:#fff;font-size:12px;">Search</label>
                                <input id="clientsFilterQ" type="text" placeholder="Name, email, phone..." />
                            </div>
                            <div>
                                <label style="display:block;color:#fff;font-size:12px;">Status</label>
                                <select id="clientsFilterStatus">
                                    <option value="">All</option>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                    <option value="Prospect">Prospect</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block;color:#fff;font-size:12px;">Business Type</label>
                                <input id="clientsFilterBusinessType" type="text" placeholder="e.g., Roofing" />
                            </div>
                            <div>
                                <label style="display:block;color:#fff;font-size:12px;">Source</label>
                                <input id="clientsFilterSource" type="text" placeholder="e.g., Website" />
                            </div>
                            <div>
                                <label style="display:block;color:#fff;font-size:12px;">Sort</label>
                                <select id="clientsSort">
                                    <option value="createdAt">Created</option>
                                    <option value="name">Name</option>
                                    <option value="status">Status</option>
                                </select>
                                <select id="clientsOrder">
                                    <option value="desc">Desc</option>
                                    <option value="asc">Asc</option>
                                </select>
                            </div>
                            <button class="btn" onclick="loadClients()">Apply</button>
                        </div>
                        <div class="client-list" id="clientsList">
                            <!-- Clients will be loaded dynamically -->
                        </div>
                    </div>
                    
                    <div id="leads" class="crm-content">
                        <div style="margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 8px; align-items: flex-end;">
                            <div>
                                <label style="display:block;color:#fff;font-size:12px;">Search</label>
                                <input id="leadsFilterQ" type="text" placeholder="Name, email, phone..." />
                            </div>
                            <div>
                                <label style="display:block;color:#fff;font-size:12px;">Status</label>
                                <select id="leadsFilterStatus">
                                    <option value="">All</option>
                                    <option value="New">New</option>
                                    <option value="Contacted">Contacted</option>
                                    <option value="Qualified">Qualified</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block;color:#fff;font-size:12px;">Business Type</label>
                                <input id="leadsFilterBusinessType" type="text" placeholder="e.g., Roofing" />
                            </div>
                            <div>
                                <label style="display:block;color:#fff;font-size:12px;">Source</label>
                                <input id="leadsFilterSource" type="text" placeholder="e.g., Website" />
                            </div>
                            <div>
                                <label style="display:block;color:#fff;font-size:12px;">Interest</label>
                                <input id="leadsFilterInterest" type="text" placeholder="e.g., SEO" />
                            </div>
                            <div>
                                <label style="display:block;color:#fff;font-size:12px;">Sort</label>
                                <select id="leadsSort">
                                    <option value="createdAt">Created</option>
                                    <option value="name">Name</option>
                                    <option value="status">Status</option>
                                </select>
                                <select id="leadsOrder">
                                    <option value="desc">Desc</option>
                                    <option value="asc">Asc</option>
                                </select>
                            </div>
                            <div style="margin-left:auto; display:flex; gap:8px;">
                                <input type="file" id="leadsCsvFile" accept=".csv" style="display:none" />
                                <button class="btn" onclick="document.getElementById('leadsCsvFile').click()">Import Leads (CSV)</button>
                                <button class="btn" onclick="loadLeads()">Apply</button>
                            </div>
                        </div>
                        <div class="client-list" id="leadsList">
                            <!-- Leads will be loaded dynamically -->
                        </div>
                    </div>
                    
                    <div id="orders" class="crm-content">
                        <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="color: var(--tnr-gold); margin: 0;">Order Management</h3>
                            <button class="btn" onclick="showAddOrderModal()">+ Add New Order</button>
                        </div>
                        <div class="client-list" id="ordersList">
                            <!-- Orders will be loaded dynamically -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Email Campaigns Tab -->
            <div id="campaigns" class="tab-content">
                <div class="crm-section">
                    <h2 class="crm-title">üìß Email Marketing Campaigns</h2>
                    
                    <div style="background: white; padding: 2rem; border-radius: 8px; margin-bottom: 2rem;">
                        <h3 style="color: var(--tnr-navy); margin-bottom: 1.5rem;">Create New Campaign</h3>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; color: black; margin-bottom: 0.5rem; font-weight: 600;">Campaign Subject</label>
                            <input type="text" id="campaignSubject" placeholder="Enter email subject (use {{name}} or {{company}} for personalization)" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; color: black;" />
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; color: black; margin-bottom: 0.5rem; font-weight: 600;">Email Content (HTML)</label>
                            <textarea id="campaignHtml" rows="12" placeholder="Enter HTML email content. Use {{name}}, {{email}}, {{company}} for personalization." style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; color: black; font-family: monospace;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; color: black; margin-bottom: 0.5rem; font-weight: 600;">Plain Text (Optional)</label>
                            <textarea id="campaignText" rows="6" placeholder="Plain text version (auto-generated from HTML if blank)" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; color: black;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f5f5f5; border-radius: 4px;">
                            <label style="display: block; color: black; margin-bottom: 0.75rem; font-weight: 600;">Select Audience</label>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; color: black; margin-bottom: 0.5rem;">Audience Type</label>
                                <select id="campaignAudienceType" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; color: black;">
                                    <option value="leads">Leads</option>
                                    <option value="clients">Clients</option>
                                </select>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <label style="display: block; color: black; margin-bottom: 0.5rem; font-size: 0.9rem;">Search</label>
                                    <input type="text" id="campaignFilterQ" placeholder="Name, email..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; color: black;" />
                                </div>
                                <div>
                                    <label style="display: block; color: black; margin-bottom: 0.5rem; font-size: 0.9rem;">Status</label>
                                    <input type="text" id="campaignFilterStatus" placeholder="e.g., New, Active" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; color: black;" />
                                </div>
                                <div>
                                    <label style="display: block; color: black; margin-bottom: 0.5rem; font-size: 0.9rem;">Business Type</label>
                                    <input type="text" id="campaignFilterBusinessType" placeholder="e.g., Roofing" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; color: black;" />
                                </div>
                                <div>
                                    <label style="display: block; color: black; margin-bottom: 0.5rem; font-size: 0.9rem;">Source</label>
                                    <input type="text" id="campaignFilterSource" placeholder="e.g., Website" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; color: black;" />
                                </div>
                                <div id="campaignFilterInterestContainer">
                                    <label style="display: block; color: black; margin-bottom: 0.5rem; font-size: 0.9rem;">Interest</label>
                                    <input type="text" id="campaignFilterInterest" placeholder="e.g., SEO" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; color: black;" />
                                </div>
                            </div>
                            
                            <button class="btn" onclick="previewCampaignAudience()" style="margin-bottom: 1rem;">Preview Audience Count</button>
                            <div id="campaignAudienceCount" style="padding: 0.75rem; background: white; border-radius: 4px; color: black; display: none;">
                                <strong>Audience Size: </strong><span id="campaignAudienceCountValue">0</span> recipients
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button class="btn" onclick="sendCampaign()" style="background: var(--tnr-gold); color: var(--tnr-navy); font-weight: 600;">üöÄ Send Campaign</button>
                            <button class="btn" onclick="clearCampaignForm()" style="background: #666;">Clear Form</button>
                        </div>
                        
                        <div id="campaignResult" style="margin-top: 1.5rem; padding: 1rem; border-radius: 4px; display: none;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Automation Tab -->
            <div id="automation" class="tab-content">
                <div class="crm-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 class="crm-title">ü§ñ Business Automation Workflows</h2>
                        <button class="btn" onclick="showCreateWorkflowModal()" style="background: var(--tnr-gold); color: var(--tnr-navy); font-weight: 600;">+ Create Workflow</button>
                    </div>
                    
                    <div style="background: white; padding: 2rem; border-radius: 8px; margin-bottom: 2rem;">
                        <h3 style="color: var(--tnr-navy); margin-bottom: 1rem;">Active Workflows</h3>
                        <div id="workflowsList">
                            <div style="text-align: center; padding: 2rem; color: #666;">Loading workflows...</div>
                        </div>
                    </div>
                    
                    <div class="automation-workflow">
                        <h3 style="color: var(--tnr-gold); margin-bottom: 1rem;">üìö Available Trigger Types</h3>
                        <div class="workflow-step">
                            <div class="step-number">üÜï</div>
                            <div class="step-content">
                                <h4>New Lead Created</h4>
                                <p>Trigger when a new lead is added to the CRM</p>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="step-number">üìß</div>
                            <div class="step-content">
                                <h4>Lead Status Changed</h4>
                                <p>Trigger when a lead's status is updated (e.g., New ‚Üí Contacted)</p>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="step-number">üë§</div>
                            <div class="step-content">
                                <h4>Client Status Changed</h4>
                                <p>Trigger when a client's status changes (e.g., Prospect ‚Üí Active)</p>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="step-number">üìÖ</div>
                            <div class="step-content">
                                <h4>Date-Based Trigger</h4>
                                <p>Trigger on specific dates or after a certain time period</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="automation-workflow" style="margin-top: 2rem;">
                        <h3 style="color: var(--tnr-gold); margin-bottom: 1rem;">‚ö° Available Actions</h3>
                        <div class="workflow-step">
                            <div class="step-number">üìß</div>
                            <div class="step-content">
                                <h4>Send Email</h4>
                                <p>Send automated email to lead/client using templates</p>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="step-number">üîÑ</div>
                            <div class="step-content">
                                <h4>Update Status</h4>
                                <p>Automatically update lead/client status</p>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="step-number">üè∑Ô∏è</div>
                            <div class="step-content">
                                <h4>Assign Tag/Category</h4>
                                <p>Add tags or categories to leads/clients</p>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="step-number">üìù</div>
                            <div class="step-content">
                                <h4>Add Note</h4>
                                <p>Automatically add notes to lead/client record</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Create/Edit Workflow Modal -->
            <div id="workflowModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
                <div style="background: white; margin: 2rem auto; max-width: 800px; border-radius: 8px; padding: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: var(--tnr-navy); margin: 0;">Create Workflow</h2>
                        <button onclick="closeWorkflowModal()" style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">‚úï Close</button>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Workflow Name</label>
                        <input type="text" id="workflowName" placeholder="e.g., Welcome New Leads" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;" />
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Trigger Type</label>
                        <select id="workflowTriggerType" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;" onchange="updateTriggerFields()">
                            <option value="">Select Trigger...</option>
                            <option value="new_lead">New Lead Created</option>
                            <option value="lead_status_change">Lead Status Changed</option>
                            <option value="client_status_change">Client Status Changed</option>
                            <option value="date_based">Date-Based Trigger</option>
                        </select>
                    </div>
                    
                    <div id="triggerFields" style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 4px; display: none;">
                        <!-- Trigger-specific fields will be added here -->
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Actions</label>
                        <div id="workflowActions" style="margin-bottom: 1rem;">
                            <!-- Actions will be added here -->
                        </div>
                        <button type="button" onclick="addWorkflowAction()" class="btn" style="background: #28a745; color: white;">+ Add Action</button>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="closeWorkflowModal()" class="btn" style="background: #666;">Cancel</button>
                        <button onclick="saveWorkflow()" class="btn" style="background: var(--tnr-gold); color: var(--tnr-navy); font-weight: 600;">üíæ Save Workflow</button>
                    </div>
                </div>
            </div>
            
            <!-- Email Templates Tab -->
            <div id="email-templates" class="tab-content">
                <div class="crm-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 class="crm-title">üìß Email Templates</h2>
                        <button class="btn" onclick="showCreateTemplateModal()" style="background: var(--tnr-gold); color: var(--tnr-navy); font-weight: 600;">+ Create Template</button>
                    </div>
                    
                    <div style="background: white; padding: 2rem; border-radius: 8px;">
                        <div id="templatesList">
                            <div style="text-align: center; padding: 2rem; color: #666;">Loading templates...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Social Media Tab -->
            <div id="social" class="tab-content">
                <!-- Social Media Token Management -->
                <div class="crm-section" style="margin-bottom: 2rem;">
                    <h2 class="crm-title">üîê Social Media Authentication</h2>
                    <div style="background: white; padding: 2rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                            <h3 style="color: var(--tnr-navy); margin: 0;">Connected Accounts</h3>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn" onclick="loadSocialTokens()" style="margin-right: 0.5rem;">üîÑ Refresh</button>
                                <a href="/api/auth/meta" class="btn" style="background: #1877f2; color: white; text-decoration: none;">üìò Connect Facebook/Instagram</a>
                                <a href="/api/auth/linkedin" class="btn" style="background: #0077b5; color: white; text-decoration: none;">üíº Connect LinkedIn</a>
                                <a href="/api/auth/twitter" class="btn" style="background: #1DA1F2; color: white; text-decoration: none;">üê¶ Connect X (Twitter)</a>
                            </div>
                        </div>
                        <div id="tokensList" style="min-height: 200px;">
                            <div style="text-align: center; padding: 3rem; color: #666;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">‚è≥</div>
                                <p>Loading tokens...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">üì±</div>
                            <div class="card-title">Social Media Dashboard</div>
                        </div>
                        <div class="card-description">
                            Manage all your social media accounts from one central location.
                        </div>
                        <div class="card-actions">
                            <a href="social-media-automation-dashboard.html" class="card-btn">Open Dashboard</a>
                            <a href="#" class="card-btn secondary" onclick="connectSocialAccounts()">Connect Accounts</a>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">üìù</div>
                            <div class="card-title">Content Templates</div>
                        </div>
                        <div class="card-description">
                            Access 500+ professional templates for every industry and platform.
                        </div>
                        <div class="card-actions">
                            <a href="social-media-content-templates.html" class="card-btn">Browse Templates</a>
                            <a href="#" class="card-btn secondary">Create Custom</a>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">üìÖ</div>
                            <div class="card-title">Post Scheduler</div>
                        </div>
                        <div class="card-description">
                            Schedule posts across all platforms with optimal timing.
                        </div>
                        <div class="card-actions">
                            <a href="#" class="card-btn" onclick="openScheduler()">Schedule Posts</a>
                            <a href="#" class="card-btn secondary">View Calendar</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content">
                <div class="crm-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 class="crm-title">üìà Performance Analytics</h2>
                        <button class="btn" onclick="loadAnalytics()" style="background: var(--tnr-gold); color: var(--tnr-navy);">üîÑ Refresh</button>
                    </div>
                    
                    <div id="analyticsContent">
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                            <p>Loading analytics...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="crm-section">
                    <h2 class="crm-title">‚öôÔ∏è System Settings</h2>
                    
                    <div class="form-group">
                        <label for="businessName">Business Name</label>
                        <input type="text" id="businessName" value="TNR Business Solutions" placeholder="Enter business name">
                    </div>
                    
                    <div class="form-group">
                        <label for="businessEmail">Business Email</label>
                        <input type="email" id="businessEmail" value="roy.turner@tnrbusinesssolutions.com" placeholder="Enter business email">
                    </div>
                    
                    <div class="form-group">
                        <label for="businessPhone">Business Phone</label>
                        <input type="tel" id="businessPhone" value="(412) 499-2987" placeholder="Enter business phone">
                    </div>
                    
                    <div class="form-group">
                        <label for="businessAddress">Business Address</label>
                        <textarea id="businessAddress" placeholder="Enter business address">418 Concord Avenue, Greensburg, PA 15601</textarea>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn" onclick="saveSettings()">Save Settings</button>
                        <button class="btn btn-secondary" onclick="resetSettings()">Reset</button>
                    </div>
                </div>
            </div>
            
            <!-- Live Demo Section -->
            <div class="live-demo">
                <h3>üöÄ Live Demo: TNR Business Solutions Automation</h3>
                <p>See how our automation tools work in real-time with TNR Business Solutions' own social media and marketing</p>
                <button class="demo-btn" onclick="startLiveDemo()">Start Live Demo</button>
                <button class="demo-btn" onclick="showAutomationGuide()">View Guide</button>
            </div>
            
            <!-- Footer -->
            <div id="footer-placeholder" style="margin-top: 2rem;"></div>
        </div>
    </div>

    <script src="admin-api-client.js"></script>
    <script src="crm-data.js"></script>
    <script>
        // Tab switching functionality
        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all buttons
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'social' && !tokensLoaded) {
                loadSocialTokens();
                tokensLoaded = true;
            }
            if (tabName === 'automation') {
                loadWorkflows();
            }
            if (tabName === 'analytics') {
                loadAnalytics();
            }
        }
        
        function showCrmTab(tabName) {
            // Hide all CRM tabs
            const tabs = document.querySelectorAll('.crm-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all CRM buttons
            const buttons = document.querySelectorAll('.crm-tab');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }
        
        // CRM Functions
        function addNewClient() {
            const clientName = prompt('Enter client name:');
            if (clientName) {
                alert(`New client "${clientName}" added successfully!`);
                // In a real application, this would add to the database
                updateClientStats();
            }
        }
        
        function updateClientStats() {
            // Update stats with real CRM data
            const stats = window.tnrCRM.getStats();
            document.getElementById('totalClients').textContent = stats.totalClients;
            document.getElementById('newLeads').textContent = stats.newLeads;
            document.getElementById('activeClients').textContent = stats.activeClients;
            document.getElementById('totalOrders').textContent = stats.totalOrders;
            document.getElementById('totalRevenue').textContent = '$' + stats.totalRevenue.toLocaleString();
        }
        
        // Automation Functions
        async function previewCampaignAudience() {
            const audienceType = document.getElementById('campaignAudienceType').value;
            const params = new URLSearchParams();
            params.set('type', audienceType);
            
            const q = document.getElementById('campaignFilterQ').value.trim();
            const status = document.getElementById('campaignFilterStatus').value.trim();
            const businessType = document.getElementById('campaignFilterBusinessType').value.trim();
            const source = document.getElementById('campaignFilterSource').value.trim();
            const interest = document.getElementById('campaignFilterInterest').value.trim();
            
            if (q) params.set('q', q);
            if (status) params.set('status', status);
            if (businessType) params.set('businessType', businessType);
            if (source) params.set('source', source);
            if (interest) params.set('interest', interest);
            
            try {
                const res = await fetch('/api/campaigns/audience?' + params.toString());
                const data = await res.json();
                if (data.success) {
                    document.getElementById('campaignAudienceCount').style.display = 'block';
                    document.getElementById('campaignAudienceCountValue').textContent = data.count || 0;
                } else {
                    alert('Error: ' + (data.error || 'Failed to get audience count'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
        
        async function sendCampaign() {
            const subject = document.getElementById('campaignSubject').value.trim();
            const htmlContent = document.getElementById('campaignHtml').value.trim();
            const textContent = document.getElementById('campaignText').value.trim();
            const audienceType = document.getElementById('campaignAudienceType').value;
            
            if (!subject || !htmlContent) {
                alert('Please fill in subject and HTML content');
                return;
            }
            
            const audienceFilters = {};
            const q = document.getElementById('campaignFilterQ').value.trim();
            const status = document.getElementById('campaignFilterStatus').value.trim();
            const businessType = document.getElementById('campaignFilterBusinessType').value.trim();
            const source = document.getElementById('campaignFilterSource').value.trim();
            const interest = document.getElementById('campaignFilterInterest').value.trim();
            
            if (q) audienceFilters.q = q;
            if (status) audienceFilters.status = status;
            if (businessType) audienceFilters.businessType = businessType;
            if (source) audienceFilters.source = source;
            if (interest) audienceFilters.interest = interest;
            
            if (!confirm(`Are you sure you want to send this campaign? This will send emails using your SMTP provider.`)) {
                return;
            }
            
            const resultDiv = document.getElementById('campaignResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="padding: 1rem; background: #f0f0f0; border-radius: 4px; color: black;">Sending campaign... Please wait.</div>';
            
            try {
                const res = await fetch('/api/campaigns/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subject,
                        htmlContent,
                        textContent: textContent || null,
                        audienceFilters: Object.keys(audienceFilters).length > 0 ? audienceFilters : null,
                        audienceType,
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    resultDiv.innerHTML = `<div style="padding: 1rem; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;">
                        <strong>‚úÖ Campaign Sent Successfully!</strong><br>
                        Sent: ${data.sent || 0} emails<br>
                        Failed: ${data.failed || 0} emails<br>
                        Total: ${data.total || 0} recipients
                        ${data.errors && data.errors.length > 0 ? '<br><small>Errors: ' + data.errors.length + ' (check console for details)</small>' : ''}
                    </div>`;
                } else {
                    resultDiv.innerHTML = `<div style="padding: 1rem; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">
                        <strong>‚ùå Campaign Failed:</strong> ${data.error || 'Unknown error'}
                    </div>`;
                }
            } catch (e) {
                resultDiv.innerHTML = `<div style="padding: 1rem; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">
                    <strong>‚ùå Error:</strong> ${e.message}
                </div>`;
            }
        }
        
        function clearCampaignForm() {
            document.getElementById('campaignSubject').value = '';
            document.getElementById('campaignHtml').value = '';
            document.getElementById('campaignText').value = '';
            document.getElementById('campaignFilterQ').value = '';
            document.getElementById('campaignFilterStatus').value = '';
            document.getElementById('campaignFilterBusinessType').value = '';
            document.getElementById('campaignFilterSource').value = '';
            document.getElementById('campaignFilterInterest').value = '';
            document.getElementById('campaignAudienceCount').style.display = 'none';
            document.getElementById('campaignResult').style.display = 'none';
        }
        
        function createEmailCampaign() {
            showTab('campaigns');
        }
        
        function connectSocialAccounts() {
            alert('Social account connection wizard will open. Connect your Facebook, Instagram, LinkedIn, and Twitter accounts for seamless automation.');
        }
        
        function openScheduler() {
            alert('Post scheduler will open. Schedule your content across all platforms with optimal timing for maximum engagement.');
        }
        
        // Settings Functions
        function saveSettings() {
            alert('Settings saved successfully! All changes have been applied to your automation workflows.');
        }
        
        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to default?')) {
                alert('Settings have been reset to default values.');
            }
        }
        
        // Live Demo Functions
        function startLiveDemo() {
            alert('Starting live demo... This will show you how to:\n\n1. Generate content using our templates\n2. Schedule posts across platforms\n3. Track performance and engagement\n4. Automate follow-ups and responses\n\nRedirecting to live demo...');
            window.open('social-media-automation-dashboard.html', '_blank');
        }
        
        function showAutomationGuide() {
            alert('Automation Guide:\n\n1. Set up your social media accounts\n2. Choose your industry templates\n3. Customize content with your business details\n4. Schedule posts for optimal times\n5. Monitor performance and adjust strategy\n\nThis system will help you automate 80% of your social media marketing!');
        }
        
        // Load header/footer includes
        function loadHeader() {
            fetch('includes/header.html')
                .then(r => r.text())
                .then(html => { document.getElementById('header-placeholder').innerHTML = html; });
        }

        function loadFooter() {
            fetch('includes/footer.html')
                .then(r => r.text())
                .then(html => { document.getElementById('footer-placeholder').innerHTML = html; });
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Admin dashboard loaded successfully
            
            // Simulate real-time updates
            // Initialize CRM data and display
            loadHeader();
            loadFooter();
            initializeCRM();
        });
        // CRM sub-tab switching
        function showCrmTab(tabName) {
            const sections = document.querySelectorAll('.crm-content');
            sections.forEach(sec => sec.classList.remove('active'));
            const target = document.getElementById(tabName);
            if (target) {
                target.classList.add('active');
                console.log('‚úÖ Switched to tab:', tabName);
            }
            
            // Update tab buttons
            document.querySelectorAll('.crm-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event?.target?.classList.add('active');
            
            if (tabName === 'clients') {
                console.log('üìã Loading clients...');
                loadClients();
            } else if (tabName === 'leads') {
                loadLeads();
            } else if (tabName === 'orders') {
                loadOrders();
            }
        }

        // CRM Functions
        function initializeCRM() {
            console.log('üìä Initializing CRM...');
            
            // Ensure clients section is visible and active
            const clientsSection = document.getElementById('clients');
            if (clientsSection) {
                clientsSection.classList.add('active');
                console.log('‚úÖ Clients section marked as active');
            }
            
            // Ensure CRM is available
            if (!window.tnrCRM) {
                // CRM not available, initializing...
                window.tnrCRM = new TNRCRMData();
            }
            
            // Load data from storage
            window.tnrCRM.loadFromStorage();
            
            // CRM data loaded successfully
            
            // Don't automatically mark leads as viewed - let admin decide
            // window.tnrCRM.markLeadsAsViewed();
            
            // Update statistics
            updateClientStats();
            
            // Load all CRM sections
            console.log('üìã Loading clients in initializeCRM...');
            loadClients();
            loadLeads();
            loadOrders();
            
            // Set up periodic refresh every 5 seconds to catch new leads
            setInterval(function() {
                updateClientStats();
                loadLeads(); // Refresh leads display
            }, 5000);
        }

        async function loadClients() {
            const clientsList = document.getElementById('clientsList');
            clientsList.innerHTML = '<div class="no-data">Loading clients...</div>';

            const params = new URLSearchParams();
            const q = (document.getElementById('clientsFilterQ')?.value || '').trim();
            const status = document.getElementById('clientsFilterStatus')?.value || '';
            const businessType = (document.getElementById('clientsFilterBusinessType')?.value || '').trim();
            const source = (document.getElementById('clientsFilterSource')?.value || '').trim();
            const sort = document.getElementById('clientsSort')?.value || 'createdAt';
            const order = document.getElementById('clientsOrder')?.value || 'desc';
            if (q) params.set('q', q);
            if (status) params.set('status', status);
            if (businessType) params.set('businessType', businessType);
            if (source) params.set('source', source);
            params.set('sort', sort);
            params.set('order', order);

            let clients = [];
            try {
                const res = await fetch('/api/crm/clients?' + params.toString());
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                if (data.success) {
                    clients = data.data || [];
                    console.log('‚úÖ Loaded', clients.length, 'clients');
                } else {
                    console.error('‚ùå API error:', data.error);
                    clientsList.innerHTML = `<div class="no-data">Error loading clients: ${data.error || 'Unknown error'}</div>`;
                    return;
                }
            } catch (e) {
                console.error('‚ùå Error loading clients:', e);
                clientsList.innerHTML = `<div class="no-data">Error loading clients: ${e.message}</div>`;
                return;
            }

            if (!clients || clients.length === 0) {
                clientsList.innerHTML = '<div class="no-data">No clients found. Add your first client to get started!</div>';
                return;
            }

            console.log('üìã Rendering', clients.length, 'clients');
            try {
                clientsList.innerHTML = clients.map((client, index) => {
                    console.log(`   Client ${index + 1}:`, client.name, client.id);
                    // Parse services - handle both JSON string and array
                    let services = [];
                    try {
                        if (typeof client.services === 'string') {
                            // Try to parse as JSON first
                            if (client.services.trim().startsWith('[') || client.services.trim().startsWith('{')) {
                                services = JSON.parse(client.services || '[]');
                            } else {
                                // If not JSON, treat as comma-separated string
                                services = client.services.split(',').map(s => s.trim()).filter(s => s);
                            }
                        } else if (Array.isArray(client.services)) {
                            services = client.services;
                        } else {
                            services = [];
                        }
                    } catch (e) {
                        // If parsing fails, try as comma-separated string
                        services = client.services ? String(client.services).split(',').map(s => s.trim()).filter(s => s) : [];
                    }
                    
                    const servicesDisplay = services.length > 0 ? services.join(', ') : 'No services listed';
                    const clientName = (client.name || 'Unknown').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const clientId = (client.id || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    
                    return `
                    <div class="client-item">
                        <div class="client-info">
                            <h4>${client.name || 'Unknown'}</h4>
                            <p>${client.industry || ''} | ${client.email ? `<a href="mailto:${client.email}">${client.email}</a>` : 'No email'} | ${client.phone ? `<a href="tel:${client.phone}">${client.phone}</a>` : 'No phone'}</p>
                            <p>Last Contact: ${formatDate(client.lastContact || client.lastcontact || '')} | Source: ${client.source || 'Unknown'}</p>
                            <p>Services: ${servicesDisplay}</p>
                            ${client.notes ? `<p style="color: #666; font-size: 0.9em;">Notes: ${client.notes}</p>` : ''}
                        </div>
                        <div class="client-actions">
                            <div class="client-status status-${(client.status||'Active').toLowerCase()}">${client.status || 'Active'}</div>
                            <button class="btn-small" onclick="showActivityTimeline('client', '${clientId}', '${clientName}')">üìã Timeline</button>
                            <button class="btn-small" onclick="editClient('${clientId}')">Edit</button>
                            <button class="btn-small btn-danger" onclick="deleteClient('${clientId}')">Delete</button>
                        </div>
                    </div>
                    `;
                }).join('');
                console.log('‚úÖ Clients HTML rendered successfully');
                // Force a reflow to ensure display
                clientsList.offsetHeight;
            } catch (error) {
                console.error('‚ùå Error rendering clients:', error);
                console.error('   Stack:', error.stack);
                clientsList.innerHTML = `<div class="no-data" style="color: red; padding: 2rem;">Error displaying clients: ${error.message}<br><small>Check browser console for details</small></div>`;
            }
        }
        
        // Force load clients on page load if CRM tab is active
        window.addEventListener('load', function() {
            console.log('üîÑ Page loaded, checking CRM tab...');
            setTimeout(() => {
                const crmTab = document.getElementById('crm');
                const clientsSection = document.getElementById('clients');
                if (crmTab && crmTab.classList.contains('active')) {
                    console.log('‚úÖ CRM tab is active, loading clients...');
                    loadClients();
                } else if (clientsSection && clientsSection.classList.contains('active')) {
                    console.log('‚úÖ Clients section is active, loading clients...');
                    loadClients();
                }
            }, 500);
        });

        async function loadLeads() {
            const leadsList = document.getElementById('leadsList');
            leadsList.innerHTML = '<div class="no-data">Loading leads...</div>';

            const params = new URLSearchParams();
            const q = (document.getElementById('leadsFilterQ')?.value || '').trim();
            const status = document.getElementById('leadsFilterStatus')?.value || '';
            const businessType = (document.getElementById('leadsFilterBusinessType')?.value || '').trim();
            const source = (document.getElementById('leadsFilterSource')?.value || '').trim();
            const interest = (document.getElementById('leadsFilterInterest')?.value || '').trim();
            const sort = document.getElementById('leadsSort')?.value || 'createdAt';
            const order = document.getElementById('leadsOrder')?.value || 'desc';
            if (q) params.set('q', q);
            if (status) params.set('status', status);
            if (businessType) params.set('businessType', businessType);
            if (source) params.set('source', source);
            if (interest) params.set('interest', interest);
            params.set('sort', sort);
            params.set('order', order);

            let leads = [];
            try {
                const res = await fetch('/api/crm/leads?' + params.toString());
                const data = await res.json();
                if (data.success) leads = data.data || [];
            } catch (e) {}

            if (!leads || leads.length === 0) {
                leadsList.innerHTML = '<div class="no-data">No leads found. Form submissions will appear here.</div>';
                return;
            }

            leadsList.innerHTML = leads.map(lead => {
                // Create comprehensive detailed information display (same as email template)
                const details = [];
                
                // Basic info
                if (lead.company) details.push(`<strong>Company:</strong> ${lead.company}`);
                if (lead.industry) details.push(`<strong>Industry:</strong> ${lead.industry}`);
                if (lead.website) details.push(`<strong>Website:</strong> ${lead.website}`);
                if (lead.budget) details.push(`<strong>Budget:</strong> ${lead.budget}`);
                if (lead.timeline) details.push(`<strong>Timeline:</strong> ${lead.timeline}`);
                if (lead.contactMethod) details.push(`<strong>Contact Method:</strong> ${lead.contactMethod}`);
                
                // Personal details
                if (lead.dateOfBirth) details.push(`<strong>Date of Birth:</strong> ${lead.dateOfBirth}`);
                if (lead.maritalStatus) details.push(`<strong>Marital Status:</strong> ${lead.maritalStatus}`);
                if (lead.gender) details.push(`<strong>Gender:</strong> ${lead.gender}`);
                if (lead.address) details.push(`<strong>Address:</strong> ${lead.address}`);
                if (lead.apartment) details.push(`<strong>Apartment/Unit:</strong> ${lead.apartment}`);
                if (lead.city) details.push(`<strong>City:</strong> ${lead.city}`);
                if (lead.state) details.push(`<strong>State:</strong> ${lead.state}`);
                if (lead.zipCode) details.push(`<strong>Zip Code:</strong> ${lead.zipCode}`);
                
                // License details
                if (lead.licenseNumber) details.push(`<strong>License Number:</strong> ${lead.licenseNumber}`);
                if (lead.licenseState) details.push(`<strong>License State:</strong> ${lead.licenseState}`);
                
                // Vehicle details
                if (lead.vehicleYear) details.push(`<strong>Vehicle Year:</strong> ${lead.vehicleYear}`);
                if (lead.vehicleMake) details.push(`<strong>Vehicle Make:</strong> ${lead.vehicleMake}`);
                if (lead.vehicleModel) details.push(`<strong>Vehicle Model:</strong> ${lead.vehicleModel}`);
                if (lead.vin) details.push(`<strong>VIN:</strong> ${lead.vin}`);
                if (lead.licensePlate) details.push(`<strong>License Plate:</strong> ${lead.licensePlate}`);
                if (lead.vehicleUse) details.push(`<strong>Vehicle Use:</strong> ${lead.vehicleUse}`);
                if (lead.annualMileage) details.push(`<strong>Annual Mileage:</strong> ${lead.annualMileage}`);
                if (lead.vehicleOwnership) details.push(`<strong>Vehicle Ownership:</strong> ${lead.vehicleOwnership}`);
                if (lead.garagingAddress) details.push(`<strong>Garaging Address:</strong> ${lead.garagingAddress}`);
                
                // Driving history
                if (lead.yearsLicensed) details.push(`<strong>Years Licensed:</strong> ${lead.yearsLicensed}`);
                if (lead.accidents) details.push(`<strong>Accidents:</strong> ${lead.accidents}`);
                if (lead.trafficViolations) details.push(`<strong>Traffic Violations:</strong> ${lead.trafficViolations}`);
                if (lead.duiDwi) details.push(`<strong>DUI/DWI:</strong> ${lead.duiDwi}`);
                if (lead.licenseSuspended) details.push(`<strong>License Suspended:</strong> ${lead.licenseSuspended}`);
                if (lead.currentInsurance) details.push(`<strong>Current Insurance:</strong> ${lead.currentInsurance}`);
                
                // Property details (Home Insurance)
                if (lead.yearBuilt) details.push(`<strong>Year Built:</strong> ${lead.yearBuilt}`);
                if (lead.propertyType) details.push(`<strong>Property Type:</strong> ${lead.propertyType}`);
                if (lead.squareFootage) details.push(`<strong>Square Footage:</strong> ${lead.squareFootage}`);
                if (lead.bedrooms) details.push(`<strong>Bedrooms:</strong> ${lead.bedrooms}`);
                if (lead.bathrooms) details.push(`<strong>Bathrooms:</strong> ${lead.bathrooms}`);
                if (lead.constructionType) details.push(`<strong>Construction Type:</strong> ${lead.constructionType}`);
                if (lead.roofType) details.push(`<strong>Roof Type:</strong> ${lead.roofType}`);
                if (lead.homeValue) details.push(`<strong>Home Value:</strong> $${lead.homeValue}`);
                
                // Life Insurance details
                if (lead.coverageType) details.push(`<strong>Coverage Type:</strong> ${lead.coverageType}`);
                if (lead.coverageAmount) details.push(`<strong>Coverage Amount:</strong> $${lead.coverageAmount}`);
                if (lead.termLength) details.push(`<strong>Term Length:</strong> ${lead.termLength} years`);
                if (lead.smokingStatus) details.push(`<strong>Smoking Status:</strong> ${lead.smokingStatus}`);
                if (lead.height) details.push(`<strong>Height:</strong> ${lead.height}`);
                if (lead.weight) details.push(`<strong>Weight:</strong> ${lead.weight}`);
                
                // Health conditions
                const healthConditions = [];
                if (lead.heartDisease) healthConditions.push('Heart Disease');
                if (lead.diabetes) healthConditions.push('Diabetes');
                if (lead.cancer) healthConditions.push('Cancer');
                if (lead.highBloodPressure) healthConditions.push('High Blood Pressure');
                if (lead.depressionAnxiety) healthConditions.push('Depression/Anxiety');
                if (lead.noneOfAbove) healthConditions.push('None of the above');
                if (healthConditions.length > 0) details.push(`<strong>Health Conditions:</strong> ${healthConditions.join(', ')}`);
                
                // Business Insurance details
                if (lead.businessAddress) details.push(`<strong>Business Address:</strong> ${lead.businessAddress}`);
                if (lead.firstName) details.push(`<strong>First Name:</strong> ${lead.firstName}`);
                if (lead.lastName) details.push(`<strong>Last Name:</strong> ${lead.lastName}`);
                if (lead.contactEmail) details.push(`<strong>Contact Email:</strong> ${lead.contactEmail}`);
                if (lead.contactPhone) details.push(`<strong>Contact Phone:</strong> ${lead.contactPhone}`);
                if (lead.jobTitle) details.push(`<strong>Job Title:</strong> ${lead.jobTitle}`);
                
                // Business coverage options
                const businessCoverage = [];
                if (lead.generalLiability) businessCoverage.push('General Liability');
                if (lead.commercialProperty) businessCoverage.push('Commercial Property');
                if (lead.workersCompensation) businessCoverage.push('Workers Compensation');
                if (lead.professionalLiability) businessCoverage.push('Professional Liability');
                if (lead.cyberLiability) businessCoverage.push('Cyber Liability');
                if (lead.commercialAuto) businessCoverage.push('Commercial Auto');
                if (lead.directorsOfficers) businessCoverage.push('Directors & Officers');
                if (lead.otherCoverage) businessCoverage.push('Other');
                if (businessCoverage.length > 0) details.push(`<strong>Business Coverage Needed:</strong> ${businessCoverage.join(', ')}`);
                
                // Umbrella Insurance details
                if (lead.coverageAmount) details.push(`<strong>Desired Coverage Amount:</strong> ${lead.coverageAmount}`);
                if (lead.currentPolicies) details.push(`<strong>Current Policies:</strong> ${lead.currentPolicies}`);
                if (lead.insuranceType) details.push(`<strong>Insurance Type:</strong> ${lead.insuranceType}`);
                
                // Coverage details
                if (lead.coverageLevel) details.push(`<strong>Coverage Level:</strong> ${lead.coverageLevel}`);
                if (lead.deductible) details.push(`<strong>Deductible:</strong> $${lead.deductible}`);
                
                // Additional coverage options
                const additionalCoverage = [];
                if (lead.roadsideAssistance) additionalCoverage.push('Roadside Assistance');
                if (lead.rentalCarCoverage) additionalCoverage.push('Rental Car Coverage');
                if (lead.gapInsurance) additionalCoverage.push('Gap Insurance');
                if (lead.personalInjuryProtection) additionalCoverage.push('Personal Injury Protection');
                if (lead.uninsuredMotorist) additionalCoverage.push('Uninsured Motorist');
                if (lead.underinsuredMotorist) additionalCoverage.push('Underinsured Motorist');
                if (lead.floodInsurance) additionalCoverage.push('Flood Insurance');
                if (lead.earthquakeCoverage) additionalCoverage.push('Earthquake Coverage');
                if (lead.sewerBackupCoverage) additionalCoverage.push('Sewer Backup Coverage');
                if (lead.identityTheftProtection) additionalCoverage.push('Identity Theft Protection');
                if (additionalCoverage.length > 0) details.push(`<strong>Additional Coverage:</strong> ${additionalCoverage.join(', ')}`);
                
                // Services
                const servicesText = Array.isArray(lead.services) ? lead.services.join(', ') : lead.services || 'Not specified';
                
                return `
                <div class="client-item" style="color: black;">
                    <div class="client-info" style="color: black;">
                        <h4 style="color: black;">${lead.name}</h4>
                        <p style="color: black;"><strong>Email:</strong> ${lead.email ? `<a href=\"mailto:${lead.email}\">${lead.email}</a>` : ''} | <strong>Phone:</strong> ${lead.phone ? `<a href=\"tel:${lead.phone}\">${lead.phone}</a>` : ''}</p>
                        <p style="color: black;"><strong>Services:</strong> ${servicesText}</p>
                        <p style="color: black;"><strong>Date:</strong> ${lead.submissionDate || formatDate(lead.submissionDateTime || lead.date)} | <strong>Source:</strong> ${lead.source}</p>
                        <p style="color: black;"><strong>Message:</strong> ${lead.message || 'No message'}</p>
                        ${details.length > 0 ? `<div style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px; font-size: 0.9em; color: black;">
                            <strong style="color: black;">Complete Form Details:</strong><br>
                            <div style="color: black;">${details.join('<br>')}</div>
                        </div>` : ''}
                    </div>
                    <div class="client-actions">
                        <div class="client-status status-lead">${lead.status}</div>
                        <button class="btn-small" onclick="showActivityTimeline('lead', '${lead.id}', '${lead.name}')">üìã Timeline</button>
                        <button class="btn-small" onclick="convertLeadToClient('${lead.id}')">Convert to Client</button>
                        <button class="btn-small btn-danger" onclick="deleteLead('${lead.id}')">Delete</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        async function promptImportLeadsCSV() {
            const example = 'firstName,lastName,phone,email,businessType,businessName,businessAddress,source,interest,notes\nJohn,Doe,4125550000,john@example.com,Roofing,JD Roofing,123 Main St,Website,SEO,"Priority lead"';
            const csv = window.prompt('Paste CSV with headers:\n(firstName,lastName,phone,email,businessType,businessName,businessAddress,source,interest,notes)', example);
            if (!csv) return;
            try {
                const res = await fetch('/api/crm/import-leads', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ csv })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Imported ' + (data.createdCount || 0) + ' leads');
                    // Refresh leads from API if available; fallback to reload
                    if (window.tnrCRM && window.tnrCRM.loadFromStorage) {
                        loadLeads();
                    }
                } else {
                    alert('Import failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Import error: ' + e.message);
            }
        }

        // File input handler for CSV import with simple preview
        (function attachCsvHandler(){
            const input = document.getElementById('leadsCsvFile');
            if (!input) return;
            input.addEventListener('change', async function(){
                const file = this.files && this.files[0];
                if (!file) return;
                const text = await file.text();
                const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
                const preview = lines.slice(0, Math.min(lines.length, 6)).join('\n');
                const ok = window.confirm('Preview first rows:\n\n' + preview + '\n\nProceed to import?');
                if (!ok) { this.value=''; return; }
                try {
                    const res = await fetch('/api/crm/import-leads', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ csv: text })
                    });
                    const data = await res.json();
                    if (data.success) {
                        alert('Imported ' + (data.createdCount || 0) + ' leads');
                        loadLeads();
                    } else {
                        alert('Import failed: ' + (data.error || 'Unknown error'));
                    }
                } catch (e) {
                    alert('Import error: ' + e.message);
                } finally {
                    this.value = '';
                }
            });
        })();

        function loadOrders() {
            const ordersList = document.getElementById('ordersList');
            const orders = window.tnrCRM.orders || [];
            
            if (orders.length === 0) {
                ordersList.innerHTML = '<div class="no-data">No orders found. Click "+ Add New Order" to create your first order.</div>';
                return;
            }
            
            // Sort orders by date (newest first)
            const sortedOrders = [...orders].sort((a, b) => {
                const dateA = new Date(a.orderDate || a.date || 0);
                const dateB = new Date(b.orderDate || b.date || 0);
                return dateB - dateA;
            });
            
            ordersList.innerHTML = sortedOrders.map(order => {
                const orderDate = order.orderDate || order.date || 'Not specified';
                const description = order.description || order.specialRequests || 'No description';
                const timeline = order.projectTimeline ? `Timeline: ${order.projectTimeline}` : '';
                const paymentMethod = order.paymentMethod ? `Payment: ${order.paymentMethod}` : '';
                
                return `
                <div class="client-item">
                    <div class="client-info">
                        <h4>${order.clientName || 'Unknown Client'}</h4>
                        <p><strong>Service:</strong> ${order.service || 'Not specified'} ${order.industry ? `| Industry: ${order.industry}` : ''}</p>
                        <p><strong>Amount:</strong> $${(order.amount || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} | <strong>Status:</strong> ${order.status || 'Pending'}</p>
                        <p><strong>Order Date:</strong> ${formatDate(orderDate)}</p>
                        ${timeline ? `<p>${timeline}</p>` : ''}
                        ${paymentMethod ? `<p>${paymentMethod}</p>` : ''}
                        <p><strong>Description:</strong> ${description}</p>
                    </div>
                    <div class="client-actions">
                        <div class="client-status status-${(order.status || 'pending').toLowerCase().replace(/\s+/g, '-')}">${order.status || 'Pending'}</div>
                        <button class="btn-small" onclick="editOrder('${order.id}')">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteOrder('${order.id}')">Delete</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function loadFormSubmissions() {
            const formSubmissionsList = document.getElementById('formSubmissionsList');
            const submissions = window.tnrCRM.formSubmissions;
            
            if (submissions.length === 0) {
                formSubmissionsList.innerHTML = '<div class="no-data">No form submissions found. Website form submissions will appear here.</div>';
                return;
            }
            
            formSubmissionsList.innerHTML = submissions.map(submission => {
                // Create comprehensive detailed information display (same as email template)
                const details = [];
                
                // Basic info
                if (submission.company) details.push(`<strong>Company:</strong> ${submission.company}`);
                if (submission.industry) details.push(`<strong>Industry:</strong> ${submission.industry}`);
                if (submission.website) details.push(`<strong>Website:</strong> ${submission.website}`);
                if (submission.budget) details.push(`<strong>Budget:</strong> ${submission.budget}`);
                if (submission.timeline) details.push(`<strong>Timeline:</strong> ${submission.timeline}`);
                if (submission.contactMethod) details.push(`<strong>Contact Method:</strong> ${submission.contactMethod}`);
                
                // Personal details
                if (submission.dateOfBirth) details.push(`<strong>Date of Birth:</strong> ${submission.dateOfBirth}`);
                if (submission.maritalStatus) details.push(`<strong>Marital Status:</strong> ${submission.maritalStatus}`);
                if (submission.gender) details.push(`<strong>Gender:</strong> ${submission.gender}`);
                if (submission.address) details.push(`<strong>Address:</strong> ${submission.address}`);
                if (submission.apartment) details.push(`<strong>Apartment/Unit:</strong> ${submission.apartment}`);
                if (submission.city) details.push(`<strong>City:</strong> ${submission.city}`);
                if (submission.state) details.push(`<strong>State:</strong> ${submission.state}`);
                if (submission.zipCode) details.push(`<strong>Zip Code:</strong> ${submission.zipCode}`);
                
                // License details
                if (submission.licenseNumber) details.push(`<strong>License Number:</strong> ${submission.licenseNumber}`);
                if (submission.licenseState) details.push(`<strong>License State:</strong> ${submission.licenseState}`);
                
                // Vehicle details
                if (submission.vehicleYear) details.push(`<strong>Vehicle Year:</strong> ${submission.vehicleYear}`);
                if (submission.vehicleMake) details.push(`<strong>Vehicle Make:</strong> ${submission.vehicleMake}`);
                if (submission.vehicleModel) details.push(`<strong>Vehicle Model:</strong> ${submission.vehicleModel}`);
                if (submission.vin) details.push(`<strong>VIN:</strong> ${submission.vin}`);
                if (submission.licensePlate) details.push(`<strong>License Plate:</strong> ${submission.licensePlate}`);
                if (submission.vehicleUse) details.push(`<strong>Vehicle Use:</strong> ${submission.vehicleUse}`);
                if (submission.annualMileage) details.push(`<strong>Annual Mileage:</strong> ${submission.annualMileage}`);
                if (submission.vehicleOwnership) details.push(`<strong>Vehicle Ownership:</strong> ${submission.vehicleOwnership}`);
                if (submission.garagingAddress) details.push(`<strong>Garaging Address:</strong> ${submission.garagingAddress}`);
                
                // Driving history
                if (submission.yearsLicensed) details.push(`<strong>Years Licensed:</strong> ${submission.yearsLicensed}`);
                if (submission.accidents) details.push(`<strong>Accidents:</strong> ${submission.accidents}`);
                if (submission.trafficViolations) details.push(`<strong>Traffic Violations:</strong> ${submission.trafficViolations}`);
                if (submission.duiDwi) details.push(`<strong>DUI/DWI:</strong> ${submission.duiDwi}`);
                if (submission.licenseSuspended) details.push(`<strong>License Suspended:</strong> ${submission.licenseSuspended}`);
                if (submission.currentInsurance) details.push(`<strong>Current Insurance:</strong> ${submission.currentInsurance}`);
                
                // Property details (Home Insurance)
                if (submission.yearBuilt) details.push(`<strong>Year Built:</strong> ${submission.yearBuilt}`);
                if (submission.propertyType) details.push(`<strong>Property Type:</strong> ${submission.propertyType}`);
                if (submission.squareFootage) details.push(`<strong>Square Footage:</strong> ${submission.squareFootage}`);
                if (submission.bedrooms) details.push(`<strong>Bedrooms:</strong> ${submission.bedrooms}`);
                if (submission.bathrooms) details.push(`<strong>Bathrooms:</strong> ${submission.bathrooms}`);
                if (submission.constructionType) details.push(`<strong>Construction Type:</strong> ${submission.constructionType}`);
                if (submission.roofType) details.push(`<strong>Roof Type:</strong> ${submission.roofType}`);
                if (submission.homeValue) details.push(`<strong>Home Value:</strong> $${submission.homeValue}`);
                
                // Life Insurance details
                if (submission.coverageType) details.push(`<strong>Coverage Type:</strong> ${submission.coverageType}`);
                if (submission.coverageAmount) details.push(`<strong>Coverage Amount:</strong> $${submission.coverageAmount}`);
                if (submission.termLength) details.push(`<strong>Term Length:</strong> ${submission.termLength} years`);
                if (submission.smokingStatus) details.push(`<strong>Smoking Status:</strong> ${submission.smokingStatus}`);
                if (submission.height) details.push(`<strong>Height:</strong> ${submission.height}`);
                if (submission.weight) details.push(`<strong>Weight:</strong> ${submission.weight}`);
                
                // Health conditions
                const healthConditions = [];
                if (submission.heartDisease) healthConditions.push('Heart Disease');
                if (submission.diabetes) healthConditions.push('Diabetes');
                if (submission.cancer) healthConditions.push('Cancer');
                if (submission.highBloodPressure) healthConditions.push('High Blood Pressure');
                if (submission.depressionAnxiety) healthConditions.push('Depression/Anxiety');
                if (submission.noneOfAbove) healthConditions.push('None of the above');
                if (healthConditions.length > 0) details.push(`<strong>Health Conditions:</strong> ${healthConditions.join(', ')}`);
                
                // Business Insurance details
                if (submission.businessAddress) details.push(`<strong>Business Address:</strong> ${submission.businessAddress}`);
                if (submission.firstName) details.push(`<strong>First Name:</strong> ${submission.firstName}`);
                if (submission.lastName) details.push(`<strong>Last Name:</strong> ${submission.lastName}`);
                if (submission.contactEmail) details.push(`<strong>Contact Email:</strong> ${submission.contactEmail}`);
                if (submission.contactPhone) details.push(`<strong>Contact Phone:</strong> ${submission.contactPhone}`);
                if (submission.jobTitle) details.push(`<strong>Job Title:</strong> ${submission.jobTitle}`);
                
                // Business coverage options
                const businessCoverage = [];
                if (submission.generalLiability) businessCoverage.push('General Liability');
                if (submission.commercialProperty) businessCoverage.push('Commercial Property');
                if (submission.workersCompensation) businessCoverage.push('Workers Compensation');
                if (submission.professionalLiability) businessCoverage.push('Professional Liability');
                if (submission.cyberLiability) businessCoverage.push('Cyber Liability');
                if (submission.commercialAuto) businessCoverage.push('Commercial Auto');
                if (submission.directorsOfficers) businessCoverage.push('Directors & Officers');
                if (submission.otherCoverage) businessCoverage.push('Other');
                if (businessCoverage.length > 0) details.push(`<strong>Business Coverage Needed:</strong> ${businessCoverage.join(', ')}`);
                
                // Umbrella Insurance details
                if (submission.coverageAmount) details.push(`<strong>Desired Coverage Amount:</strong> ${submission.coverageAmount}`);
                if (submission.currentPolicies) details.push(`<strong>Current Policies:</strong> ${submission.currentPolicies}`);
                if (submission.insuranceType) details.push(`<strong>Insurance Type:</strong> ${submission.insuranceType}`);
                
                // Coverage details
                if (submission.coverageLevel) details.push(`<strong>Coverage Level:</strong> ${submission.coverageLevel}`);
                if (submission.deductible) details.push(`<strong>Deductible:</strong> $${submission.deductible}`);
                
                // Additional coverage options
                const additionalCoverage = [];
                if (submission.roadsideAssistance) additionalCoverage.push('Roadside Assistance');
                if (submission.rentalCarCoverage) additionalCoverage.push('Rental Car Coverage');
                if (submission.gapInsurance) additionalCoverage.push('Gap Insurance');
                if (submission.personalInjuryProtection) additionalCoverage.push('Personal Injury Protection');
                if (submission.uninsuredMotorist) additionalCoverage.push('Uninsured Motorist');
                if (submission.underinsuredMotorist) additionalCoverage.push('Underinsured Motorist');
                if (submission.floodInsurance) additionalCoverage.push('Flood Insurance');
                if (submission.earthquakeCoverage) additionalCoverage.push('Earthquake Coverage');
                if (submission.sewerBackupCoverage) additionalCoverage.push('Sewer Backup Coverage');
                if (submission.identityTheftProtection) additionalCoverage.push('Identity Theft Protection');
                if (additionalCoverage.length > 0) details.push(`<strong>Additional Coverage:</strong> ${additionalCoverage.join(', ')}`);
                
                // Services
                const servicesText = Array.isArray(submission.services) ? submission.services.join(', ') : submission.services || 'Not specified';
                
                return `
                <div class="client-item" style="color: black;">
                    <div class="client-info" style="color: black;">
                        <h4 style="color: black;">${submission.name}</h4>
                        <p style="color: black;">${submission.email} | ${submission.phone}</p>
                        <p style="color: black;">Date: ${formatDate(submission.date)} | Source: ${submission.source}</p>
                        <p style="color: black;">Message: ${submission.message}</p>
                        ${details.length > 0 ? `<div style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px; font-size: 0.9em; color: black;">
                            <strong style="color: black;">Complete Form Details:</strong><br>
                            <div style="color: black;">${details.join('<br>')}</div>
                        </div>` : ''}
                    </div>
                    <div class="client-actions">
                        <button class="btn-small" onclick="convertSubmissionToLead('${submission.id}')">Convert to Lead</button>
                        <button class="btn-small btn-danger" onclick="deleteSubmission('${submission.id}')">Delete</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function showAddClientModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 style="color: black;">Add New Client</h3>
                        <span class="close" onclick="closeModal()">&times;</span>
                    </div>
                    <div class="modal-body" style="color: black;">
                        <form id="addClientForm">
                            <div class="form-group">
                                <label style="color: black;">Client Name *</label>
                                <input type="text" id="clientName" required style="color: black;">
                            </div>
                            <div class="form-group">
                                <label style="color: black;">Industry *</label>
                                <select id="clientIndustry" required style="color: black;">
                                    <option value="">Select Industry</option>
                                    <option value="Construction">Construction</option>
                                    <option value="Legal Services">Legal Services</option>
                                    <option value="E-commerce">E-commerce</option>
                                    <option value="Food Service">Food Service</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Real Estate">Real Estate</option>
                                    <option value="Retail">Retail</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="color: black;">Email *</label>
                                <input type="email" id="clientEmail" required style="color: black;">
                            </div>
                            <div class="form-group">
                                <label style="color: black;">Phone</label>
                                <input type="tel" id="clientPhone" style="color: black;">
                            </div>
                            <div class="form-group">
                                <label style="color: black;">Address</label>
                                <textarea id="clientAddress" rows="3" style="color: black;"></textarea>
                            </div>
                            <div class="form-group">
                                <label style="color: black;">Services</label>
                                <div class="checkbox-group">
                                    <label style="color: black;"><input type="checkbox" value="Web Design"> Web Design</label>
                                    <label style="color: black;"><input type="checkbox" value="SEO Services"> SEO Services</label>
                                    <label style="color: black;"><input type="checkbox" value="Social Media Management"> Social Media Management</label>
                                    <label style="color: black;"><input type="checkbox" value="Content Creation"> Content Creation</label>
                                    <label style="color: black;"><input type="checkbox" value="Paid Advertising"> Paid Advertising</label>
                                    <label style="color: black;"><input type="checkbox" value="Email Marketing"> Email Marketing</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label style="color: black;">Notes</label>
                                <textarea id="clientNotes" rows="3" style="color: black;"></textarea>
                            </div>
                            <div class="form-group">
                                <label style="color: black;">Source</label>
                                <select id="clientSource" style="color: black;">
                                    <option value="Website Form">Website Form</option>
                                    <option value="Referral">Referral</option>
                                    <option value="Google Ads">Google Ads</option>
                                    <option value="Facebook">Facebook</option>
                                    <option value="LinkedIn">LinkedIn</option>
                                    <option value="Cold Call">Cold Call</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="saveNewClient()">Save Client</button>
                        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveNewClient() {
            const form = document.getElementById('addClientForm');
            const formData = new FormData(form);
            
            const clientData = {
                name: document.getElementById('clientName').value,
                industry: document.getElementById('clientIndustry').value,
                email: document.getElementById('clientEmail').value,
                phone: document.getElementById('clientPhone').value,
                address: document.getElementById('clientAddress').value,
                services: Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value),
                notes: document.getElementById('clientNotes').value,
                source: document.getElementById('clientSource').value
            };
            
            if (!clientData.name || !clientData.industry || !clientData.email) {
                alert('Please fill in all required fields.');
                return;
            }
            
            window.tnrCRM.addClient(clientData);
            closeModal();
            loadClients();
            updateClientStats();
            alert('Client added successfully!');
        }

        function editClient(clientId) {
            const client = window.tnrCRM.getClient(clientId);
            if (!client) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 style="color: black;">Edit Client</h3>
                        <span class="close" onclick="closeModal()">&times;</span>
                    </div>
                    <div class="modal-body" style="color: black;">
                        <form id="editClientForm">
                            <div class="form-group">
                                <label style="color: black;">Client Name *</label>
                                <input type="text" id="editClientName" value="${client.name}" required style="color: black;">
                            </div>
                            <div class="form-group">
                                <label style="color: black;">Industry *</label>
                                <select id="editClientIndustry" required style="color: black;">
                                    <option value="Construction" ${client.industry === 'Construction' ? 'selected' : ''}>Construction</option>
                                    <option value="Legal Services" ${client.industry === 'Legal Services' ? 'selected' : ''}>Legal Services</option>
                                    <option value="E-commerce" ${client.industry === 'E-commerce' ? 'selected' : ''}>E-commerce</option>
                                    <option value="Food Service" ${client.industry === 'Food Service' ? 'selected' : ''}>Food Service</option>
                                    <option value="Healthcare" ${client.industry === 'Healthcare' ? 'selected' : ''}>Healthcare</option>
                                    <option value="Real Estate" ${client.industry === 'Real Estate' ? 'selected' : ''}>Real Estate</option>
                                    <option value="Retail" ${client.industry === 'Retail' ? 'selected' : ''}>Retail</option>
                                    <option value="Technology" ${client.industry === 'Technology' ? 'selected' : ''}>Technology</option>
                                    <option value="Other" ${client.industry === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="color: black;">Email *</label>
                                <input type="email" id="editClientEmail" value="${client.email}" required style="color: black;">
                            </div>
                            <div class="form-group">
                                <label style="color: black;">Phone</label>
                                <input type="tel" id="editClientPhone" value="${client.phone}" style="color: black;">
                            </div>
                            <div class="form-group">
                                <label style="color: black;">Address</label>
                                <textarea id="editClientAddress" rows="3" style="color: black;">${client.address}</textarea>
                            </div>
                            <div class="form-group">
                                <label style="color: black;">Status</label>
                                <select id="editClientStatus" style="color: black;">
                                    <option value="Active" ${client.status === 'Active' ? 'selected' : ''}>Active</option>
                                    <option value="Inactive" ${client.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                                    <option value="Prospect" ${client.status === 'Prospect' ? 'selected' : ''}>Prospect</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="color: black;">Services</label>
                                <div class="checkbox-group">
                                    <label style="color: black;"><input type="checkbox" value="Web Design" ${client.services.includes('Web Design') ? 'checked' : ''}> Web Design</label>
                                    <label style="color: black;"><input type="checkbox" value="SEO Services" ${client.services.includes('SEO Services') ? 'checked' : ''}> SEO Services</label>
                                    <label style="color: black;"><input type="checkbox" value="Social Media Management" ${client.services.includes('Social Media Management') ? 'checked' : ''}> Social Media Management</label>
                                    <label style="color: black;"><input type="checkbox" value="Content Creation" ${client.services.includes('Content Creation') ? 'checked' : ''}> Content Creation</label>
                                    <label style="color: black;"><input type="checkbox" value="Paid Advertising" ${client.services.includes('Paid Advertising') ? 'checked' : ''}> Paid Advertising</label>
                                    <label style="color: black;"><input type="checkbox" value="Email Marketing" ${client.services.includes('Email Marketing') ? 'checked' : ''}> Email Marketing</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label style="color: black;">Notes</label>
                                <textarea id="editClientNotes" rows="3" style="color: black;">${client.notes}</textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="saveEditedClient('${clientId}')">Save Changes</button>
                        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveEditedClient(clientId) {
            const clientData = {
                name: document.getElementById('editClientName').value,
                industry: document.getElementById('editClientIndustry').value,
                email: document.getElementById('editClientEmail').value,
                phone: document.getElementById('editClientPhone').value,
                address: document.getElementById('editClientAddress').value,
                status: document.getElementById('editClientStatus').value,
                services: Array.from(document.querySelectorAll('#editClientForm input[type="checkbox"]:checked')).map(cb => cb.value),
                notes: document.getElementById('editClientNotes').value,
                lastContact: new Date().toISOString().split('T')[0]
            };
            
            if (!clientData.name || !clientData.industry || !clientData.email) {
                alert('Please fill in all required fields.');
                return;
            }
            
            window.tnrCRM.updateClient(clientId, clientData);
            closeModal();
            loadClients();
            updateClientStats();
            alert('Client updated successfully!');
        }

        function deleteClient(clientId) {
            if (confirm('Are you sure you want to delete this client?')) {
                window.tnrCRM.deleteClient(clientId);
                loadClients();
                updateClientStats();
                alert('Client deleted successfully!');
            }
        }

        function convertLeadToClient(leadId) {
            const client = window.tnrCRM.convertLeadToClient(leadId);
            if (client) {
                loadLeads();
                loadClients();
                updateClientStats();
                alert('Lead converted to client successfully!');
            }
        }

        function deleteLead(leadId) {
            if (confirm('Are you sure you want to delete this lead?')) {
                window.tnrCRM.leads = window.tnrCRM.leads.filter(l => l.id !== leadId);
                window.tnrCRM.saveToStorage();
                loadLeads();
                updateClientStats();
                alert('Lead deleted successfully!');
            }
        }

        function editOrder(orderId) {
            const order = (window.tnrCRM.orders || []).find(o => o.id === orderId);
            if (!order) {
                alert('Order not found.');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3 style="color: white;">Edit Order</h3>
                        <span class="close" onclick="closeModal()">&times;</span>
                    </div>
                    <div class="modal-body" style="color: black;">
                        <form id="editOrderForm">
                            <div class="form-group">
                                <label style="color: black; font-weight: bold;">Client</label>
                                <input type="text" id="editOrderClientName" value="${order.clientName || ''}" style="color: black;" disabled>
                            </div>
                            <div class="form-group">
                                <label style="color: black; font-weight: bold;">Service/Product *</label>
                                <input type="text" id="editOrderService" value="${order.service || ''}" required style="color: black;">
                            </div>
                            <div class="form-group">
                                <label style="color: black; font-weight: bold;">Order Amount *</label>
                                <div style="display: flex; align-items: center;">
                                    <span style="margin-right: 0.5rem; font-size: 1.2rem;">$</span>
                                    <input type="number" id="editOrderAmount" step="0.01" min="0" value="${order.amount || 0}" required style="flex: 1; color: black;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label style="color: black; font-weight: bold;">Order Status *</label>
                                <select id="editOrderStatus" required style="color: black;">
                                    ${['Pending','Confirmed','In Progress','Completed','Cancelled'].map(s => `<option value="${s}" ${((order.status||'')===s)?'selected':''}>${s}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="color: black; font-weight: bold;">Order Description</label>
                                <textarea id="editOrderDescription" rows="3" style="color: black;">${order.description || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label style="color: black; font-weight: bold;">Project Timeline</label>
                                <input type="text" id="editOrderTimeline" value="${order.projectTimeline || ''}" style="color: black;">
                            </div>
                            <div class="form-group">
                                <label style="color: black; font-weight: bold;">Payment Method</label>
                                <input type="text" id="editOrderPaymentMethod" value="${order.paymentMethod || ''}" style="color: black;">
                            </div>
                            <div class="form-group">
                                <label style="color: black; font-weight: bold;">Special Requests / Notes</label>
                                <textarea id="editOrderSpecialRequests" rows="3" style="color: black;">${order.specialRequests || ''}</textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="saveEditedOrder('${orderId}')">Save Changes</button>
                        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveEditedOrder(orderId) {
            const update = {
                service: document.getElementById('editOrderService').value.trim(),
                amount: parseFloat(document.getElementById('editOrderAmount').value),
                status: document.getElementById('editOrderStatus').value,
                description: document.getElementById('editOrderDescription').value.trim(),
                projectTimeline: document.getElementById('editOrderTimeline').value.trim() || null,
                paymentMethod: document.getElementById('editOrderPaymentMethod').value.trim() || null,
                specialRequests: document.getElementById('editOrderSpecialRequests').value.trim() || null,
            };

            if (!update.service) {
                alert('Please enter a service.');
                return;
            }
            if (isNaN(update.amount) || update.amount <= 0) {
                alert('Please enter a valid order amount.');
                return;
            }

            window.tnrCRM.updateOrder(orderId, update);
            closeModal();
            loadOrders();
            updateClientStats();
            alert('Order updated successfully!');
        }

        function deleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order?')) {
                window.tnrCRM.orders = window.tnrCRM.orders.filter(o => o.id !== orderId);
                window.tnrCRM.saveToStorage();
                loadOrders();
                updateClientStats();
                alert('Order deleted successfully!');
            }
        }

        function convertSubmissionToLead(submissionId) {
            const submission = window.tnrCRM.formSubmissions.find(s => s.id === submissionId);
            if (submission) {
                window.tnrCRM.addLead({
                    name: submission.name,
                    email: submission.email,
                    phone: submission.phone,
                    industry: submission.industry || 'General',
                    message: submission.message,
                    source: submission.source
                });
                loadFormSubmissions();
                loadLeads();
                updateClientStats();
                alert('Form submission converted to lead successfully!');
            }
        }

        function deleteSubmission(submissionId) {
            if (confirm('Are you sure you want to delete this form submission?')) {
                window.tnrCRM.formSubmissions = window.tnrCRM.formSubmissions.filter(s => s.id !== submissionId);
                window.tnrCRM.saveToStorage();
                loadFormSubmissions();
                alert('Form submission deleted successfully!');
            }
        }

        function closeModal() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }
        
        function showAddOrderModal() {
            const clients = window.tnrCRM.clients || [];
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3 style="color: white;">Add New Order</h3>
                        <span class="close" onclick="closeModal()">&times;</span>
                    </div>
                    <div class="modal-body" style="color: black;">
                        <form id="addOrderForm">
                            <div class="form-group">
                                <label style="color: black; font-weight: bold;">Client Type *</label>
                                <select id="clientType" required onchange="toggleClientFields()" style="color: black;">
                                    <option value="">Select Client Type</option>
                                    <option value="existing">Existing Client</option>
                                    <option value="new">New Client</option>
                                </select>
                            </div>
                            
                            <div id="existingClientSection" style="display: none;">
                                <div class="form-group">
                                    <label style="color: black; font-weight: bold;">Select Client *</label>
                                    <select id="existingClientId" style="color: black;">
                                        <option value="">Choose a client...</option>
                                        ${clients.map(client => `<option value="${client.id}" data-name="${client.name}" data-email="${client.email || ''}" data-phone="${client.phone || ''}">${client.name} - ${client.email || 'No email'}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div id="newClientSection" style="display: none;">
                                <h4 style="color: var(--tnr-primary); margin-bottom: 1rem;">New Client Information</h4>
                                <div class="form-group">
                                    <label style="color: black; font-weight: bold;">Client Name *</label>
                                    <input type="text" id="newClientName" placeholder="Enter client name" style="color: black;">
                                </div>
                                <div class="form-group">
                                    <label style="color: black; font-weight: bold;">Email</label>
                                    <input type="email" id="newClientEmail" placeholder="client@example.com" style="color: black;">
                                </div>
                                <div class="form-group">
                                    <label style="color: black; font-weight: bold;">Phone</label>
                                    <input type="tel" id="newClientPhone" placeholder="(412) 555-1234" style="color: black;">
                                </div>
                                <div class="form-group">
                                    <label style="color: black; font-weight: bold;">Company</label>
                                    <input type="text" id="newClientCompany" placeholder="Company name (if applicable)" style="color: black;">
                                </div>
                            </div>
                            
                            <hr style="margin: 1.5rem 0;">
                            
                            <h4 style="color: var(--tnr-primary); margin-bottom: 1rem;">Order Details</h4>
                            
                            <div class="form-group">
                                <label style="color: black; font-weight: bold;">Service/Product *</label>
                                <select id="orderService" required style="color: black;">
                                    <option value="">Select Service</option>
                                    <option value="Web Design">Web Design</option>
                                    <option value="SEO Services">SEO Services</option>
                                    <option value="Social Media Management">Social Media Management</option>
                                    <option value="Content Creation">Content Creation</option>
                                    <option value="Paid Advertising">Paid Advertising</option>
                                    <option value="Email Marketing">Email Marketing</option>
                                    <option value="Insurance - Auto">Insurance - Auto</option>
                                    <option value="Insurance - Home">Insurance - Home</option>
                                    <option value="Insurance - Business">Insurance - Business</option>
                                    <option value="Insurance - Life">Insurance - Life</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group" id="customServiceGroup" style="display: none;">
                                <label style="color: black; font-weight: bold;">Custom Service Name</label>
                                <input type="text" id="customService" placeholder="Enter service name" style="color: black;">
                            </div>
                            
                            <div class="form-group">
                                <label style="color: black; font-weight: bold;">Order Amount *</label>
                                <div style="display: flex; align-items: center;">
                                    <span style="margin-right: 0.5rem; font-size: 1.2rem;">$</span>
                                    <input type="number" id="orderAmount" step="0.01" min="0" placeholder="0.00" required style="flex: 1; color: black;">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label style="color: black; font-weight: bold;">Order Status *</label>
                                <select id="orderStatus" required style="color: black;">
                                    <option value="Pending">Pending</option>
                                    <option value="Confirmed">Confirmed</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label style="color: black; font-weight: bold;">Order Description</label>
                                <textarea id="orderDescription" rows="3" placeholder="Describe the order details, requirements, or special notes..." style="color: black;"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label style="color: black; font-weight: bold;">Project Timeline</label>
                                <select id="orderTimeline" style="color: black;">
                                    <option value="">Select Timeline</option>
                                    <option value="ASAP">ASAP</option>
                                    <option value="1 Week">1 Week</option>
                                    <option value="2 Weeks">2 Weeks</option>
                                    <option value="1 Month">1 Month</option>
                                    <option value="2-3 Months">2-3 Months</option>
                                    <option value="3-6 Months">3-6 Months</option>
                                    <option value="Ongoing">Ongoing</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label style="color: black; font-weight: bold;">Payment Method</label>
                                <select id="paymentMethod" style="color: black;">
                                    <option value="">Select Payment Method</option>
                                    <option value="Credit Card">Credit Card</option>
                                    <option value="Debit Card">Debit Card</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Check">Check</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Payment Plan">Payment Plan</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label style="color: black; font-weight: bold;">Special Requests / Notes</label>
                                <textarea id="specialRequests" rows="3" placeholder="Any special requests, notes, or additional information..." style="color: black;"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="saveNewOrder()">Save Order</button>
                        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add change listener for service dropdown
            document.getElementById('orderService').addEventListener('change', function() {
                const customGroup = document.getElementById('customServiceGroup');
                if (this.value === 'Other') {
                    customGroup.style.display = 'block';
                    document.getElementById('customService').required = true;
                } else {
                    customGroup.style.display = 'none';
                    document.getElementById('customService').required = false;
                }
            });
        }
        
        function toggleClientFields() {
            const clientType = document.getElementById('clientType').value;
            const existingSection = document.getElementById('existingClientSection');
            const newSection = document.getElementById('newClientSection');
            const existingSelect = document.getElementById('existingClientId');
            
            if (clientType === 'existing') {
                existingSection.style.display = 'block';
                newSection.style.display = 'none';
                existingSelect.required = true;
                document.getElementById('newClientName').required = false;
            } else if (clientType === 'new') {
                existingSection.style.display = 'none';
                newSection.style.display = 'block';
                existingSelect.required = false;
                document.getElementById('newClientName').required = true;
            } else {
                existingSection.style.display = 'none';
                newSection.style.display = 'none';
                existingSelect.required = false;
                document.getElementById('newClientName').required = false;
            }
        }
        
        function saveNewOrder() {
            const clientType = document.getElementById('clientType').value;
            
            if (!clientType) {
                alert('Please select a client type.');
                return;
            }
            
            let clientName = '';
            let clientId = null;
            let clientEmail = '';
            let clientPhone = '';
            
            if (clientType === 'existing') {
                const selectedOption = document.getElementById('existingClientId').options[document.getElementById('existingClientId').selectedIndex];
                if (!selectedOption.value) {
                    alert('Please select a client.');
                    return;
                }
                clientId = selectedOption.value;
                clientName = selectedOption.getAttribute('data-name');
                clientEmail = selectedOption.getAttribute('data-email') || '';
                clientPhone = selectedOption.getAttribute('data-phone') || '';
            } else {
                clientName = document.getElementById('newClientName').value.trim();
                if (!clientName) {
                    alert('Please enter the client name.');
                    return;
                }
                clientEmail = document.getElementById('newClientEmail').value.trim();
                clientPhone = document.getElementById('newClientPhone').value.trim();
                const clientCompany = document.getElementById('newClientCompany').value.trim();
                
                // Create new client first
                const newClient = window.tnrCRM.addClient({
                    name: clientName,
                    email: clientEmail,
                    phone: clientPhone,
                    company: clientCompany,
                    industry: 'Not specified',
                    services: [],
                    status: 'Active',
                    source: 'Manual Entry'
                });
                clientId = newClient.id;
            }
            
            const service = document.getElementById('orderService').value;
            const customService = document.getElementById('customService').value;
            const finalService = (service === 'Other' && customService) ? customService : service;
            
            if (!finalService) {
                alert('Please select or enter a service.');
                return;
            }
            
            const amount = parseFloat(document.getElementById('orderAmount').value);
            if (!amount || amount <= 0) {
                alert('Please enter a valid order amount.');
                return;
            }
            
            const orderData = {
                clientName: clientName,
                clientId: clientId,
                service: finalService,
                amount: amount,
                status: document.getElementById('orderStatus').value,
                description: document.getElementById('orderDescription').value.trim(),
                projectTimeline: document.getElementById('orderTimeline').value || null,
                paymentMethod: document.getElementById('paymentMethod').value || null,
                specialRequests: document.getElementById('specialRequests').value.trim() || null,
                customerInfo: {
                    name: clientName,
                    email: clientEmail,
                    phone: clientPhone
                },
                industry: 'General',
                orderDate: new Date().toISOString().split('T')[0]
            };
            
            window.tnrCRM.addOrder(orderData);
            closeModal();
            loadOrders();
            updateClientStats();
            alert(`Order added successfully! Order #${orderData.id || 'TNR-' + Date.now()}`);
        }

        function convertFormSubmissions() {
            if (!window.tnrCRM) {
                alert('CRM not initialized');
                return;
            }
            
            const storedSubmissions = localStorage.getItem("tnr_form_submissions");
            if (storedSubmissions) {
                const submissions = JSON.parse(storedSubmissions);
                const beforeCount = window.tnrCRM.leads.length;
                
                // Converting form submissions to leads
                
                window.tnrCRM.autoConvertSubmissionsToLeads(submissions);
                
                const afterCount = window.tnrCRM.leads.length;
                const converted = afterCount - beforeCount;
                
                // Conversion completed
                
                if (converted > 0) {
                    alert(`Converted ${converted} form submissions to leads!`);
                    loadLeads(); // Refresh the display
                    updateClientStats(); // Update statistics
                } else {
                    alert('No new form submissions to convert');
                }
            } else {
                alert('No form submissions found in localStorage');
            }
        }

        // ========== SOCIAL MEDIA TOKEN MANAGEMENT ==========
        async function loadSocialTokens() {
            const tokensList = document.getElementById('tokensList');
            if (!tokensList) return;

            tokensList.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">Loading tokens...</div>';

            try {
                const res = await fetch('/api/social/tokens');
                const data = await res.json();

                if (!data.success || !data.tokens || data.tokens.length === 0) {
                    tokensList.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üîó</div>
                            <p style="margin-bottom: 1rem;"><strong>No connected accounts</strong></p>
                            <p style="margin-bottom: 1.5rem;">Connect your social media accounts to get started with automated posting.</p>
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center;">
                                <a href="/api/auth/meta" class="btn" style="background: #1877f2; color: white; text-decoration: none; display: inline-block; padding: 0.75rem 1.5rem; border-radius: 4px;">üìò Connect Facebook/Instagram</a>
                                <a href="/api/auth/linkedin" class="btn" style="background: #0077b5; color: white; text-decoration: none; display: inline-block; padding: 0.75rem 1.5rem; border-radius: 4px;">üíº Connect LinkedIn</a>
                                <a href="/api/auth/twitter" class="btn" style="background: #1DA1F2; color: white; text-decoration: none; display: inline-block; padding: 0.75rem 1.5rem; border-radius: 4px;">üê¶ Connect X (Twitter)</a>
                            </div>
                        </div>
                    `;
                    return;
                }

                tokensList.innerHTML = data.tokens.map(token => `
                    <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 1.5rem;">${
                                        token.platform === 'facebook' ? 'üìò' : 
                                        token.platform === 'instagram' ? 'üì∑' : 
                                        token.platform === 'linkedin' ? 'üíº' : 
                                        token.platform === 'twitter' ? 'üê¶' : 
                                        'üîó'
                                    }</span>
                                    <div>
                                        <h4 style="margin: 0; color: var(--tnr-navy);">${token.page_name || token.platform.charAt(0).toUpperCase() + token.platform.slice(1)}</h4>
                                        <p style="margin: 0; color: #666; font-size: 0.875rem;">${
                                            token.platform === 'instagram' && token.instagram_username ? `@${token.instagram_username}` : 
                                            token.platform === 'twitter' && token.page_name ? token.page_name.split('@')[1] || token.page_name : 
                                            token.page_id || 'Account'
                                        }</p>
                                    </div>
                                </div>
                                ${token.instagram_account_id && token.platform === 'instagram' ? `
                                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px; font-size: 0.875rem;">
                                        <strong>Instagram ID:</strong> ${token.instagram_account_id}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn-small" onclick="testToken('${token.id}', '${token.platform}')" style="background: #28a745; color: white;">üß™ Test</button>
                                <button class="btn-small btn-danger" onclick="deleteToken('${token.id}', '${token.page_name || token.platform}')">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; font-size: 0.875rem; color: #666;">
                            <div><strong>Platform:</strong> ${token.platform}</div>
                            <div><strong>Token Status:</strong> <span style="color: ${token.has_token ? '#28a745' : '#dc3545'}">${token.has_token ? '‚úÖ Valid' : '‚ùå Missing'}</span></div>
                            <div><strong>Expires:</strong> ${token.expires_at ? new Date(token.expires_at).toLocaleDateString() : 'Never'}</div>
                            <div><strong>Added:</strong> ${token.created_at ? new Date(token.created_at).toLocaleDateString() : 'N/A'}</div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading tokens:', error);
                tokensList.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #dc3545;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
                        <p><strong>Error loading tokens</strong></p>
                        <p style="font-size: 0.875rem;">${error.message}</p>
                        <button class="btn" onclick="loadSocialTokens()" style="margin-top: 1rem;">Try Again</button>
                    </div>
                `;
            }
        }

        async function testToken(tokenId, platform) {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Testing...';
            button.disabled = true;

            try {
                const res = await fetch('/api/social/tokens?action=test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tokenId, platform })
                });

                const data = await res.json();
                
                if (data.success && data.valid) {
                    alert(`‚úÖ Token is valid!\n\n${data.message || 'Connection successful'}`);
                } else {
                    alert(`‚ùå Token is invalid or expired.\n\n${data.error || data.message || 'Please reconnect your account.'}`);
                }
            } catch (error) {
                alert(`‚ùå Error testing token: ${error.message}`);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        async function deleteToken(tokenId, tokenName) {
            if (!confirm(`Are you sure you want to delete the token for "${tokenName}"?\n\nYou will need to reconnect to post to this account.`)) {
                return;
            }

            try {
                const res = await fetch(`/api/social/tokens?tokenId=${tokenId}`, {
                    method: 'DELETE'
                });

                const data = await res.json();
                
                if (data.success) {
                    alert('‚úÖ Token deleted successfully');
                    loadSocialTokens(); // Refresh the list
                } else {
                    alert(`‚ùå Error: ${data.error || 'Failed to delete token'}`);
                }
            } catch (error) {
                alert(`‚ùå Error deleting token: ${error.message}`);
            }
        }

        // Track if tokens have been loaded
        let tokensLoaded = false;

        // ========== WORKFLOW MANAGEMENT ==========
        let workflowActions = [];
        let editingWorkflowId = null;

        async function loadWorkflows() {
            const workflowsList = document.getElementById('workflowsList');
            if (!workflowsList) return;

            try {
                const res = await fetch('/api/workflows');
                const data = await res.json();

                if (!data.success || !data.workflows || data.workflows.length === 0) {
                    workflowsList.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ü§ñ</div>
                            <p style="margin-bottom: 1rem;"><strong>No workflows created yet</strong></p>
                            <p style="margin-bottom: 1.5rem;">Create your first automation workflow to get started.</p>
                            <button class="btn" onclick="showCreateWorkflowModal()" style="background: var(--tnr-gold); color: var(--tnr-navy);">Create Workflow</button>
                        </div>
                    `;
                    return;
                }

                workflowsList.innerHTML = data.workflows.map(workflow => `
                    <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 1.5rem;">ü§ñ</span>
                                    <div>
                                        <h4 style="margin: 0; color: var(--tnr-navy);">${workflow.workflowName}</h4>
                                        <p style="margin: 0; color: #666; font-size: 0.875rem;">Type: ${workflow.workflowType || 'Custom'}</p>
                                    </div>
                                </div>
                                <div style="margin-top: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px; font-size: 0.875rem;">
                                    <strong>Trigger:</strong> ${formatTrigger(workflow.trigger)}<br/>
                                    <strong>Actions:</strong> ${workflow.actions?.length || 0} action(s)
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn-small" onclick="toggleWorkflow('${workflow.id}', ${!workflow.isActive})" style="background: ${workflow.isActive ? '#28a745' : '#6c757d'}; color: white;">
                                    ${workflow.isActive ? '‚úÖ Active' : '‚è∏Ô∏è Inactive'}
                                </button>
                                <button class="btn-small" onclick="editWorkflow('${workflow.id}')" style="background: #007bff; color: white;">‚úèÔ∏è Edit</button>
                                <button class="btn-small btn-danger" onclick="deleteWorkflow('${workflow.id}', '${workflow.workflowName}')">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; font-size: 0.875rem; color: #666;">
                            <div><strong>Status:</strong> <span style="color: ${workflow.isActive ? '#28a745' : '#dc3545'}">${workflow.isActive ? '‚úÖ Active' : '‚è∏Ô∏è Inactive'}</span></div>
                            <div><strong>Last Run:</strong> ${workflow.lastRun ? new Date(workflow.lastRun).toLocaleString() : 'Never'}</div>
                            <div><strong>Next Run:</strong> ${workflow.nextRun ? new Date(workflow.nextRun).toLocaleString() : 'N/A'}</div>
                            <div><strong>Created:</strong> ${workflow.createdAt ? new Date(workflow.createdAt).toLocaleDateString() : 'N/A'}</div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading workflows:', error);
                workflowsList.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #dc3545;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
                        <p><strong>Error loading workflows</strong></p>
                        <p style="font-size: 0.875rem;">${error.message}</p>
                        <button class="btn" onclick="loadWorkflows()" style="margin-top: 1rem;">Try Again</button>
                    </div>
                `;
            }
        }

        function formatTrigger(trigger) {
            if (!trigger || !trigger.type) return 'Not configured';
            const types = {
                'new_lead': 'New Lead Created',
                'lead_status_change': 'Lead Status Changed',
                'client_status_change': 'Client Status Changed',
                'date_based': 'Date-Based'
            };
            return types[trigger.type] || trigger.type;
        }

        function showCreateWorkflowModal() {
            editingWorkflowId = null;
            workflowActions = [];
            document.getElementById('workflowName').value = '';
            document.getElementById('workflowTriggerType').value = '';
            document.getElementById('triggerFields').style.display = 'none';
            document.getElementById('workflowActions').innerHTML = '';
            document.getElementById('workflowModal').style.display = 'block';
        }

        function closeWorkflowModal() {
            document.getElementById('workflowModal').style.display = 'none';
        }

        function updateTriggerFields() {
            const triggerType = document.getElementById('workflowTriggerType').value;
            const triggerFields = document.getElementById('triggerFields');
            
            if (!triggerType) {
                triggerFields.style.display = 'none';
                return;
            }
            
            triggerFields.style.display = 'block';
            
            switch(triggerType) {
                case 'lead_status_change':
                    triggerFields.innerHTML = `
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">From Status</label>
                        <select id="triggerFromStatus" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Any Status</option>
                            <option value="New">New</option>
                            <option value="Contacted">Contacted</option>
                            <option value="Qualified">Qualified</option>
                        </select>
                        <label style="display: block; margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 600;">To Status</label>
                        <select id="triggerToStatus" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Any Status</option>
                            <option value="Contacted">Contacted</option>
                            <option value="Qualified">Qualified</option>
                            <option value="Converted">Converted</option>
                        </select>
                    `;
                    break;
                case 'date_based':
                    triggerFields.innerHTML = `
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Trigger After</label>
                        <input type="number" id="triggerDays" placeholder="Number of days" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" />
                        <label style="display: block; margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 600;">Based On</label>
                        <select id="triggerDateField" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="createdAt">Lead/Client Created Date</option>
                            <option value="lastContact">Last Contact Date</option>
                        </select>
                    `;
                    break;
                default:
                    triggerFields.innerHTML = '<p style="color: #666; font-size: 0.875rem;">This trigger will fire automatically when the event occurs.</p>';
            }
        }

        function addWorkflowAction() {
            const actionId = `action-${Date.now()}`;
            workflowActions.push({ id: actionId, type: '', config: {} });
            renderActions();
        }

        function removeWorkflowAction(actionId) {
            workflowActions = workflowActions.filter(a => a.id !== actionId);
            renderActions();
        }

        function renderActions() {
            const container = document.getElementById('workflowActions');
            if (workflowActions.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No actions added yet. Click "+ Add Action" to add one.</p>';
                return;
            }
            
            container.innerHTML = workflowActions.map((action, index) => `
                <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; padding: 1rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <strong>Action ${index + 1}</strong>
                        <button onclick="removeWorkflowAction('${action.id}')" style="background: #dc3545; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">Remove</button>
                    </div>
                    <select onchange="updateActionConfig('${action.id}', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Select Action Type...</option>
                        <option value="send_email" ${action.type === 'send_email' ? 'selected' : ''}>Send Email</option>
                        <option value="update_status" ${action.type === 'update_status' ? 'selected' : ''}>Update Status</option>
                        <option value="add_note" ${action.type === 'add_note' ? 'selected' : ''}>Add Note</option>
                    </select>
                    <div id="actionConfig-${action.id}" style="margin-top: 0.75rem;">
                        ${renderActionConfig(action)}
                    </div>
                </div>
            `).join('');
        }

        function updateActionConfig(actionId, actionType) {
            const action = workflowActions.find(a => a.id === actionId);
            if (action) {
                action.type = actionType;
                action.config = {};
                renderActions();
            }
        }

        function renderActionConfig(action) {
            if (!action.type) return '';
            
            switch(action.type) {
                case 'send_email':
                    return `
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem;">Email Subject</label>
                        <input type="text" id="emailSubject-${action.id}" placeholder="Welcome Email" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem;" />
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem;">Email Content</label>
                        <textarea id="emailContent-${action.id}" rows="4" placeholder="Use {{name}} and {{company}} for personalization" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                    `;
                case 'update_status':
                    return `
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem;">New Status</label>
                        <select id="newStatus-${action.id}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="Contacted">Contacted</option>
                            <option value="Qualified">Qualified</option>
                            <option value="Active">Active</option>
                        </select>
                    `;
                case 'add_note':
                    return `
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem;">Note Content</label>
                        <textarea id="noteContent-${action.id}" rows="3" placeholder="Automated note from workflow" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                    `;
                default:
                    return '';
            }
        }

        async function saveWorkflow() {
            const workflowName = document.getElementById('workflowName').value.trim();
            const triggerType = document.getElementById('workflowTriggerType').value;
            
            if (!workflowName || !triggerType) {
                alert('Please fill in workflow name and select a trigger type.');
                return;
            }
            
            if (workflowActions.length === 0) {
                alert('Please add at least one action to the workflow.');
                return;
            }
            
            // Build trigger object
            const trigger = { type: triggerType };
            if (triggerType === 'lead_status_change') {
                trigger.fromStatus = document.getElementById('triggerFromStatus')?.value || '';
                trigger.toStatus = document.getElementById('triggerToStatus')?.value || '';
            } else if (triggerType === 'date_based') {
                trigger.days = parseInt(document.getElementById('triggerDays')?.value || 0);
                trigger.dateField = document.getElementById('triggerDateField')?.value || 'createdAt';
            }
            
            // Build actions array with configs
            const actions = workflowActions.map(action => {
                const config = { ...action.config };
                if (action.type === 'send_email') {
                    config.subject = document.getElementById(`emailSubject-${action.id}`)?.value || '';
                    config.content = document.getElementById(`emailContent-${action.id}`)?.value || '';
                } else if (action.type === 'update_status') {
                    config.status = document.getElementById(`newStatus-${action.id}`)?.value || '';
                } else if (action.type === 'add_note') {
                    config.note = document.getElementById(`noteContent-${action.id}`)?.value || '';
                }
                return { type: action.type, config };
            });
            
            const workflowData = {
                id: editingWorkflowId,
                workflowName,
                workflowType: triggerType,
                trigger,
                actions,
                isActive: true
            };
            
            try {
                const res = await fetch('/api/workflows', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(workflowData)
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert('‚úÖ Workflow saved successfully!');
                    closeWorkflowModal();
                    loadWorkflows();
                } else {
                    alert(`‚ùå Error: ${data.error || 'Failed to save workflow'}`);
                }
            } catch (error) {
                alert(`‚ùå Error saving workflow: ${error.message}`);
            }
        }

        async function toggleWorkflow(workflowId, isActive) {
            try {
                const res = await fetch('/api/workflows', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ workflowId, isActive })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    loadWorkflows();
                } else {
                    alert(`‚ùå Error: ${data.error || 'Failed to update workflow'}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        async function deleteWorkflow(workflowId, workflowName) {
            if (!confirm(`Are you sure you want to delete the workflow "${workflowName}"?`)) {
                return;
            }
            
            try {
                const res = await fetch(`/api/workflows?workflowId=${workflowId}`, {
                    method: 'DELETE'
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert('‚úÖ Workflow deleted successfully');
                    loadWorkflows();
                } else {
                    alert(`‚ùå Error: ${data.error || 'Failed to delete workflow'}`);
                }
            } catch (error) {
                alert(`‚ùå Error deleting workflow: ${error.message}`);
            }
        }

        async function editWorkflow(workflowId) {
            try {
                const res = await fetch('/api/workflows');
                const data = await res.json();
                
                if (!data.success) {
                    alert('Error loading workflow');
                    return;
                }
                
                const workflow = data.workflows.find(w => w.id === workflowId);
                if (!workflow) {
                    alert('Workflow not found');
                    return;
                }
                
                editingWorkflowId = workflowId;
                document.getElementById('workflowName').value = workflow.workflowName;
                document.getElementById('workflowTriggerType').value = workflow.trigger?.type || '';
                updateTriggerFields();
                
                workflowActions = (workflow.actions || []).map((action, index) => ({
                    id: `action-${Date.now()}-${index}`,
                    type: action.type,
                    config: action.config || {}
                }));
                renderActions();
                
                document.getElementById('workflowModal').style.display = 'block';
            } catch (error) {
                alert(`Error loading workflow: ${error.message}`);
            }
        }

        // ========== ANALYTICS ==========
        async function loadAnalytics() {
            const analyticsContent = document.getElementById('analyticsContent');
            if (!analyticsContent) return;

            analyticsContent.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">Loading analytics...</div>';

            try {
                const res = await fetch('/api/analytics?type=all');
                const data = await res.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load analytics');
                }

                const analytics = data.analytics;

                analyticsContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--tnr-navy);">${analytics.overview?.totalClients || 0}</div>
                            <div style="color: #666; margin-top: 0.5rem;">Total Clients</div>
                            <div style="color: #28a745; font-size: 0.875rem; margin-top: 0.25rem;">${analytics.overview?.activeClients || 0} active</div>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--tnr-navy);">${analytics.overview?.totalLeads || 0}</div>
                            <div style="color: #666; margin-top: 0.5rem;">Total Leads</div>
                            <div style="color: #ffc107; font-size: 0.875rem; margin-top: 0.25rem;">${analytics.overview?.newLeads || 0} new</div>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--tnr-navy);">${analytics.overview?.conversionRate || 0}%</div>
                            <div style="color: #666; margin-top: 0.5rem;">Conversion Rate</div>
                            <div style="color: #17a2b8; font-size: 0.875rem; margin-top: 0.25rem;">Leads ‚Üí Clients</div>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--tnr-navy);">$${((analytics.overview?.totalRevenue || 0) / 1000).toFixed(1)}K</div>
                            <div style="color: #666; margin-top: 0.5rem;">Total Revenue</div>
                            <div style="color: #28a745; font-size: 0.875rem; margin-top: 0.25rem;">${analytics.overview?.completedOrders || 0} orders</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="color: var(--tnr-navy); margin-bottom: 1rem; font-size: 1.25rem;">üìä Lead Sources</h3>
                            ${analytics.leadSources && analytics.leadSources.length > 0 ? `
                                <div>
                                    ${analytics.leadSources.slice(0, 5).map(source => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 4px; margin-bottom: 0.5rem;">
                                            <div>
                                                <strong>${source.source}</strong>
                                                <div style="font-size: 0.875rem; color: #666;">${source.count} leads</div>
                                            </div>
                                            <div style="font-size: 1.25rem; font-weight: 600; color: var(--tnr-gold);">${source.percentage}%</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p style="color: #666; font-style: italic;">No lead sources tracked yet</p>'}
                        </div>

                        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="color: var(--tnr-navy); margin-bottom: 1rem; font-size: 1.25rem;">üè¢ Business Types</h3>
                            ${analytics.businessTypes && analytics.businessTypes.length > 0 ? `
                                <div>
                                    ${analytics.businessTypes.slice(0, 5).map(type => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 4px; margin-bottom: 0.5rem;">
                                            <div>
                                                <strong>${type.type}</strong>
                                            </div>
                                            <div style="font-size: 1.25rem; font-weight: 600; color: var(--tnr-gold);">${type.count}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p style="color: #666; font-style: italic;">No business types tracked yet</p>'}
                        </div>
                    </div>

                    <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="color: var(--tnr-navy); margin-bottom: 1rem; font-size: 1.25rem;">üìà Recent Activity (Last 30 Days)</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                                <div style="font-size: 2rem; font-weight: 700; color: var(--tnr-navy);">${analytics.recentActivity?.newClients || 0}</div>
                                <div style="color: #666; margin-top: 0.5rem;">New Clients</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                                <div style="font-size: 2rem; font-weight: 700; color: var(--tnr-navy);">${analytics.recentActivity?.newLeads || 0}</div>
                                <div style="color: #666; margin-top: 0.5rem;">New Leads</div>
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading analytics:', error);
                analyticsContent.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #dc3545;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
                        <p><strong>Error loading analytics</strong></p>
                        <p style="font-size: 0.875rem;">${error.message}</p>
                        <button class="btn" onclick="loadAnalytics()" style="margin-top: 1rem;">Try Again</button>
                    </div>
                `;
            }
        }

        // ========== ACTIVITY TIMELINE ==========
        async function showActivityTimeline(entityType, entityId, entityName) {
            const modal = document.createElement('div');
            modal.id = 'activityModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto; padding: 2rem;';
            
            modal.innerHTML = `
                <div style="background: white; margin: 0 auto; max-width: 800px; border-radius: 8px; padding: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: var(--tnr-navy); margin: 0;">üìã Activity Timeline - ${entityName}</h2>
                        <button onclick="closeActivityModal()" style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">‚úï Close</button>
                    </div>
                    
                    <button onclick="showAddActivityModal('${entityType}', '${entityId}')" class="btn" style="background: var(--tnr-gold); color: var(--tnr-navy); margin-bottom: 1.5rem;">+ Add Activity</button>
                    
                    <div id="activityTimelineContent" style="min-height: 200px;">
                        <div style="text-align: center; padding: 2rem; color: #666;">Loading activities...</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentActivityModal = modal;
            window.currentActivityEntity = { type: entityType, id: entityId };
            
            await loadActivities(entityType, entityId);
        }

        async function loadActivities(entityType, entityId) {
            const content = document.getElementById('activityTimelineContent');
            if (!content) return;

            try {
                const res = await fetch(`/api/activities?entityType=${entityType}&entityId=${entityId}`);
                const data = await res.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load activities');
                }

                const activities = data.activities || [];

                if (activities.length === 0) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                            <p><strong>No activities yet</strong></p>
                            <p style="font-size: 0.875rem;">Add your first activity to start tracking interactions.</p>
                        </div>
                    `;
                    return;
                }

                const activityIcons = {
                    'call': 'üìû',
                    'email': 'üìß',
                    'meeting': 'ü§ù',
                    'note': 'üìù',
                    'status_change': 'üîÑ',
                    'workflow': 'ü§ñ'
                };

                content.innerHTML = activities.map(activity => `
                    <div style="background: #f8f9fa; border-left: 4px solid var(--tnr-gold); padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 1.5rem;">${activityIcons[activity.activityType] || 'üìå'}</span>
                                    <div>
                                        <strong style="color: var(--tnr-navy);">${activity.title || activity.activityType}</strong>
                                        <div style="font-size: 0.875rem; color: #666; margin-top: 0.25rem;">
                                            ${new Date(activity.createdAt).toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                                ${activity.description ? `<p style="color: #333; margin-top: 0.5rem;">${activity.description}</p>` : ''}
                            </div>
                            <button onclick="deleteActivity('${activity.id}')" style="background: #dc3545; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">Delete</button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading activities:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #dc3545;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
                        <p><strong>Error loading activities</strong></p>
                        <p style="font-size: 0.875rem;">${error.message}</p>
                    </div>
                `;
            }
        }

        function closeActivityModal() {
            if (window.currentActivityModal) {
                document.body.removeChild(window.currentActivityModal);
                window.currentActivityModal = null;
                window.currentActivityEntity = null;
            }
        }

        function showAddActivityModal(entityType, entityId) {
            const activityType = prompt('Activity Type:\n1. call\n2. email\n3. meeting\n4. note\n5. status_change\n6. workflow', 'note');
            if (!activityType) return;

            const title = prompt('Title:', '');
            if (title === null) return;

            const description = prompt('Description (optional):', '');

            addActivity({
                entityType,
                entityId,
                activityType,
                title,
                description: description || null
            });
        }

        async function addActivity(activityData) {
            try {
                const res = await fetch('/api/activities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(activityData)
                });

                const data = await res.json();

                if (data.success) {
                    alert('‚úÖ Activity added successfully!');
                    if (window.currentActivityEntity) {
                        await loadActivities(window.currentActivityEntity.type, window.currentActivityEntity.id);
                    }
                } else {
                    alert(`‚ùå Error: ${data.error || 'Failed to add activity'}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        async function deleteActivity(activityId) {
            if (!confirm('Are you sure you want to delete this activity?')) return;

            try {
                const res = await fetch(`/api/activities?activityId=${activityId}`, {
                    method: 'DELETE'
                });

                const data = await res.json();

                if (data.success) {
                    if (window.currentActivityEntity) {
                        await loadActivities(window.currentActivityEntity.type, window.currentActivityEntity.id);
                    }
                } else {
                    alert(`‚ùå Error: ${data.error || 'Failed to delete activity'}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // ========== EMAIL TEMPLATES ==========
        async function loadEmailTemplates() {
            const templatesList = document.getElementById('templatesList');
            if (!templatesList) return;

            try {
                const res = await fetch('/api/email-templates');
                const data = await res.json();

                if (!data.success || !data.templates || data.templates.length === 0) {
                    templatesList.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìß</div>
                            <p style="margin-bottom: 1rem;"><strong>No email templates created yet</strong></p>
                            <p style="margin-bottom: 1.5rem;">Create your first email template to get started.</p>
                            <button class="btn" onclick="showCreateTemplateModal()" style="background: var(--tnr-gold); color: var(--tnr-navy);">Create Template</button>
                        </div>
                    `;
                    return;
                }

                templatesList.innerHTML = data.templates.map(template => `
                    <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0; color: var(--tnr-navy);">${template.templateName}</h4>
                                <p style="margin: 0.5rem 0; color: #666; font-size: 0.875rem;">
                                    <strong>Subject:</strong> ${template.subject}<br/>
                                    ${template.category ? `<strong>Category:</strong> ${template.category}<br/>` : ''}
                                    <strong>Variables:</strong> ${(template.variables || []).join(', ') || 'None'}
                                </p>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn-small" onclick="editEmailTemplate('${template.id}')" style="background: #007bff; color: white;">‚úèÔ∏è Edit</button>
                                <button class="btn-small btn-danger" onclick="deleteEmailTemplate('${template.id}', '${template.templateName}')">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                        <div style="background: white; padding: 1rem; border-radius: 4px; font-size: 0.875rem; color: #666; max-height: 200px; overflow-y: auto;">
                            ${template.htmlContent.substring(0, 200)}${template.htmlContent.length > 200 ? '...' : ''}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading templates:', error);
                templatesList.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #dc3545;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
                        <p><strong>Error loading templates</strong></p>
                        <p style="font-size: 0.875rem;">${error.message}</p>
                        <button class="btn" onclick="loadEmailTemplates()" style="margin-top: 1rem;">Try Again</button>
                    </div>
                `;
            }
        }

        function showCreateTemplateModal() {
            const modal = document.createElement('div');
            modal.id = 'templateModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto; padding: 2rem;';
            
            modal.innerHTML = `
                <div style="background: white; margin: 0 auto; max-width: 900px; border-radius: 8px; padding: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: var(--tnr-navy); margin: 0;">Create Email Template</h2>
                        <button onclick="closeTemplateModal()" style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">‚úï Close</button>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Template Name</label>
                        <input type="text" id="templateName" placeholder="e.g., Welcome Email" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" />
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Category (optional)</label>
                        <input type="text" id="templateCategory" placeholder="e.g., Welcome, Follow-up" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" />
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Subject</label>
                        <input type="text" id="templateSubject" placeholder="Welcome to {{company}}!" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" />
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">HTML Content</label>
                        <textarea id="templateHtmlContent" rows="12" placeholder="<h1>Hello {{name}},</h1><p>Welcome to {{company}}!</p>" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;"></textarea>
                        <div style="font-size: 0.875rem; color: #666; margin-top: 0.5rem;">
                            Available variables: <code>{{name}}</code>, <code>{{email}}</code>, <code>{{phone}}</code>, <code>{{company}}</code>, <code>{{businessType}}</code>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="closeTemplateModal()" class="btn" style="background: #666;">Cancel</button>
                        <button onclick="saveEmailTemplate()" class="btn" style="background: var(--tnr-gold); color: var(--tnr-navy); font-weight: 600;">üíæ Save Template</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentTemplateModal = modal;
            window.editingTemplateId = null;
        }

        function closeTemplateModal() {
            if (window.currentTemplateModal) {
                document.body.removeChild(window.currentTemplateModal);
                window.currentTemplateModal = null;
                window.editingTemplateId = null;
            }
        }

        async function saveEmailTemplate() {
            const templateName = document.getElementById('templateName').value.trim();
            const subject = document.getElementById('templateSubject').value.trim();
            const htmlContent = document.getElementById('templateHtmlContent').value.trim();
            const category = document.getElementById('templateCategory').value.trim();

            if (!templateName || !subject || !htmlContent) {
                alert('Please fill in template name, subject, and HTML content.');
                return;
            }

            // Extract variables from content
            const variableMatches = htmlContent.match(/\{\{(\w+)\}\}/g) || [];
            const variables = [...new Set(variableMatches.map(v => v.replace(/[{}]/g, '')))];

            const templateData = {
                id: window.editingTemplateId,
                templateName,
                subject,
                htmlContent,
                category: category || null,
                variables,
                isDefault: false
            };

            try {
                const res = await fetch('/api/email-templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(templateData)
                });

                const data = await res.json();

                if (data.success) {
                    alert('‚úÖ Template saved successfully!');
                    closeTemplateModal();
                    loadEmailTemplates();
                } else {
                    alert(`‚ùå Error: ${data.error || 'Failed to save template'}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        async function deleteEmailTemplate(templateId, templateName) {
            if (!confirm(`Are you sure you want to delete the template "${templateName}"?`)) {
                return;
            }

            try {
                const res = await fetch(`/api/email-templates?templateId=${templateId}`, {
                    method: 'DELETE'
                });

                const data = await res.json();

                if (data.success) {
                    alert('‚úÖ Template deleted successfully');
                    loadEmailTemplates();
                } else {
                    alert(`‚ùå Error: ${data.error || 'Failed to delete template'}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        async function editEmailTemplate(templateId) {
            try {
                const res = await fetch(`/api/email-templates?templateId=${templateId}`);
                const data = await res.json();

                if (!data.success || !data.template) {
                    alert('Error loading template');
                    return;
                }

                const template = data.template;
                window.editingTemplateId = templateId;

                showCreateTemplateModal();

                // Populate form after modal is created
                setTimeout(() => {
                    document.getElementById('templateName').value = template.templateName;
                    document.getElementById('templateSubject').value = template.subject;
                    document.getElementById('templateHtmlContent').value = template.htmlContent;
                    document.getElementById('templateCategory').value = template.category || '';
                }, 100);

            } catch (error) {
                alert(`Error loading template: ${error.message}`);
            }
        }

        // Update showTab to load templates
        const originalShowTabFinal = window.showTab;
        window.showTab = function(tab) {
            if (originalShowTabFinal) originalShowTabFinal(tab);
            if (tab === 'social' && !tokensLoaded) {
                loadSocialTokens();
                tokensLoaded = true;
            }
            if (tab === 'automation') {
                loadWorkflows();
            }
            if (tab === 'analytics') {
                loadAnalytics();
            }
            if (tab === 'email-templates') {
                loadEmailTemplates();
            }
        };
    </script>
</body>
</html>