<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TNR Social Media Automation Dashboard</title>
    <link rel="stylesheet" href="assets/social-media-automation.css">
    <style>
        .nav-header {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .nav-logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .nav-menu {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .nav-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background 0.2s;
            font-size: 0.95rem;
        }
        .nav-link:hover {
            background: rgba(255,255,255,0.1);
        }
        .nav-link.active {
            background: rgba(255,255,255,0.2);
        }
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                align-items: flex-start;
            }
            .nav-menu {
                width: 100%;
                flex-direction: column;
            }
            .nav-link {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <nav class="nav-header">
        <div class="nav-container">
            <div class="nav-logo">
                <span>üöÄ</span>
                <span>TNR Business Solutions</span>
            </div>
            <div class="nav-menu">
                <a href="/" class="nav-link">üè† Home</a>
                <a href="/admin-dashboard.html" class="nav-link">üìä Admin Dashboard</a>
                <a href="/social-media-automation-dashboard.html" class="nav-link active">üì± Social Media</a>
                <a href="/admin-login.html" class="nav-link">üîê Login</a>
            </div>
        </div>
    </nav>
    <div class="container">
        <div class="header">
            <h1>üöÄ Social Media Automation Dashboard</h1>
            <p>Streamline your social media marketing for TNR Business Solutions & Clients</p>
        </div>
        
        <div class="dashboard-grid">
            <!-- Meta OAuth Setup -->
            <div class="card">
                <h3><span class="card-icon">üîê</span>Meta (Facebook/Instagram) Setup</h3>
                
                <div id="metaConnectionStatus">
                    <div class="connection-status">
                        <p id="metaStatus">Not connected</p>
                    </div>
                </div>
                
                <button class="btn" onclick="connectMeta()">üîó Connect Facebook/Instagram</button>
                <button class="btn btn-secondary" onclick="window.manualTest = true; testMetaToken()">üß™ Test Token</button>
                
                <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; font-size: 0.9rem;">
                    <strong>üì∑ Need help connecting Instagram?</strong>
                    <p style="margin: 5px 0;">Make sure your Instagram account is Business or Creator, and it's connected to your Facebook Page.</p>
                    <a href="/INSTAGRAM_CONNECTION_GUIDE.md" target="_blank" style="color: #4CAF50; text-decoration: underline;">View complete Instagram connection guide ‚Üí</a>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="metaToken">Page Access Token (optional - for direct use):</label>
                    <input type="password" id="metaToken" placeholder="Paste your token here...">
                    <button class="btn" style="margin-top: 10px;" onclick="saveMetaToken()">üíæ Save Token</button>
                </div>
            </div>
            
            <!-- Twitter/X OAuth Setup -->
            <div class="card">
                <h3><span class="card-icon">üê¶</span>Twitter/X Setup</h3>
                
                <div id="twitterConnectionStatus">
                    <div class="connection-status">
                        <p id="twitterStatusText">Not connected</p>
                    </div>
                </div>
                
                <button class="btn" onclick="connectTwitter()" style="background: #1da1f2;">üîó Connect Twitter/X</button>
                <button class="btn btn-secondary" onclick="testTwitterConnection()">üß™ Test Connection</button>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="twitterToken">Bearer Token (optional - for direct use):</label>
                    <input type="password" id="twitterToken" placeholder="Paste your Bearer Token here...">
                    <button class="btn" style="margin-top: 10px;" onclick="saveTwitterToken()">üíæ Save Token</button>
                </div>
            </div>
            
            <!-- Content Generator -->
            <div class="card">
                <h3><span class="card-icon">üìù</span>Content Generator</h3>
                
                <div class="platform-tabs">
                    <div class="platform-tab active" onclick="switchPlatform('facebook', this)">Facebook</div>
                    <div class="platform-tab" onclick="switchPlatform('instagram', this)">Instagram</div>
                    <div class="platform-tab" onclick="switchPlatform('linkedin', this)">LinkedIn</div>
                    <div class="platform-tab" onclick="switchPlatform('twitter', this)">Twitter</div>
                </div>
                
                <div id="facebook" class="content-area active">
                    <div class="form-group">
                        <label for="contentType">Content Type</label>
                        <select id="contentType" name="contentType" aria-label="Select content type" onchange="toggleJobPostingFields()">
                            <option value="test-post">üß™ Test Post (First Post)</option>
                            <option value="service-promotion">Service Promotion</option>
                            <option value="client-success">Client Success Story</option>
                            <option value="industry-tip">Industry Tip</option>
                            <option value="behind-scenes">Behind the Scenes</option>
                            <option value="testimonial">Customer Testimonial</option>
                            <option value="how-to">How-To Guide</option>
                            <option value="question">Engagement Question</option>
                            <option value="did-you-know">Did You Know</option>
                            <option value="local-community">Local Community</option>
                            <option value="seasonal">Seasonal/Holiday</option>
                            <option value="job-posting">üíº Job Posting</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="clientBusinessName">Client/Business Name</label>
                        <input type="text" id="clientBusinessName" placeholder="e.g., TNR Business Solutions" value="TNR Business Solutions">
                    </div>
                    
                    <div class="form-group">
                        <label for="professionType">Industry Type</label>
                        <select id="professionType" name="professionType" aria-label="Select industry type">
                            <option value="digital-marketing">Digital Marketing Agency</option>
                            <option value="insurance">Insurance Services</option>
                            <option value="construction">Construction/Trades</option>
                            <option value="professional-services">Professional Services (Law, Accounting, Consulting)</option>
                            <option value="healthcare">Healthcare/Medical</option>
                            <option value="restaurant">Restaurant/Food Service</option>
                            <option value="retail">Retail Store</option>
                            <option value="real-estate">Real Estate</option>
                            <option value="automotive">Automotive Services</option>
                            <option value="home-services">Home Services (HVAC, Plumbing, Electric)</option>
                            <option value="fitness">Fitness/Wellness</option>
                            <option value="beauty">Beauty/Salon</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="serviceFocus">Service Focus</label>
                        <select id="serviceFocus" name="serviceFocus" aria-label="Select service focus">
                            <option value="seo">SEO Services</option>
                            <option value="web-design">Web Design</option>
                            <option value="social-media">Social Media</option>
                            <option value="insurance">Insurance</option>
                            <option value="paid-ads">Paid Advertising</option>
                            <option value="email-marketing">Email Marketing</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="targetAudience">Target Audience</label>
                        <select id="targetAudience" name="targetAudience" aria-label="Select target audience">
                            <option value="small-business">Small Business Owners</option>
                            <option value="local-residents">Local Residents</option>
                            <option value="insurance-seekers">Insurance Seekers</option>
                            <option value="marketing-managers">Marketing Managers</option>
                        </select>
                    </div>
                    
                    <!-- Job Posting Fields (shown only when job-posting is selected) -->
                    <div id="jobPostingFields" class="form-group" style="display: none;">
                        <label for="jobTitle">Job Title (optional)</label>
                        <input type="text" id="jobTitle" placeholder="e.g., Marketing Specialist, Sales Representative">
                    </div>
                    <div id="jobPostingEmailFields" class="form-group" style="display: none;">
                        <label for="jobEmail">Application Email (optional)</label>
                        <input type="email" id="jobEmail" placeholder="e.g., careers@yourcompany.com">
                    </div>
                    
                    <button class="btn" onclick="generateContent()">Generate Content</button>
                    
                    <div id="contentPreview" class="post-preview hidden" role="region" aria-label="Generated content preview">
                        <h4>Generated Post:</h4>
                        <textarea id="previewContent" rows="8" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 14px; line-height: 1.6; resize: vertical; min-height: 150px;" placeholder="Generated content will appear here. You can edit it before posting."></textarea>
                        <div style="text-align: right; margin-top: 5px; color: #666; font-size: 14px;">
                            <span id="facebookCharCountPreview">0</span> characters
                        </div>
                        <div class="hashtag-suggestions" id="hashtagSuggestions"></div>
                        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                            <button class="btn" onclick="postToFacebook()" style="flex: 1; min-width: 200px;">üì§ Post to Facebook</button>
                            <button class="btn" onclick="postToInstagram()" style="flex: 1; min-width: 200px; background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);">üì∏ Post to Instagram</button>
                        </div>
                        <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                            ‚ÑπÔ∏è <strong>Instagram Note:</strong> For best results, add an image URL below before posting to Instagram. Text-only posts work on Facebook but require an image for Instagram.
                        </p>
                        <div style="margin-top: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Image URL (optional for Facebook, required for Instagram):</label>
                            <input type="url" id="postImageUrl" placeholder="https://example.com/image.jpg" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                </div>
                
                <!-- Instagram Content Area -->
                <div id="instagram" class="content-area">
                    <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
                        <h4 style="color: #e1306c; margin-bottom: 15px;">üì∏ Instagram Content Generator</h4>
                        <p style="color: #666; margin-bottom: 15px;">
                            Instagram uses the same content generator as Facebook. Switch to the Facebook tab to create content, then use the "Post to Instagram" button.
                        </p>
                        <div style="padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; margin-bottom: 15px;">
                            <strong>‚ö†Ô∏è Instagram Requirements:</strong>
                            <ul style="margin: 10px 0 0 20px; color: #856404;">
                                <li>Images are required (Instagram doesn't allow text-only posts)</li>
                                <li>Your Instagram Business account must be connected to your Facebook Page</li>
                                <li>We're working on fixing the API connection</li>
                            </ul>
                        </div>
                        <button class="btn" onclick="switchPlatform('facebook', document.querySelector('.platform-tab'))" style="background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);">
                            ‚Üê Use Facebook Generator (Works for Instagram Too!)
                        </button>
                    </div>
                </div>
                
                <!-- LinkedIn Content Area -->
                <div id="linkedin" class="content-area" style="display: none;">
                    <div class="form-group">
                        <label for="contentTypeLinkedIn">Content Type</label>
                        <select id="contentTypeLinkedIn" name="contentTypeLinkedIn" aria-label="Select content type">
                            <option value="test-post">üß™ Test Post (First Post)</option>
                            <option value="service-promotion">Service Promotion</option>
                            <option value="client-success">Client Success Story</option>
                            <option value="industry-tip">Industry Tip</option>
                            <option value="behind-scenes">Behind the Scenes</option>
                            <option value="testimonial">Customer Testimonial</option>
                            <option value="how-to">How-To Guide</option>
                            <option value="question">Engagement Question</option>
                            <option value="did-you-know">Did You Know</option>
                            <option value="local-community">Local Community</option>
                            <option value="seasonal">Seasonal/Holiday</option>
                            <option value="professional-insight">Professional Insight</option>
                            <option value="industry-news">Industry News</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="clientBusinessNameLinkedIn">Client/Business Name</label>
                        <input type="text" id="clientBusinessNameLinkedIn" placeholder="e.g., TNR Business Solutions" value="TNR Business Solutions">
                    </div>
                    
                    <div class="form-group">
                        <label for="professionTypeLinkedIn">Industry Type</label>
                        <select id="professionTypeLinkedIn" name="professionTypeLinkedIn" aria-label="Select industry type">
                            <option value="digital-marketing">Digital Marketing Agency</option>
                            <option value="insurance">Insurance Services</option>
                            <option value="construction">Construction/Trades</option>
                            <option value="professional-services">Professional Services (Law, Accounting, Consulting)</option>
                            <option value="healthcare">Healthcare/Medical</option>
                            <option value="restaurant">Restaurant/Food Service</option>
                            <option value="retail">Retail Store</option>
                            <option value="real-estate">Real Estate</option>
                            <option value="automotive">Automotive Services</option>
                            <option value="home-services">Home Services (HVAC, Plumbing, Electric)</option>
                            <option value="fitness">Fitness/Wellness</option>
                            <option value="beauty">Beauty/Salon</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="serviceFocusLinkedIn">Service Focus</label>
                        <select id="serviceFocusLinkedIn" name="serviceFocusLinkedIn" aria-label="Select service focus">
                            <option value="seo">SEO Services</option>
                            <option value="web-design">Web Design</option>
                            <option value="social-media">Social Media</option>
                            <option value="insurance">Insurance</option>
                            <option value="paid-ads">Paid Advertising</option>
                            <option value="email-marketing">Email Marketing</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="targetAudienceLinkedIn">Target Audience</label>
                        <select id="targetAudienceLinkedIn" name="targetAudienceLinkedIn" aria-label="Select target audience">
                            <option value="small-business">Small Business Owners</option>
                            <option value="local-residents">Local Residents</option>
                            <option value="insurance-seekers">Insurance Seekers</option>
                            <option value="marketing-managers">Marketing Managers</option>
                            <option value="professionals">Professionals</option>
                            <option value="entrepreneurs">Entrepreneurs</option>
                        </select>
                    </div>
                    
                    <button class="btn" onclick="generateLinkedInContent()" style="background: #0077b5;">Generate LinkedIn Content</button>
                    
                    <div id="contentPreviewLinkedIn" class="post-preview hidden" role="region" aria-label="Generated LinkedIn content preview">
                        <h4>Generated LinkedIn Post:</h4>
                        <textarea id="previewContentLinkedIn" rows="10" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 14px; line-height: 1.6; resize: vertical; min-height: 200px; white-space: pre-wrap;" placeholder="Generated content will appear here. You can edit it before posting."></textarea>
                        <div style="margin-top: 10px; padding: 10px; background: #f0f7ff; border-radius: 4px; font-size: 0.9rem; color: #0077b5;">
                            <strong>Character Count:</strong> <span id="linkedInCharCountPreview">0</span> characters
                            <br><small>LinkedIn posts can be up to 3,000 characters. Professional, longer-form content performs well.</small>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                            <button class="btn" onclick="postGeneratedToLinkedIn()" style="flex: 1; min-width: 200px; background: #0077b5;">üíº Post to LinkedIn</button>
                            <button class="btn btn-secondary" onclick="copyLinkedInContent()" style="flex: 1; min-width: 200px;">üìã Copy Content</button>
                        </div>
                    </div>
                </div>
                
                <!-- Twitter Content Area -->
                <div id="twitter" class="content-area" style="display: none;">
                    <div class="form-group">
                        <label for="contentTypeTwitter">Content Type</label>
                        <select id="contentTypeTwitter" name="contentTypeTwitter" aria-label="Select content type">
                            <option value="test-post">üß™ Test Post (First Post)</option>
                            <option value="service-promotion">Service Promotion</option>
                            <option value="client-success">Client Success Story</option>
                            <option value="industry-tip">Industry Tip</option>
                            <option value="behind-scenes">Behind the Scenes</option>
                            <option value="testimonial">Customer Testimonial</option>
                            <option value="how-to">How-To Guide</option>
                            <option value="question">Engagement Question</option>
                            <option value="did-you-know">Did You Know</option>
                            <option value="local-community">Local Community</option>
                            <option value="seasonal">Seasonal/Holiday</option>
                            <option value="job-posting">üíº Job Posting</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="clientBusinessNameTwitter">Client/Business Name</label>
                        <input type="text" id="clientBusinessNameTwitter" placeholder="e.g., TNR Business Solutions" value="TNR Business Solutions">
                    </div>
                    
                    <div class="form-group">
                        <label for="professionTypeTwitter">Industry Type</label>
                        <select id="professionTypeTwitter" name="professionTypeTwitter" aria-label="Select industry type">
                            <option value="digital-marketing">Digital Marketing Agency</option>
                            <option value="insurance">Insurance Services</option>
                            <option value="construction">Construction/Trades</option>
                            <option value="professional-services">Professional Services (Law, Accounting, Consulting)</option>
                            <option value="healthcare">Healthcare/Medical</option>
                            <option value="restaurant">Restaurant/Food Service</option>
                            <option value="retail">Retail Store</option>
                            <option value="real-estate">Real Estate</option>
                            <option value="automotive">Automotive Services</option>
                            <option value="home-services">Home Services (HVAC, Plumbing, Electric)</option>
                            <option value="fitness">Fitness/Gym</option>
                            <option value="beauty">Beauty/Salon</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="serviceFocusTwitter">Service Focus</label>
                        <select id="serviceFocusTwitter" name="serviceFocusTwitter" aria-label="Select service focus">
                            <option value="seo">SEO Services</option>
                            <option value="web-design">Web Design</option>
                            <option value="social-media">Social Media Management</option>
                            <option value="paid-advertising">Paid Advertising</option>
                            <option value="email-marketing">Email Marketing</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="targetAudienceTwitter">Target Audience</label>
                        <select id="targetAudienceTwitter" name="targetAudienceTwitter" aria-label="Select target audience">
                            <option value="small-business">Small Business Owners</option>
                            <option value="local-residents">Local Residents</option>
                            <option value="insurance-seekers">Insurance Seekers</option>
                            <option value="marketing-managers">Marketing Managers</option>
                        </select>
                    </div>
                    
                    <button class="btn" onclick="generateTwitterContent()" style="background: #1da1f2;">Generate Content</button>
                    
                    <div id="contentPreviewTwitter" class="post-preview hidden" role="region" aria-label="Generated content preview">
                        <h4>Generated Tweet:</h4>
                        <textarea id="previewContentTwitter" rows="6" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 14px; line-height: 1.6; resize: vertical; min-height: 120px;" placeholder="Generated content will appear here. You can edit it before posting."></textarea>
                        <div style="text-align: right; margin-top: 5px; color: #666; font-size: 14px;">
                            <span id="twitterCharCountPreview">0</span>/280 characters
                        </div>
                        <div class="hashtag-suggestions" id="hashtagSuggestionsTwitter"></div>
                        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                            <button class="btn" onclick="postGeneratedToTwitter()" style="flex: 1; min-width: 200px; background: #1da1f2;">üê¶ Post to Twitter/X</button>
                            <button class="btn btn-secondary" onclick="testTwitterConnection()">üß™ Test Connection</button>
                        </div>
                        <div id="twitterStatus" style="margin-top: 15px; padding: 12px; border-radius: 4px; display: none;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Post Scheduler -->
            <div class="card">
                <h3><span class="card-icon">üìÖ</span>Post Scheduler</h3>
                
                <div class="form-group">
                    <label for="schedulePlatform">Platform</label>
                    <select id="schedulePlatform" name="schedulePlatform" aria-label="Select platform">
                        <option value="facebook">Facebook</option>
                        <option value="instagram">Instagram</option>
                        <option value="linkedin">LinkedIn</option>
                        <option value="twitter">Twitter</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="scheduleContent">Post Content</label>
                    <textarea id="scheduleContent" name="scheduleContent" rows="4" placeholder="Enter your post content..." aria-label="Enter post content"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="scheduleDateTime">Schedule Date & Time</label>
                    <input type="datetime-local" id="scheduleDateTime" name="scheduleDateTime" aria-label="Select date and time">
                </div>
                
                <div class="form-group">
                    <label for="scheduleClient">Client (Optional)</label>
                    <select id="scheduleClient" name="scheduleClient" aria-label="Select client">
                        <option value="tnr">TNR Business Solutions</option>
                        <option value="client1">Client 1</option>
                        <option value="client2">Client 2</option>
                    </select>
                </div>
                
                <button class="btn" onclick="schedulePostReal()">Schedule Post (Real API)</button>
                <button class="btn btn-secondary" onclick="schedulePost()">Schedule Post (CSV Export)</button>
                
                <div id="scheduledPosts" class="schedule-grid"></div>
            </div>
            
            <!-- Hashtag Research -->
            <div class="card">
                <h3><span class="card-icon">#Ô∏è‚É£</span>Hashtag Research</h3>
                
                <div class="form-group">
                    <label for="hashtagIndustry">Industry/Service</label>
                    <select id="hashtagIndustry" name="hashtagIndustry" aria-label="Select industry or service">
                        <option value="digital-marketing">Digital Marketing</option>
                        <option value="insurance">Insurance</option>
                        <option value="web-design">Web Design</option>
                        <option value="seo">SEO</option>
                        <option value="social-media">Social Media</option>
                        <option value="local-business">Local Business</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="hashtagLocation">Location</label>
                    <input type="text" id="hashtagLocation" name="hashtagLocation" value="Greensburg PA" placeholder="Enter location" aria-label="Enter location">
                </div>
                
                <button class="btn" onclick="generateHashtags()">Generate Hashtags</button>
                
                <div id="hashtagResults" class="hashtag-suggestions"></div>
            </div>
            
            <!-- Client Management -->
            <div class="card">
                <h3><span class="card-icon">üë•</span>Client Management</h3>
                
                <div class="form-group">
                    <label for="newClientName">Add New Client</label>
                    <input type="text" id="newClientName" name="newClientName" placeholder="Client Name" aria-label="Enter client name">
                </div>
                
                <div class="form-group">
                    <label for="clientServices">Services</label>
                    <select id="clientServices" name="clientServices" multiple aria-label="Select services">
                        <option value="facebook">Facebook Management</option>
                        <option value="instagram">Instagram Management</option>
                        <option value="linkedin">LinkedIn Management</option>
                        <option value="content-creation">Content Creation</option>
                        <option value="scheduling">Post Scheduling</option>
                    </select>
                </div>
                
                <button class="btn" onclick="addClient()">Add Client</button>
                
                <div class="client-list" id="clientList">
                    <div class="client-item">
                        <div>
                            <div class="client-name">TNR Business Solutions</div>
                            <div class="client-services-text">All Platforms</div>
                        </div>
                        <span class="client-status status-active">Active</span>
                    </div>
                </div>
            </div>
            
            <!-- API Configuration -->
            <div class="card">
                <h3><span class="card-icon">üîß</span>API Configuration</h3>
                
                <div id="connectionStatus">
                    <div class="connection-status">
                        <h4>API Connection Status</h4>
                        <p>Configured: <span id="configStatus">‚ùå No</span></p>
                        <p>Meta (FB/IG): <span id="metaConnected">‚ùå</span></p>
                        <p>LinkedIn: <span id="linkedinConnected">‚ùå</span></p>
                        <p>Twitter: <span id="twitterConnected">‚ùå</span></p>
                    </div>
                </div>
                
                <button class="btn" onclick="showApiConfig()">Configure API Keys</button>
                <a href="real-automation-setup.html" class="btn btn-secondary">Advanced Setup ‚Üí</a>
            </div>
            
            <!-- Analytics Dashboard -->
            <div class="card" id="facebookInsightsCard">
                <h3><span class="card-icon">üìä</span>Meta Insights (Live)</h3>

                <div id="insightsEmptyState" class="insights-empty">
                    Connect Facebook to unlock live reach, impression, and engagement analytics.
                </div>

                <div id="insightsContent" class="insights-content hidden" aria-live="polite">
                    <div class="insights-header">
                        <div>
                            <h4 id="insightsPageName" style="margin-bottom: 4px;">Facebook Page</h4>
                            <div class="stat-label" id="insightsDateRange">Last 7 days</div>
                            <div class="stat-label" id="insightsLastUpdated">Not updated yet</div>
                        </div>
                        <div class="insights-meta">
                            <span id="insightsFanCount">Fans: --</span>
                            <span id="insightsFollowerCount">Followers: --</span>
                            <span id="insightsInstagramStatus">Instagram: --</span>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="reachTotal">--</div>
                            <div class="stat-label">7-Day Reach</div>
                            <div class="stat-change flat" id="reachChange">Waiting for data‚Ä¶</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="impressionsTotal">--</div>
                            <div class="stat-label">7-Day Impressions</div>
                            <div class="stat-change flat" id="impressionsChange">Waiting for data‚Ä¶</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="engagementsTotal">--</div>
                            <div class="stat-label">Post Engagements</div>
                            <div class="stat-change flat" id="engagementsChange">Waiting for data‚Ä¶</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="newFollowersTotal">--</div>
                            <div class="stat-label">New Followers</div>
                            <div class="stat-change flat" id="newFollowersChange">Waiting for data‚Ä¶</div>
                        </div>
                    </div>

                    <div class="insights-chart" aria-label="7 day reach chart">
                        <div class="insights-chart-bars" id="insightsChartBars">
                            <!-- Bars generated dynamically -->
                        </div>
                        <div class="insights-chart-axis" id="insightsChartAxis"></div>
                    </div>

                    <div class="insights-summary" id="insightsSummary">
                        Live insights will appear here once you connect your Facebook Page.
                    </div>
                </div>

                <div id="insightsError" class="insights-error hidden"></div>
            </div>
            
            <!-- Content Calendar -->
            <div class="card">
                <h3><span class="card-icon">üìÜ</span>Content Calendar</h3>
                
                <div class="form-group">
                    <label for="calendarView">View</label>
                    <select id="calendarView" name="calendarView" aria-label="Select calendar view">
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                    </select>
                </div>
                
                <div id="calendarContent">
                    <div class="schedule-item">
                        <div class="schedule-time">Today 9:00 AM</div>
                        <div class="schedule-content">Facebook: SEO Tips for Local Businesses</div>
                    </div>
                    <div class="schedule-item">
                        <div class="schedule-time">Today 2:00 PM</div>
                        <div class="schedule-content">Instagram: Behind the Scenes at TNR</div>
                    </div>
                    <div class="schedule-item">
                        <div class="schedule-time">Tomorrow 10:00 AM</div>
                        <div class="schedule-content">LinkedIn: Insurance Industry Insights</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="social-media-csv-export.js"></script>
    <script src="social-media-api-integration.js"></script>
    <script>
        // Check admin authentication
        if (sessionStorage.getItem('adminAuthenticated') !== 'true') {
            // For now, auto-authenticate for testing
            sessionStorage.setItem('adminAuthenticated', 'true');
        }
        
        // Character counter for Twitter
        document.addEventListener('DOMContentLoaded', function() {
            const twitterContent = document.getElementById('twitterContent');
            const twitterCharCount = document.getElementById('twitterCharCount');
            
            if (twitterContent && twitterCharCount) {
                twitterContent.addEventListener('input', function() {
                    const length = this.value.length;
                    twitterCharCount.textContent = length;
                    
                    if (length > 280) {
                        twitterCharCount.style.color = '#dc3545';
                    } else if (length > 250) {
                        twitterCharCount.style.color = '#ffc107';
                    } else {
                        twitterCharCount.style.color = '#666';
                    }
                });
            }
        });
        
        // Meta OAuth Functions
        function connectMeta() {
            // Redirect to Meta OAuth flow
            window.location.href = '/auth/meta';
        }
        
        // Twitter/X OAuth Functions
        function connectTwitter() {
            // Redirect to Twitter OAuth flow
            window.location.href = '/api/auth/twitter';
        }
        
        async function testTwitterConnection() {
            const statusDiv = document.getElementById('twitterStatus');
            const statusText = document.getElementById('twitterStatusText');
            
            try {
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#fff3cd';
                    statusDiv.style.color = '#856404';
                    statusDiv.textContent = 'Testing connection...';
                }
                
                // Get tokens from database
                const response = await fetch('/api/social-tokens?platform=twitter');
                const data = await response.json();
                
                if (!data.success || !data.tokens || data.tokens.length === 0) {
                    if (statusDiv) {
                        statusDiv.style.background = '#f8d7da';
                        statusDiv.style.color = '#721c24';
                        statusDiv.textContent = '‚ùå No Twitter/X token found. Please connect your account first.';
                    }
                    if (statusText) statusText.textContent = 'Not connected';
                    return;
                }
                
                // Test the first token
                const token = data.tokens[0];
                const testResponse = await fetch('/api/social-tokens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'test',
                        tokenId: token.id,
                        platform: 'twitter'
                    })
                });
                
                const testData = await testResponse.json();
                
                if (testData.success && testData.valid) {
                    if (statusDiv) {
                        statusDiv.style.background = '#d4edda';
                        statusDiv.style.color = '#155724';
                        statusDiv.textContent = `‚úÖ Connection successful! Connected as: ${testData.account?.username || token.page_name || 'Twitter User'}`;
                    }
                    if (statusText) statusText.innerHTML = `‚úÖ Connected: ${testData.account?.username ? '@' + testData.account.username : token.page_name || 'Twitter User'}`;
                    if (document.getElementById('twitterConnected')) {
                        document.getElementById('twitterConnected').textContent = '‚úÖ';
                    }
                } else {
                    if (statusDiv) {
                        statusDiv.style.background = '#f8d7da';
                        statusDiv.style.color = '#721c24';
                        let errorHtml = `<strong>${testData.message || 'Connection failed'}</strong><br>${testData.error || 'Invalid token'}`;
                        if (testData.help) {
                            errorHtml += `<br><br><small style="opacity: 0.8;">üí° ${testData.help}</small>`;
                        }
                        statusDiv.innerHTML = errorHtml;
                    }
                    if (statusText) statusText.textContent = 'Connection failed';
                }
            } catch (error) {
                if (statusDiv) {
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    statusDiv.textContent = `‚ùå Error: ${error.message}`;
                }
                if (statusText) statusText.textContent = 'Error';
                console.error('Twitter connection test error:', error);
            }
        }
        
        async function postToTwitter() {
            const content = document.getElementById('twitterContent')?.value.trim();
            const hashtags = document.getElementById('twitterHashtags')?.value.trim();
            const statusDiv = document.getElementById('twitterStatus');
            
            if (!content) {
                alert('Please enter tweet content');
                return;
            }
            
            // Combine content and hashtags
            let tweetText = content;
            if (hashtags) {
                tweetText += ' ' + hashtags;
            }
            
            // Check character limit
            if (tweetText.length > 280) {
                alert(`Tweet is too long (${tweetText.length}/280 characters). Please shorten it.`);
                return;
            }
            
            try {
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#fff3cd';
                    statusDiv.style.color = '#856404';
                    statusDiv.textContent = 'Posting to Twitter/X...';
                }
                
                const response = await fetch('/api/post-to-twitter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: tweetText,
                        useDatabaseToken: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (statusDiv) {
                        statusDiv.style.background = '#d4edda';
                        statusDiv.style.color = '#155724';
                        statusDiv.innerHTML = `‚úÖ Tweet posted successfully!<br><a href="${data.tweetUrl}" target="_blank" style="color: #155724; text-decoration: underline;">View Tweet ‚Üí</a>`;
                    }
                    
                    // Clear form
                    const contentEl = document.getElementById('twitterContent');
                    const hashtagsEl = document.getElementById('twitterHashtags');
                    const charCountEl = document.getElementById('twitterCharCount');
                    if (contentEl) contentEl.value = '';
                    if (hashtagsEl) hashtagsEl.value = '';
                    if (charCountEl) charCountEl.textContent = '0';
                } else {
                    if (statusDiv) {
                        statusDiv.style.background = '#f8d7da';
                        statusDiv.style.color = '#721c24';
                        
                        let errorMsg = `‚ùå Failed to post: ${data.message || data.error || 'Unknown error'}`;
                        
                        // Add helpful guidance for permission errors
                        if (data.help) {
                            errorMsg += '\n\n' + data.help.title + ':\n';
                            if (data.help.steps) {
                                errorMsg += data.help.steps.join('\n');
                            } else if (data.help.solution) {
                                errorMsg += data.help.solution;
                            }
                        }
                        
                        statusDiv.textContent = errorMsg;
                        statusDiv.style.whiteSpace = 'pre-line';
                    }
                }
            } catch (error) {
                if (statusDiv) {
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    statusDiv.textContent = `‚ùå Error: ${error.message}`;
                }
                console.error('Twitter post error:', error);
            }
        }
        
        async function saveTwitterToken() {
            const tokenInput = document.getElementById('twitterToken');
            const token = tokenInput?.value.trim();
            
            if (!token) {
                alert('Please enter a Bearer Token');
                return;
            }
            
            try {
                console.log('Saving Twitter token...', { tokenLength: token.length });
                
                const response = await fetch('/api/social-tokens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'save',
                        platform: 'twitter',
                        access_token: token,
                        page_name: 'TNR Business Solutions (@TNRBusinessSol)',
                        token_type: 'Bearer'
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Save token failed - HTTP error:', response.status, errorText);
                    try {
                        const errorData = JSON.parse(errorText);
                        alert(`‚ùå Failed to save token: ${errorData.error || errorData.message || 'Server error'}`);
                        console.error('Error details:', errorData);
                    } catch (e) {
                        alert(`‚ùå Failed to save token: HTTP ${response.status}`);
                        console.error('Error response:', errorText);
                    }
                    return;
                }
                
                const data = await response.json();
                console.log('Save token response:', data);
                console.log('Response details:', {
                    success: data.success,
                    message: data.message,
                    error: data.error,
                    token: data.token
                });
                console.log('Full response object:', JSON.stringify(data, null, 2));
                
                if (data.success) {
                    alert('‚úÖ Twitter/X token saved successfully!');
                    if (tokenInput) tokenInput.value = '';
                    // Refresh connection status
                    setTimeout(() => {
                        loadTwitterConnectionStatus();
                    }, 500);
                } else {
                    const errorMsg = data.error || data.message || 'Unknown error';
                    alert(`‚ùå Failed to save token: ${errorMsg}`);
                    console.error('Save failed:', data);
                    console.error('Full error details:', JSON.stringify(data, null, 2));
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
                console.error('Save Twitter token error:', error);
            }
        }
        
        // Helper function to get Meta token from database
        async function getMetaTokenFromDatabase() {
            try {
                const response = await fetch('/api/social/tokens?action=get', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ platform: 'facebook' })
                });
                
                const data = await response.json();
                if (data.success && data.token) {
                    return data.token.access_token;
                }
            } catch (error) {
                console.error('Error loading token from database:', error);
            }
            return null;
        }
        
        async function testMetaToken() {
            const tokenInput = document.getElementById('metaToken');
            let token = tokenInput ? tokenInput.value.trim() : '';
            
            // If no token in input, try to get from database
            if (!token) {
                token = await getMetaTokenFromDatabase();
            }
            
            // Fallback to localStorage only if database doesn't have token
            if (!token) {
                token = localStorage.getItem('metaPageAccessToken');
            }
            
            if (!token) {
                console.log('No token found');
                return null;
            }
            
            console.log('Testing token...');
            
            try {
                const response = await fetch('/api/social/test-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pageAccessToken: token })
                });
                
                const data = await response.json();
                console.log('Token test result:', data);
                
                if (data.success) {
                    const metaStatus = document.getElementById('metaStatus');
                    const metaConnected = document.getElementById('metaConnected');
                    const configStatus = document.getElementById('configStatus');
                    
                    console.log('Instagram data:', data.instagram);
                    
                    // Check token expiration
                    if (data.tokenInfo && data.tokenInfo.expires_at) {
                        const expiresAt = new Date(data.tokenInfo.expires_at * 1000);
                        const now = new Date();
                        const daysUntilExpiry = Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24));
                        
                        console.log(`Token expires in ${daysUntilExpiry} days (${expiresAt.toLocaleDateString()})`);
                        
                        // Warn if expiring soon
                        if (daysUntilExpiry < 7 && window.manualTest) {
                            alert(`‚ö†Ô∏è Token Warning!\n\nYour Facebook token expires in ${daysUntilExpiry} days (${expiresAt.toLocaleDateString()}).\n\nReconnect Facebook soon to avoid interruption.`);
                        }
                    }
                    
                    if (metaStatus) {
                        const igStatus = data.instagram 
                            ? `üì∑ Instagram: @${data.instagram.username}` 
                            : '‚ùå No Instagram connected';
                        metaStatus.innerHTML = `‚úÖ Connected to: ${data.page.name}<br>${igStatus}`;
                        console.log('Updated metaStatus:', igStatus);
                    }
                    if (metaConnected) metaConnected.textContent = '‚úÖ';
                    if (configStatus) configStatus.textContent = '‚úÖ Yes';

                    if (data.page?.id) {
                        localStorage.setItem('metaPageId', data.page.id);
                    }
                    
                    // Store Instagram connection status
                    window.metaConnectionData = data;
                    
                    loadMetaInsights(token, data.page?.id);
                    
                    // Only show alert if manually clicked (not on auto-load)
                    if (window.manualTest) {
                        const igInfo = data.instagram 
                            ? `Instagram: @${data.instagram.username} (${data.instagram.followersCount || 0} followers)` 
                            : 'No Instagram connected';
                        alert(`‚úÖ Token Valid!\n\nPage: ${data.page.name}\n${igInfo}`);
                    }
                    
                    return data; // Return data for use in other functions
                } else {
                    console.error('Token invalid:', data.message);
                    
                    // Handle specific error codes
                    if (data.errorCode === 190) {
                        // Token expired or invalidated
                        console.log('Token expired (code 190), clearing stored token');
                        localStorage.removeItem('metaPageAccessToken');
                        localStorage.removeItem('metaPageId');
                        
                        if (window.manualTest || data.message.includes('expired')) {
                            if (confirm('üî¥ Your Facebook token has expired!\n\nWould you like to reconnect now?')) {
                                connectMeta();
                            }
                        }
                    }
                    
                    showInsightsDisconnected(data.message);
                    if (window.manualTest) {
                        alert('‚ùå Token Invalid: ' + data.message);
                    }
                    return null;
                }
            } catch (error) {
                console.error('Token test error:', error);
                showInsightsDisconnected(error.message);
                if (window.manualTest) {
                    alert('‚ùå Error testing token: ' + error.message);
                }
                return null;
            }
        }
        
        function formatCompactNumber(value) {
            if (value === null || value === undefined || Number.isNaN(value)) return '--';
            return Intl.NumberFormat(undefined, { notation: 'compact', maximumFractionDigits: 1 }).format(value);
        }
        
        function formatFullNumber(value) {
            if (value === null || value === undefined || Number.isNaN(value)) return '--';
            return Intl.NumberFormat(undefined, { maximumFractionDigits: 0 }).format(Math.round(value));
        }
        
        function formatShortDate(dateString) {
            const date = new Date(dateString);
            if (Number.isNaN(date.getTime())) return '';
            return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
        }
        
        function formatTimeStamp(timestamp) {
            if (!timestamp) return 'Just now';
            const date = new Date(timestamp);
            if (Number.isNaN(date.getTime())) return 'Just now';
            return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        }
        
        function formatDateRange(range) {
            if (!range?.since || !range?.until) return 'Last 7 days';
            const since = new Date(range.since);
            const until = new Date(range.until);
            if (Number.isNaN(since.getTime()) || Number.isNaN(until.getTime())) return 'Last 7 days';
            const sinceText = since.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
            const untilText = until.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
            return `${sinceText} ‚Äì ${untilText}`;
        }
        
        function updateStatCard(numberId, changeId, metric) {
            const numberEl = document.getElementById(numberId);
            const changeEl = document.getElementById(changeId);

            if (numberEl) {
                if (metric && Number.isFinite(metric.total)) {
                    numberEl.textContent = formatCompactNumber(metric.total);
                    numberEl.title = `${formatFullNumber(metric.total)} total`;
                } else {
                    numberEl.textContent = '--';
                    numberEl.removeAttribute('title');
                }
            }

            if (changeEl) {
                let text = 'No prior data';
                let className = 'stat-change flat';
                if (metric && metric.previous !== null && metric.change !== null) {
                    const symbol = metric.direction === 'up' ? '‚ñ≤' : metric.direction === 'down' ? '‚ñº' : '‚Ä¢';
                    const directionClass = metric.direction === 'up' ? 'positive' : metric.direction === 'down' ? 'negative' : 'flat';
                    text = `${symbol} ${Math.abs(metric.change)}% vs prev day`;
                    className = `stat-change ${directionClass}`;
                }
                changeEl.textContent = text;
                changeEl.className = className;
            }
        }
        
        function renderInsightsChart(series) {
            const barsEl = document.getElementById('insightsChartBars');
            const axisEl = document.getElementById('insightsChartAxis');
            if (!barsEl || !axisEl) return;

            barsEl.innerHTML = '';
            axisEl.innerHTML = '';

            if (!Array.isArray(series) || !series.length) {
                const emptyState = document.createElement('p');
                emptyState.className = 'stat-label';
                emptyState.style.margin = '0 auto';
                emptyState.textContent = 'No recent reach data available.';
                barsEl.appendChild(emptyState);
                return;
            }

            const maxValue = Math.max(...series.map(point => point.value));
            series.forEach(point => {
                const bar = document.createElement('div');
                bar.className = 'insights-chart-bar';
                const height = maxValue === 0 ? 0 : Math.max(4, Math.round((point.value / maxValue) * 100));
                bar.style.height = `${height}%`;
                const label = formatShortDate(point.date);
                bar.title = `${label}: ${formatFullNumber(point.value)}`;
                bar.setAttribute('aria-label', `${label}: ${formatFullNumber(point.value)}`);
                barsEl.appendChild(bar);

                const axisLabel = document.createElement('span');
                axisLabel.textContent = label;
                axisEl.appendChild(axisLabel);
            });
        }
        
        function showInsightsDisconnected(message) {
            const emptyState = document.getElementById('insightsEmptyState');
            const content = document.getElementById('insightsContent');
            const errorEl = document.getElementById('insightsError');
            const card = document.getElementById('facebookInsightsCard');

            if (card) card.classList.remove('loading');
            if (content) content.classList.add('hidden');
            if (emptyState) {
                emptyState.textContent = message || 'Connect Facebook to unlock live analytics.';
                emptyState.classList.remove('hidden');
            }
            if (errorEl) {
                if (message) {
                    errorEl.textContent = message;
                    errorEl.classList.remove('hidden');
                } else {
                    errorEl.classList.add('hidden');
                }
            }
        }
        
        async function loadMetaInsights(pageAccessToken, pageId) {
            const card = document.getElementById('facebookInsightsCard');
            const emptyState = document.getElementById('insightsEmptyState');
            const content = document.getElementById('insightsContent');
            const errorEl = document.getElementById('insightsError');

            if (!card || !pageAccessToken) return;

            if (emptyState) {
                emptyState.textContent = 'Loading live insights‚Ä¶';
                emptyState.classList.remove('hidden');
            }
            if (content) content.classList.add('hidden');
            if (errorEl) errorEl.classList.add('hidden');
            card.classList.add('loading');

            try {
                const response = await fetch('/api/social/get-insights', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pageAccessToken, pageId })
                });

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message || 'Unable to fetch insights.');
                }

                window.metaInsightsData = data;

                if (content) content.classList.remove('hidden');
                if (emptyState) emptyState.classList.add('hidden');
                if (errorEl) errorEl.classList.add('hidden');
                card.classList.remove('loading');

                const pageNameEl = document.getElementById('insightsPageName');
                if (pageNameEl) pageNameEl.textContent = data.page?.name || 'Facebook Page';

                const dateRangeEl = document.getElementById('insightsDateRange');
                if (dateRangeEl) dateRangeEl.textContent = `Last ${data.timeseries?.reach?.length || 7} days ‚Ä¢ ${formatDateRange(data.dateRange)}`;

                const updatedEl = document.getElementById('insightsLastUpdated');
                if (updatedEl) updatedEl.textContent = `Updated ${formatTimeStamp(data.fetchedAt)}`;

                const fansEl = document.getElementById('insightsFanCount');
                if (fansEl) fansEl.textContent = data.page?.fanCount !== undefined ? `${formatFullNumber(data.page.fanCount)} Fans` : 'Fans: --';

                const followersEl = document.getElementById('insightsFollowerCount');
                if (followersEl) followersEl.textContent = data.page?.followersCount !== undefined ? `${formatFullNumber(data.page.followersCount)} Followers` : 'Followers: --';

                const igEl = document.getElementById('insightsInstagramStatus');
                if (igEl) igEl.textContent = data.page?.hasInstagram ? 'Instagram: Connected' : 'Instagram: Not connected';

                updateStatCard('reachTotal', 'reachChange', data.metrics?.reach);
                updateStatCard('impressionsTotal', 'impressionsChange', data.metrics?.impressions);
                updateStatCard('engagementsTotal', 'engagementsChange', data.metrics?.engagements);
                updateStatCard('newFollowersTotal', 'newFollowersChange', data.metrics?.newFollowers);

                const reachSeries = data.timeseries?.reach?.length ? data.timeseries.reach : data.timeseries?.impressions || [];
                renderInsightsChart(reachSeries);

                const summaryEl = document.getElementById('insightsSummary');
                if (summaryEl) {
                    const summaryParts = [];
                    if (data.metrics?.reach) summaryParts.push(`${formatFullNumber(data.metrics.reach.total)} reached`);
                    if (data.metrics?.engagements) summaryParts.push(`${formatFullNumber(data.metrics.engagements.total)} engagements`);
                    if (data.metrics?.newFollowers) summaryParts.push(`${formatFullNumber(data.metrics.newFollowers.total)} new followers`);
                    if (typeof data.engagementRate === 'number') summaryParts.push(`Engagement rate ${data.engagementRate}%`);
                    summaryEl.textContent = summaryParts.length
                        ? `Past ${reachSeries.length || 7} days: ${summaryParts.join(' ¬∑ ')}.`
                        : 'No insights available for this period.';
                }
            } catch (error) {
                console.error('loadMetaInsights error:', error);
                if (errorEl) {
                    errorEl.textContent = error.message || 'Unable to load insights. Please verify your Page token includes insights permissions.';
                    errorEl.classList.remove('hidden');
                }
                showInsightsDisconnected(error.message);
            } finally {
                const finalCard = document.getElementById('facebookInsightsCard');
                if (finalCard) finalCard.classList.remove('loading');
            }
        }
        
        async function saveMetaToken() {
            const metaTokenInput = document.getElementById('metaToken');
            const token = metaTokenInput ? metaTokenInput.value.trim() : '';
            if (token) {
                // Save to database via API
                try {
                    const response = await fetch('/api/social/tokens?action=save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            platform: 'facebook',
                            access_token: token,
                            token_type: 'Bearer'
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        // Also save to localStorage as backup
                        localStorage.setItem('metaPageAccessToken', token);
                        alert('‚úÖ Token saved to database! Now test it to verify.');
                        testMetaToken();
                    } else {
                        alert('‚ùå Failed to save token: ' + (data.error || data.message));
                    }
                } catch (error) {
                    console.error('Error saving token:', error);
                    // Fallback to localStorage if API fails
                    localStorage.setItem('metaPageAccessToken', token);
                    alert('‚ö†Ô∏è Saved to local storage (database save failed). Token will work but may not persist.');
                    testMetaToken();
                }
            } else {
                alert('Please paste your token first');
            }
        }
        
        async function postToFacebook() {
            const content = document.getElementById('previewContent').value.trim();
            const imageUrl = document.getElementById('postImageUrl').value.trim();
            
            // Try to get token from database first
            let token = await getMetaTokenFromDatabase();
            
            // Fallback to localStorage if database doesn't have token
            if (!token) {
                token = localStorage.getItem('metaPageAccessToken');
            }
            
            if (!token) {
                if (confirm('No token saved. Would you like to connect Facebook now?')) {
                    connectMeta();
                }
                return;
            }
            
            if (!content) {
                alert('Please generate content first');
                return;
            }
            
            // Validate token before posting
            const tokenData = await testMetaToken();
            if (!tokenData) {
                if (confirm('‚ùå Token validation failed!\n\nWould you like to reconnect Facebook now?')) {
                    connectMeta();
                }
                return;
            }
            
            try {
                const postData = {
                    pageAccessToken: token,
                    message: content
                };
                
                // Add image URL if provided
                if (imageUrl) {
                    postData.imageUrl = imageUrl;
                }
                
                const response = await fetch('/api/social/post-to-facebook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(postData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (confirm('üéâ Post published successfully!\n\nWould you like to view it on Facebook?')) {
                        window.open(data.postUrl, '_blank');
                    }
                } else {
                    // Handle specific errors
                    let errorMsg = '‚ùå Failed to post to Facebook:\n\n' + data.message;
                    
                    if (data.error === 'Missing page access token' || data.message.includes('token')) {
                        errorMsg += '\n\nYour token may have expired. Try reconnecting Facebook.';
                        if (confirm(errorMsg + '\n\nReconnect now?')) {
                            connectMeta();
                        }
                        return;
                    }
                    
                    alert(errorMsg);
                }
            } catch (error) {
                console.error('Facebook post error:', error);
                alert('‚ùå Error posting to Facebook: ' + error.message);
            }
        }
        
        async function postToInstagram() {
            const content = document.getElementById('previewContent').value.trim();
            const imageUrl = document.getElementById('postImageUrl').value.trim();
            
            // Try to get token from database first
            let token = await getMetaTokenFromDatabase();
            
            // Fallback to localStorage if database doesn't have token
            if (!token) {
                token = localStorage.getItem('metaPageAccessToken');
            }
            
            if (!token) {
                if (confirm('No token saved. Would you like to connect Facebook now?')) {
                    connectMeta();
                }
                return;
            }
            
            if (!content) {
                alert('Please generate content first');
                return;
            }
            
            if (!imageUrl) {
                alert('‚ö†Ô∏è Instagram requires an image!\n\nPlease add an image URL in the field below the buttons.\n\nExample: https://example.com/yourimage.jpg');
                return;
            }
            
            // Validate token and check Instagram connection
            const tokenData = await testMetaToken();
            if (!tokenData) {
                if (confirm('‚ùå Token validation failed!\n\nWould you like to reconnect Facebook now?')) {
                    connectMeta();
                }
                return;
            }
            
            // Check if Instagram is connected
            if (!tokenData.instagram || !tokenData.instagram.id) {
                // Provide detailed instructions
                const helpMessage = '‚ùå No Instagram Business Account Connected!\n\n' +
                    'To post to Instagram, you need to:\n\n' +
                    '1. Convert your Instagram account to Business or Creator account\n' +
                    '   (Settings ‚Üí Account Type ‚Üí Switch to Professional Account)\n\n' +
                    '2. Link your Instagram Business account to your Facebook Page:\n' +
                    '   - Go to your Facebook Page\n' +
                    '   - Settings ‚Üí Instagram\n' +
                    '   - Click "Connect Account"\n' +
                    '   - Follow the prompts to connect\n\n' +
                    '3. Reconnect via the "Connect Facebook/Instagram" button\n\n' +
                    '4. Make sure your Facebook Page is connected to the Meta App\n\n' +
                    'Need help? Visit: https://www.facebook.com/business/help/898752960195806\n\n' +
                    'Would you like to check your Instagram connection now?';
                
                if (confirm(helpMessage)) {
                    // Test the token again to see current status
                    window.manualTest = true;
                    testMetaToken();
                }
                return;
            }
            
            if (!confirm(`Post to Instagram now?\n\n‚úÖ Instagram: @${tokenData.instagram.username}\nüì∑ Image: ${imageUrl.substring(0, 50)}...`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/social/post-to-instagram', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pageAccessToken: token,
                        message: content,
                        imageUrl: imageUrl
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Posted to Instagram successfully!\n\nüì∑ Account: @' + (tokenData.instagram.username || 'Instagram') + '\nüìù Post ID: ' + data.postId);
                } else {
                    let errorMsg = '‚ùå Failed to post to Instagram:\n\n' + data.message;
                    
                    // Handle specific errors
                    if (data.error === 'Instagram Not Connected') {
                        errorMsg = '‚ùå Instagram Not Connected!\n\n' + data.message + '\n\n' + (data.help?.solution || '');
                        if (confirm(errorMsg + '\n\nReconnect Facebook now?')) {
                            connectMeta();
                        }
                        return;
                    }
                    
                    if (data.help && data.help.steps) {
                        errorMsg += '\n\nTo fix this:\n' + data.help.steps.join('\n');
                    } else if (data.help && data.help.solution) {
                        errorMsg += '\n\n' + data.help.solution;
                    }
                    
                    alert(errorMsg);
                }
            } catch (error) {
                console.error('Instagram post error:', error);
                alert('‚ùå Error posting to Instagram: ' + error.message + '\n\nMake sure your Instagram Business Account is connected to your Facebook Page.');
            }
        }
        
        // Character count update functions
        function updateFacebookCharCount() {
            const textarea = document.getElementById('previewContent');
            const charCountEl = document.getElementById('facebookCharCountPreview');
            if (textarea && charCountEl) {
                const charCount = textarea.value.length;
                charCountEl.textContent = charCount;
            }
        }
        
        function updateLinkedInCharCount() {
            const textarea = document.getElementById('previewContentLinkedIn');
            const charCountEl = document.getElementById('linkedInCharCountPreview');
            if (textarea && charCountEl) {
                const charCount = textarea.value.length;
                charCountEl.textContent = charCount;
                // Color code: green if good length, yellow if short, red if too long
                if (charCount >= 200 && charCount <= 2000) {
                    charCountEl.style.color = '#28a745';
                } else if (charCount < 200) {
                    charCountEl.style.color = '#ffc107';
                } else {
                    charCountEl.style.color = '#dc3545';
                }
            }
        }
        
        function updateTwitterCharCount() {
            const textarea = document.getElementById('previewContentTwitter');
            const charCountEl = document.getElementById('twitterCharCountPreview');
            if (textarea && charCountEl) {
                const charCount = textarea.value.length;
                charCountEl.textContent = charCount;
                // Color code: green if under limit, yellow if close, red if over
                if (charCount <= 260) {
                    charCountEl.style.color = '#28a745';
                } else if (charCount <= 280) {
                    charCountEl.style.color = '#ffc107';
                } else {
                    charCountEl.style.color = '#dc3545';
                }
            }
        }
        
        // Check if we have a saved token on load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded');
            
            // Add event listeners for real-time character counting
            const facebookTextarea = document.getElementById('previewContent');
            if (facebookTextarea) {
                facebookTextarea.addEventListener('input', updateFacebookCharCount);
            }
            
            const linkedInTextarea = document.getElementById('previewContentLinkedIn');
            if (linkedInTextarea) {
                linkedInTextarea.addEventListener('input', updateLinkedInCharCount);
            }
            
            const twitterTextarea = document.getElementById('previewContentTwitter');
            if (twitterTextarea) {
                twitterTextarea.addEventListener('input', updateTwitterCharCount);
            }
            
            // Auto-load Meta token from database if available
            async function autoLoadMetaToken() {
                try {
                    // Try database first
                    const token = await getMetaTokenFromDatabase();
                    if (token) {
                        console.log('Found Meta token in database, will auto-test...');
                        const metaTokenInput = document.getElementById('metaToken');
                        if (metaTokenInput) {
                            metaTokenInput.value = token;
                        }
                        // Reset manual test flag for auto-test (no alert popup)
                        window.manualTest = false;
                        // Small delay to ensure all DOM elements are ready
                        setTimeout(() => testMetaToken(), 200);
                        return;
                    }
                    
                    // Fallback to localStorage
                    const savedToken = localStorage.getItem('metaPageAccessToken');
                    if (savedToken) {
                        console.log('Found saved Meta token in localStorage, will auto-test...');
                        const metaTokenInput = document.getElementById('metaToken');
                        if (metaTokenInput) {
                            metaTokenInput.value = savedToken;
                        }
                        // Reset manual test flag for auto-test (no alert popup)
                        window.manualTest = false;
                        // Small delay to ensure all DOM elements are ready
                        setTimeout(() => testMetaToken(), 200);
                    }
                } catch (error) {
                    console.error('Error auto-loading Meta token:', error);
                }
            }
            
            autoLoadMetaToken();
            
            // Auto-load connection status from database
            setTimeout(() => {
                loadMetaConnectionStatus();
                loadTwitterConnectionStatus();
            }, 500);
            
            // Set default date/time to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(9, 0, 0, 0);
            const scheduleDateTimeInput = document.getElementById('scheduleDateTime');
            if (scheduleDateTimeInput) {
                scheduleDateTimeInput.value = tomorrow.toISOString().slice(0, 16);
            }
        });
        
        // Load Meta/Facebook/Instagram connection status from database
        async function loadMetaConnectionStatus() {
            try {
                const response = await fetch('/api/social/tokens?platform=facebook');
                const data = await response.json();
                
                if (data.success && data.tokens && data.tokens.length > 0) {
                    const facebookToken = data.tokens[0];
                    const metaStatus = document.getElementById('metaStatus');
                    
                    if (metaStatus) {
                        let statusText = `‚úÖ Connected to: ${facebookToken.page_name || 'Facebook Page'}`;
                        
                        // Check for Instagram connection
                        if (facebookToken.instagram_account_id || facebookToken.instagram_username) {
                            statusText += `<br>üì∑ Instagram: @${facebookToken.instagram_username || 'Connected'}`;
                        } else {
                            // Check if there's a separate Instagram token
                            const igResponse = await fetch('/api/social/tokens?platform=instagram');
                            const igData = await igResponse.json();
                            
                            if (igData.success && igData.tokens && igData.tokens.length > 0) {
                                const instagramToken = igData.tokens[0];
                                statusText += `<br>üì∑ Instagram: @${instagramToken.instagram_username || 'Connected'}`;
                            } else {
                                statusText += `<br>‚ùå No Instagram connected`;
                            }
                        }
                        
                        metaStatus.innerHTML = statusText;
                        
                        // Load token into input if available
                        if (facebookToken.has_token) {
                            // Try to get token from database
                            const token = await getMetaTokenFromDatabase();
                            if (token) {
                                const metaTokenInput = document.getElementById('metaToken');
                                if (metaTokenInput && !metaTokenInput.value) {
                                    metaTokenInput.value = token;
                                }
                            } else {
                                // Fallback to localStorage
                                const savedToken = localStorage.getItem('metaPageAccessToken');
                                if (savedToken) {
                                    const metaTokenInput = document.getElementById('metaToken');
                                    if (metaTokenInput && !metaTokenInput.value) {
                                        metaTokenInput.value = savedToken;
                                    }
                                }
                            }
                        }
                    }
                } else {
                    // No tokens in database, check localStorage as fallback
                    const savedToken = localStorage.getItem('metaPageAccessToken');
                    if (savedToken) {
                        // Test the saved token to check Instagram connection
                        window.manualTest = false;
                        setTimeout(() => testMetaToken(), 300);
                    } else {
                        // No token found anywhere
                        const metaStatus = document.getElementById('metaStatus');
                        if (metaStatus) {
                            metaStatus.innerHTML = '‚ùå Not connected. Click "Connect Facebook/Instagram" to get started.';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading Meta connection status:', error);
            }
        }
        
        // Load Twitter connection status from database
        async function loadTwitterConnectionStatus() {
            try {
                const response = await fetch('/api/social-tokens?platform=twitter');
                const data = await response.json();
                
                if (data.success && data.tokens && data.tokens.length > 0) {
                    const token = data.tokens[0];
                    const statusText = document.getElementById('twitterStatusText');
                    
                    if (statusText) {
                        statusText.innerHTML = `‚úÖ Connected: ${token.page_name || 'Twitter User'}`;
                    }
                    
                    // Auto-test connection (silently, no alerts)
                    window.manualTest = false;
                    await testTwitterConnection();
                } else {
                    const statusText = document.getElementById('twitterStatusText');
                    if (statusText) {
                        statusText.textContent = 'Not connected';
                    }
                }
            } catch (error) {
                console.error('Error loading Twitter status:', error);
            }
        }
        
        // ENHANCED CONTENT TEMPLATES - Diverse, industry-specific, non-repetitive
        const contentTemplateLibrary = {
            'test-post': [
                "üöÄ TESTING! TESTING! 1...2...3...\n\nWe're excited to test our NEW automated social media platform live on {business}!\n\n‚ú® What this means for you:\n‚úÖ More consistent content\n‚úÖ Better engagement\n‚úÖ Smarter posting times\n‚úÖ Professional quality posts\n\nStay tuned as we bring you even better content! üéØ\n\n#Automation #NewTechnology #Innovation #SocialMediaMarketing",
                "üéâ BIG NEWS! We're testing cutting-edge automation technology here at {business}!\n\nThis post was created and published using our brand new content generation platform. Pretty cool, right?\n\nü§ñ Why we're doing this:\nTo bring you better, more consistent content that actually helps your business grow.\n\nLet us know what you think! Drop a comment below üëá\n\n#TestingInProgress #Innovation #SmartMarketing #TechSavvy",
                "üì¢ LIVE TEST IN PROGRESS!\n\n{business} is now testing state-of-the-art social media automation. You're witnessing the future of digital marketing right now! üöÄ\n\nüí° What's different?\n‚Ä¢ Smarter content\n‚Ä¢ Perfect timing\n‚Ä¢ Consistent quality\n‚Ä¢ Data-driven strategy\n\nExcited to share this journey with you! üéØ\n\n#AutomationTesting #DigitalTransformation #MarketingInnovation #FutureOfMarketing"
            ],
            'service-promotion': {
                'digital-marketing': [
                    "üìà Is your website getting lost in the crowd?\n\nAt {business}, we specialize in getting local businesses FOUND online. Our SEO strategies have helped businesses in {location} increase their visibility by an average of 250%!\n\n‚úÖ Local SEO optimization\n‚úÖ Google Business Profile management\n‚úÖ Content strategy\n‚úÖ Performance tracking\n\nReady to dominate local search? Let's talk! üìû {phone}\n\n#LocalSEO #DigitalMarketing #{location} #BusinessGrowth",
                    "üéØ Your competitors are online. Are you?\n\n{business} helps local businesses build powerful digital presences that drive real results.\n\nüíº Our Services:\n‚Ä¢ Website Design & Development\n‚Ä¢ Search Engine Optimization\n‚Ä¢ Social Media Management\n‚Ä¢ Paid Advertising\n‚Ä¢ Email Marketing\n\nFree consultation available! Call {phone}\n\n#WebDesign #DigitalStrategy #OnlineMarketing #{location}",
                    "üí° Throwing money at Facebook ads with no results?\n\nThe problem isn't the platform‚Äîit's the strategy. At {business}, we create data-driven campaigns that actually convert.\n\nüìä Our recent campaign results:\n‚Ä¢ 42% lower cost per lead\n‚Ä¢ 3.2x return on ad spend\n‚Ä¢ 89% increase in qualified leads\n\nLet's fix your marketing! üìû {phone}\n\n#FacebookAds #PaidAdvertising #MarketingStrategy #{location}"
                ],
                'insurance': [
                    "üè† Protecting what matters most.\n\nAt {business}, we understand that insurance isn't just about policies‚Äîit's about peace of mind for you and your family.\n\nüõ°Ô∏è We offer:\n‚Ä¢ Home Insurance\n‚Ä¢ Auto Insurance\n‚Ä¢ Life Insurance\n‚Ä¢ Business Insurance\n‚Ä¢ Umbrella Coverage\n\nGet a free quote today: {phone}\nServing {location} with integrity since [year]\n\n#Insurance #Protection #PeaceOfMind #{location}",
                    "‚ö†Ô∏è When was the last time you reviewed your insurance coverage?\n\nLife changes‚Äîand your insurance should too. Marriage, new home, business growth? Let's make sure you're properly protected.\n\n{business} offers FREE policy reviews with no obligation.\n\nCall today: {phone}\n\n#InsuranceReview #ProtectionPlan #LocalInsurance #{location}",
                    "üíº Business owners: Are you properly insured?\n\n73% of small businesses are underinsured. Don't let a single incident destroy everything you've built.\n\n{business} specializes in:\n‚Ä¢ General Liability\n‚Ä¢ Workers Compensation  \n‚Ä¢ Professional Liability\n‚Ä¢ Cyber Insurance\n\nProtect your business today: {phone}\n\n#BusinessInsurance #RiskManagement #{location}"
                ],
                'construction': [
                    "üî® Quality craftsmanship. Honest pricing. On-time completion.\n\nThat's the {business} difference. We've been building trust in {location} for over [years] years.\n\n‚úÖ Licensed & Insured\n‚úÖ Free Estimates\n‚úÖ Warranty Guaranteed\n‚úÖ Local References Available\n\nCall us today: {phone}\n\n#Construction #Contractor #QualityWork #{location}",
                    "üèóÔ∏è Planning a renovation? Don't settle for the lowest bid.\n\nAt {business}, we believe in doing it right the first time. Our experienced team handles:\n\n‚Ä¢ Kitchen & Bath Remodels\n‚Ä¢ Home Additions\n‚Ä¢ Roofing & Siding\n‚Ä¢ Commercial Projects\n\nFree consultation & detailed estimates: {phone}\n\n#HomeImprovement #Renovation #LocalContractor #{location}"
                ],
                'professional-services': [
                    "üíº Expert advice when you need it most.\n\n{business} provides professional {industry} services with a personal touch. Our experienced team is here to guide you through complex decisions.\n\nüìû Schedule a consultation: {phone}\nServing {location} with excellence\n\n#{location} #ProfessionalServices #TrustedAdvisor",
                    "‚öñÔ∏è Making the right decision starts with the right advisor.\n\nAt {business}, we combine expertise with accessibility. No question is too small, no challenge too complex.\n\nContact us today: {phone}\n\n#{location} #LocalProfessional #ExpertAdvice"
                ],
                'healthcare': [
                    "üè• Your health is our priority.\n\nAt {business}, we provide compassionate, comprehensive healthcare for your entire family.\n\n‚úÖ Accepting new patients\n‚úÖ Same-day appointments available\n‚úÖ Most insurance accepted\n\nCall to schedule: {phone}\nServing {location}\n\n#Healthcare #FamilyMedicine #{location}",
                    "üíö Quality healthcare, delivered with care.\n\n{business} is committed to keeping our {location} community healthy. Modern facilities, experienced staff, and a focus on YOU.\n\nSchedule your appointment: {phone}\n\n#HealthcareProvider #CommunityHealth #{location}"
                ],
                'restaurant': [
                    "üçΩÔ∏è Fresh ingredients. Bold flavors. Unforgettable experiences.\n\nThat's what you'll find at {business}. Join us for:\n\n‚Ä¢ Daily lunch specials\n‚Ä¢ Weekend brunch\n‚Ä¢ Private events\n‚Ä¢ Takeout & delivery\n\nReservations: {phone}\n{location}\n\n#LocalRestaurant #FoodieLife #{location}",
                    "üë®‚Äçüç≥ Made from scratch. Served with love.\n\n{business} has been feeding {location} for [years] years. Every dish tells a story, every meal creates a memory.\n\nCome hungry, leave happy! üç¥\nCall: {phone}\n\n#EatLocal #FreshFood #{location}"
                ],
                'retail': [
                    "üõçÔ∏è Shop local. Shop {business}.\n\nWhy buy online when you can get personal service, expert advice, and support your local community?\n\nVisit us in {location}!\nüìû {phone}\n\n#ShopLocal #SupportSmallBusiness #{location}",
                    "‚ú® New arrivals weekly at {business}!\n\nDiscover unique finds you won't see anywhere else. Plus, our knowledgeable staff is always here to help.\n\nStop by today: {location}\n{phone}\n\n#RetailTherapy #LocalShopping #{location}"
                ],
                'real-estate': [
                    "üè° Ready to find your dream home?\n\n{business} knows the {location} market inside and out. We'll help you find not just a house, but the perfect place to call home.\n\nüìû Free consultation: {phone}\n\n#RealEstate #HomeSearch #{location} #DreamHome",
                    "üìà Thinking of selling? Now is the time.\n\n{business} sells homes faster and for more money. Our proven marketing strategy gets results.\n\nFree home valuation: {phone}\nServing {location}\n\n#RealEstate #HomeSelling #{location}"
                ],
                'automotive': [
                    "üöó Keep your vehicle running like new.\n\n{business} provides honest, reliable automotive service. No upselling. No surprises. Just quality work at fair prices.\n\n‚úÖ All makes & models\n‚úÖ ASE-certified technicians\n‚úÖ Warranty on all work\n\nCall: {phone}\n{location}\n\n#AutoRepair #CarMaintenance #{location}",
                    "üîß Car trouble? We've got you covered.\n\n{business} has been keeping {location} vehicles on the road for [years] years. Same-day service available!\n\nüìû {phone}\n\n#AutoService #LocalMechanic #{location}"
                ],
                'home-services': [
                    "üîß Expert {industry} services when you need them most.\n\n{business} provides fast, reliable service throughout {location}. Licensed, insured, and always professional.\n\nüìû 24/7 Emergency Service: {phone}\n\n#HomeServices #LocalPros #{location}",
                    "üè† Your home deserves the best.\n\nAt {business}, we treat every job like it's our own home. Quality workmanship, upfront pricing, 100% satisfaction guaranteed.\n\nCall today: {phone}\n{location}\n\n#HomeImprovement #LocalExperts #{location}"
                ],
                'fitness': [
                    "üí™ Transform your body. Transform your life.\n\n{business} isn't just a gym‚Äîit's a community dedicated to your success. Personal training, group classes, and support every step of the way.\n\nFree trial week: {phone}\n{location}\n\n#Fitness #GymLife #{location} #GetFit",
                    "üèãÔ∏è Your fitness goals are within reach.\n\nAt {business}, we create personalized programs that work for YOUR body and YOUR schedule.\n\nStart your journey today: {phone}\n\n#FitnessJourney #PersonalTraining #{location}"
                ],
                'beauty': [
                    "üíá‚Äç‚ôÄÔ∏è Look good. Feel great.\n\n{business} offers the latest styles and treatments in a relaxing, professional environment.\n\n‚ú® Services:\n‚Ä¢ Hair styling & color\n‚Ä¢ Nail services\n‚Ä¢ Skin treatments\n‚Ä¢ Makeup\n\nBook now: {phone}\n{location}\n\n#BeautySalon #HairSalon #{location}",
                    "‚ú® Treat yourself. You deserve it.\n\n{business} is {location}'s premier destination for beauty and relaxation. Our talented team uses only the best products.\n\nAppointments: {phone}\n\n#SelfCare #BeautyTreatment #{location}"
                ]
            },
            'industry-tip': {
                'digital-marketing': [
                    "üí° TIP: 70% of people search for local businesses online before visiting.\n\nIs your business easy to find? Make sure you have:\n‚úÖ Google Business Profile (claimed & optimized)\n‚úÖ Consistent NAP (name, address, phone)\n‚úÖ Recent customer reviews\n‚úÖ Photos & hours updated\n\nNeed help? {business} specializes in local SEO! {phone}\n\n#LocalSEO #MarketingTip #{location}",
                    "üì± Did you know? Social media posts with images get 2.3x more engagement!\n\nAlways include high-quality photos with your posts. Your customers want to SEE what you offer.\n\n{business} | {phone}\n\n#SocialMediaTips #DigitalMarketing #{location}"
                ],
                'insurance': [
                    "üõ°Ô∏è INSURANCE TIP: Review your coverage annually.\n\nLife changes‚Äîmarriage, kids, new home, business growth‚Äîcan leave you under or over insured.\n\nFree policy review at {business}\nCall: {phone}\n\n#InsuranceTip #ProtectionPlan #{location}",
                    "‚ö†Ô∏è Don't wait until it's too late!\n\n80% of homes are underinsured. Make sure your coverage keeps pace with property values and replacement costs.\n\n{business} | Free consultation: {phone}\n\n#InsuranceAdvice #{location}"
                ],
                'construction': [
                    "üî® CONTRACTOR TIP: Get 3 detailed quotes before starting any project.\n\nLook for:\n‚úÖ Itemized estimates\n‚úÖ Timeline & milestones\n‚úÖ Warranty information\n‚úÖ License & insurance proof\n\n{business} | Free estimates: {phone}\n\n#ConstructionTips #Homeowner #{location}"
                ]
            },
            'behind-scenes': [
                "üëã Meet the team behind {business}!\n\nWe're not just a business‚Äîwe're your neighbors, friends, and community members. Here's a glimpse of what goes on behind the scenes...\n\n[Perfect spot for team photo]\n\n#{location} #LocalBusiness #MeetTheTeam",
                "üé¨ Behind the scenes at {business} today!\n\nThis is what dedication looks like. Our team works hard every day to bring you the best service possible.\n\nThanks for your continued support, {location}!\n\n#BTS #LocalBusiness #{location}",
                "‚òï Morning at {business}!\n\nBefore we open our doors, there's a lot of prep work. Here's what it takes to serve you with excellence every single day.\n\n#{location} #BehindTheScenes #SmallBusiness"
            ],
            'testimonial': [
                "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê \"Absolutely fantastic service!\"\n\n\"I can't say enough good things about {business}. Professional, knowledgeable, and truly care about their customers. Highly recommend!\"\n\n- Happy Customer\n\nWant to be our next success story? {phone}\n\n#CustomerReview #5Stars #{location}",
                "üí¨ Real feedback from real customers:\n\n\"{business} exceeded our expectations in every way. Quality work, fair pricing, and amazing customer service!\"\n\nThank you for trusting us with your business!\n\n{phone} | {location}\n\n#Testimonial #HappyCustomers #{location}"
            ],
            'question': [
                "‚ùì Quick question: What's the #1 challenge facing your business right now?\n\nDrop a comment below‚Äîwe'd love to hear from you! And if {business} can help, we'll reach out.\n\n{phone} | {location}\n\n#{location} #BusinessTips #CommunityConversation",
                "ü§î We want to hear from YOU!\n\nWhat topics would you like to see us cover? Marketing tips? Industry news? Behind-the-scenes content?\n\nComment below and let us know! üëá\n\n{business} | {location}\n\n#{location} #Engagement #CommunityFirst"
            ],
            'did-you-know': [
                "üìö DID YOU KNOW?\n\n{business} has been serving {location} for [X] years! That's [X] years of dedication, quality service, and happy customers.\n\nThank you for being part of our journey! üôè\n\n{phone}\n\n#{location} #LocalBusiness #CommunityStrong",
                "üí° FUN FACT: We process [number]+ [orders/clients/projects] every month!\n\nThat's a lot of trust placed in {business}, and we don't take it lightly. Thank you, {location}!\n\n{phone}\n\n#{location} #DidYouKnow #LocalSupport"
            ],
            'local-community': [
                "‚ù§Ô∏è Community matters.\n\n{business} is proud to support local schools, charities, and events in {location}. When you shop local, you're reinvesting in OUR community.\n\nThank you for your support!\n\n{phone}\n\n#{location} #SupportLocal #CommunityFirst",
                "üåü Love where you live? Shop where you live!\n\n{business} has been a proud member of the {location} community for [years]. Every purchase supports local families, schools, and neighborhoods.\n\n{phone}\n\n#ShopLocal #{location} #CommunitySupport",
                "üèòÔ∏è Supporting our community, one customer at a time.\n\n{business} believes in giving back to {location}. That's why we partner with local organizations and events.\n\n{phone}\n\n#{location} #CommunityFirst #LocalBusiness",
                "ü§ù Together we're stronger.\n\n{business} is committed to building a better {location}. Join us in supporting our local community!\n\n{phone}\n\n#{location} #CommunitySupport #LocalLove"
            ],
            'job-posting': {
                'digital-marketing': [
                    "üíº WE'RE HIRING! Join Our Team\n\n{business} is looking for talented {jobTitle} to join our growing digital marketing agency in {location}.\n\n‚úÖ What we offer:\n‚Ä¢ Competitive salary + benefits\n‚Ä¢ Flexible work environment\n‚Ä¢ Growth opportunities\n‚Ä¢ Collaborative team culture\n\nüìß Interested? Send your resume to: {email} or call {phone}\n\n#Hiring #{location} #MarketingJobs #DigitalMarketing #NowHiring",
                    "üöÄ CAREER OPPORTUNITY: {jobTitle}\n\n{business} is expanding and seeking a skilled {jobTitle} to help us deliver exceptional results for our clients.\n\nRequirements:\n‚Ä¢ Experience in digital marketing\n‚Ä¢ Strong communication skills\n‚Ä¢ Passion for learning\n‚Ä¢ Team player mentality\n\nBenefits include health insurance, PTO, and professional development opportunities.\n\nApply today: {email} | {phone}\n\n#JobOpening #{location} #MarketingCareer #NowHiring",
                    "üë• JOIN OUR TEAM!\n\n{business} is hiring a {jobTitle} in {location}. We're a fast-growing digital agency looking for someone who's passionate about marketing and client success.\n\nWhat you'll do:\n‚Ä¢ Manage client campaigns\n‚Ä¢ Create engaging content\n‚Ä¢ Analyze performance data\n‚Ä¢ Build client relationships\n\nReady to grow your career? Apply now: {email}\n\n#HiringNow #{location} #MarketingJobs #CareerGrowth"
                ],
                'insurance': [
                    "üíº CAREER OPPORTUNITY: Insurance Agent\n\n{business} is seeking a licensed Insurance Agent to join our team in {location}.\n\n‚úÖ What we offer:\n‚Ä¢ Base salary + commission\n‚Ä¢ Health & dental insurance\n‚Ä¢ Paid time off\n‚Ä¢ Professional development\n\nRequirements:\n‚Ä¢ Insurance license (or willing to obtain)\n‚Ä¢ Sales experience preferred\n‚Ä¢ Customer-focused attitude\n\nApply: {email} | Call: {phone}\n\n#Hiring #{location} #InsuranceJobs #NowHiring #SalesCareers",
                    "üè¢ WE'RE HIRING: Insurance Sales Professional\n\n{business} is growing and looking for an experienced Insurance Sales Professional to serve clients in {location}.\n\nBenefits:\n‚Ä¢ Competitive compensation package\n‚Ä¢ Full benefits\n‚Ä¢ Flexible schedule\n‚Ä¢ Supportive team environment\n\nContact us: {email} or {phone}\n\n#JobOpening #{location} #InsuranceCareers #NowHiring",
                    "üåü JOIN OUR INSURANCE TEAM!\n\n{business} is hiring a Licensed Insurance Agent. Perfect opportunity for someone looking to build a rewarding career helping people protect what matters most.\n\nSend resume: {email}\nCall: {phone}\n\n#HiringNow #{location} #InsuranceJobs #CareerOpportunity"
                ],
                'construction': [
                    "üî® NOW HIRING: {jobTitle}\n\n{business} is looking for skilled {jobTitle} to join our construction team in {location}.\n\n‚úÖ We offer:\n‚Ä¢ Competitive wages\n‚Ä¢ Benefits package\n‚Ä¢ Steady work\n‚Ä¢ Overtime opportunities\n\nRequirements:\n‚Ä¢ Experience in construction\n‚Ä¢ Valid driver's license\n‚Ä¢ Reliable transportation\n‚Ä¢ Strong work ethic\n\nApply: {phone} or {email}\n\n#Hiring #{location} #ConstructionJobs #NowHiring #SkilledTrades",
                    "üíº CAREER OPPORTUNITY: Construction Professional\n\n{business} is expanding and seeking experienced construction professionals. Multiple positions available!\n\nPositions:\n‚Ä¢ General Laborers\n‚Ä¢ Skilled Tradespeople\n‚Ä¢ Project Managers\n\nBenefits: Health insurance, retirement plan, paid time off.\n\nCall: {phone} | Email: {email}\n\n#JobOpening #{location} #ConstructionCareers #NowHiring",
                    "üèóÔ∏è JOIN OUR CONSTRUCTION TEAM!\n\n{business} is hiring! We're looking for hardworking, reliable team members to join our growing construction company in {location}.\n\nApply today: {phone}\n\n#HiringNow #{location} #ConstructionJobs #SkilledTrades"
                ],
                'professional-services': [
                    "üíº WE'RE HIRING: {jobTitle}\n\n{business} is seeking a qualified {jobTitle} to join our professional services team in {location}.\n\nRequirements:\n‚Ä¢ Professional certification/license\n‚Ä¢ X+ years of experience\n‚Ä¢ Strong analytical skills\n‚Ä¢ Excellent communication\n\nBenefits: Competitive salary, health insurance, retirement plan, PTO.\n\nApply: {email} | {phone}\n\n#Hiring #{location} #ProfessionalJobs #NowHiring #CareerOpportunity",
                    "üöÄ CAREER OPPORTUNITY: Join Our Professional Team\n\n{business} is expanding and looking for talented professionals to join our team.\n\nWhat we offer:\n‚Ä¢ Competitive compensation\n‚Ä¢ Professional development\n‚Ä¢ Work-life balance\n‚Ä¢ Collaborative environment\n\nInterested candidates: {email}\n\n#JobOpening #{location} #ProfessionalCareers #NowHiring",
                    "üëî JOIN OUR PROFESSIONAL TEAM!\n\n{business} is hiring! We're looking for experienced professionals who value excellence and client service.\n\nApply: {email} | {phone}\n\n#HiringNow #{location} #ProfessionalServices #CareerGrowth"
                ],
                'general': [
                    "üíº WE'RE HIRING! Join Our Team\n\n{business} is looking for talented individuals to join our growing team in {location}.\n\n‚úÖ What we offer:\n‚Ä¢ Competitive salary + benefits\n‚Ä¢ Growth opportunities\n‚Ä¢ Supportive team environment\n‚Ä¢ Work-life balance\n\nüìß Interested? Send your resume to: {email} or call {phone}\n\n#Hiring #{location} #NowHiring #JobOpening #CareerOpportunity",
                    "üöÄ CAREER OPPORTUNITY: {jobTitle}\n\n{business} is expanding and seeking a skilled {jobTitle} to help us serve our {location} community better.\n\nRequirements:\n‚Ä¢ Relevant experience\n‚Ä¢ Strong work ethic\n‚Ä¢ Customer-focused mindset\n‚Ä¢ Team player\n\nBenefits include health insurance, PTO, and professional development.\n\nApply today: {email} | {phone}\n\n#JobOpening #{location} #NowHiring #CareerGrowth",
                    "üë• JOIN OUR TEAM!\n\n{business} is hiring! We're looking for passionate, dedicated individuals to join our team in {location}.\n\nWhat you'll get:\n‚Ä¢ Competitive compensation\n‚Ä¢ Benefits package\n‚Ä¢ Friendly work environment\n‚Ä¢ Opportunities for advancement\n\nReady to grow your career? Apply now: {email}\n\n#HiringNow #{location} #JobOpening #CareerOpportunity",
                    "üåü NOW HIRING: Multiple Positions Available\n\n{business} is growing and looking for great people to join our team!\n\nWe're hiring for:\n‚Ä¢ {position1}\n‚Ä¢ {position2}\n‚Ä¢ {position3}\n\nAll positions include competitive pay and benefits.\n\nApply: {email} | Call: {phone}\n\n#Hiring #{location} #NowHiring #JobOpportunity #JoinOurTeam",
                    "üíº EXCITING OPPORTUNITY: Join {business}\n\nWe're looking for talented team members to help us serve {location} with excellence.\n\nPositions available:\n‚Ä¢ Full-time opportunities\n‚Ä¢ Part-time positions\n‚Ä¢ Internships available\n\nSend your resume: {email}\nCall: {phone}\n\n#Hiring #{location} #NowHiring #CareerOpportunity #JoinOurTeam"
                ]
            }
        };
        
        function switchPlatform(platform, element) {
            // Remove active class from all tabs
            document.querySelectorAll('.platform-tab').forEach(tab => tab.classList.remove('active'));
            // Hide all content areas
            document.querySelectorAll('.content-area').forEach(area => {
                area.classList.remove('active');
                area.style.display = 'none';
            });
            // Activate clicked tab
            if (element) element.classList.add('active');
            // Show target content area
            const targetArea = document.getElementById(platform);
            if (targetArea) {
                targetArea.classList.add('active');
                targetArea.style.display = 'block';
            }
            console.log('Switched to platform:', platform, 'Target area found:', !!targetArea);
        }
        
        // Improved randomization function - shuffles array for better variety
        function getRandomTemplate(templates) {
            if (!templates || templates.length === 0) return null;
            // Use Fisher-Yates shuffle for better randomization
            const shuffled = [...templates];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled[Math.floor(Math.random() * shuffled.length)];
        }
        
        function generateContent() {
            const contentType = document.getElementById('contentType').value;
            const industryType = document.getElementById('professionType').value;
            const businessName = document.getElementById('clientBusinessName').value || 'TNR Business Solutions';
            const location = 'Greensburg PA'; // Can make this customizable too
            const phone = '(412) 499-2987'; // Can make this customizable too
            
            let template;
            
            // Handle test post (special case - always random)
            if (contentType === 'test-post') {
                const testTemplates = contentTemplateLibrary['test-post'];
                template = getRandomTemplate(testTemplates);
            }
            // Handle job postings (industry-specific or general)
            else if (contentType === 'job-posting') {
                const jobTemplates = contentTemplateLibrary['job-posting'];
                // Try industry-specific first
                if (jobTemplates[industryType] && jobTemplates[industryType].length > 0) {
                    template = getRandomTemplate(jobTemplates[industryType]);
                } else if (jobTemplates['general'] && jobTemplates['general'].length > 0) {
                    // Fallback to general job posting templates
                    template = getRandomTemplate(jobTemplates['general']);
                } else {
                    // Last resort fallback
                    template = "üíº WE'RE HIRING! Join Our Team\n\n{business} is looking for talented individuals to join our growing team in {location}.\n\nüìß Interested? Send your resume to: careers@{business}.com or call {phone}\n\n#Hiring #{location} #NowHiring #JobOpening";
                }
            }
            // Handle service promotions (industry-specific)
            else if (contentType === 'service-promotion') {
                const industryTemplates = contentTemplateLibrary[contentType][industryType];
                if (industryTemplates && industryTemplates.length > 0) {
                    template = getRandomTemplate(industryTemplates);
                } else {
                    // Fallback to generic
                    template = "üöÄ Looking for quality {industry} services in {location}?\n\n{business} is here to help! Our experienced team delivers professional results you can count on.\n\nContact us today: {phone}\n\n#{location} #LocalBusiness #Professional";
                }
            }
            // Handle industry tips (industry-specific)
            else if (contentType === 'industry-tip') {
                const industryTemplates = contentTemplateLibrary[contentType][industryType];
                if (industryTemplates && industryTemplates.length > 0) {
                    template = getRandomTemplate(industryTemplates);
                } else {
                    // Generic tip
                    template = "üí° PRO TIP: Stay consistent with your marketing!\n\nRegular posts, consistent branding, and engaging content build trust with your audience.\n\n{business} | {phone}\n\n#{location} #BusinessTip #MarketingAdvice";
                }
            }
            // Handle non-industry-specific content types
            else if (contentTemplateLibrary[contentType]) {
                const templates = contentTemplateLibrary[contentType];
                template = getRandomTemplate(templates);
            }
            // Fallback for missing content types
            else {
                template = "üéØ Great things are happening at {business}!\n\nWe're dedicated to providing excellent service to {location} and beyond.\n\nContact us: {phone}\n\n#{location} #LocalBusiness #CommunityFocused";
            }
            
            // Generate job-specific placeholders if needed
            const jobTitle = document.getElementById('jobTitle')?.value || 'Professional';
            const email = document.getElementById('jobEmail')?.value || `careers@${businessName.toLowerCase().replace(/\s+/g, '')}.com`;
            const positions = ['Full-time Positions', 'Part-time Opportunities', 'Contract Work'];
            const randomPosition = positions[Math.floor(Math.random() * positions.length)];
            
            // Replace placeholders with actual values
            let content = template
                .replace(/{business}/g, businessName)
                .replace(/{location}/g, location)
                .replace(/{phone}/g, phone)
                .replace(/{industry}/g, getIndustryName(industryType))
                .replace(/#{location}/g, '#' + location.replace(/\s+/g, ''))
                .replace(/{jobTitle}/g, jobTitle)
                .replace(/{email}/g, email)
                .replace(/{position1}/g, 'Full-time Positions')
                .replace(/{position2}/g, 'Part-time Opportunities')
                .replace(/{position3}/g, randomPosition);
            
            const previewTextarea = document.getElementById('previewContent');
            previewTextarea.value = content;
            document.getElementById('contentPreview').classList.remove('hidden');
            // Update character count
            updateFacebookCharCount();
        }
        
        function getIndustryName(industryType) {
            const industryNames = {
                'digital-marketing': 'Digital Marketing',
                'insurance': 'Insurance',
                'construction': 'Construction',
                'professional-services': 'Professional Services',
                'healthcare': 'Healthcare',
                'restaurant': 'Restaurant',
                'retail': 'Retail',
                'real-estate': 'Real Estate',
                'automotive': 'Automotive',
                'home-services': 'Home Services',
                'fitness': 'Fitness',
                'beauty': 'Beauty'
            };
            return industryNames[industryType] || 'Business';
        }
        
        // Generate Twitter content (optimized for 280 character limit)
        function generateTwitterContent() {
            const contentType = document.getElementById('contentTypeTwitter').value;
            const industryType = document.getElementById('professionTypeTwitter').value;
            const businessName = document.getElementById('clientBusinessNameTwitter').value || 'TNR Business Solutions';
            const location = 'Greensburg PA';
            const phone = '(412) 499-2987';
            
            let template;
            
            // Handle test post (special case - always random)
            if (contentType === 'test-post') {
                const testTemplates = contentTemplateLibrary['test-post'];
                template = getRandomTemplate(testTemplates);
            }
            // Handle job postings (industry-specific or general, Twitter-optimized)
            else if (contentType === 'job-posting') {
                const jobTemplates = contentTemplateLibrary['job-posting'];
                if (jobTemplates[industryType] && jobTemplates[industryType].length > 0) {
                    template = getRandomTemplate(jobTemplates[industryType]);
                } else if (jobTemplates['general'] && jobTemplates['general'].length > 0) {
                    template = getRandomTemplate(jobTemplates['general']);
                } else {
                    template = "üíº WE'RE HIRING! Join {business} in {location}.\n\nApply: {email} | {phone}\n\n#Hiring #{location} #NowHiring";
                }
                // Shorten for Twitter if needed
                if (template.length > 200) {
                    template = template.substring(0, 200).replace(/\n[^\n]*$/, '') + '\n\n#Hiring #{location} #NowHiring';
                }
            }
            // Handle service promotions (industry-specific)
            else if (contentType === 'service-promotion') {
                const industryTemplates = contentTemplateLibrary[contentType][industryType];
                if (industryTemplates && industryTemplates.length > 0) {
                    template = getRandomTemplate(industryTemplates);
                } else {
                    // Fallback to generic (Twitter-optimized)
                    template = "üöÄ Quality {industry} services in {location}!\n\n{business} delivers professional results.\n\nContact: {phone}\n\n#{location} #LocalBusiness";
                }
            }
            // Handle industry tips (industry-specific)
            else if (contentType === 'industry-tip') {
                const industryTemplates = contentTemplateLibrary[contentType][industryType];
                if (industryTemplates && industryTemplates.length > 0) {
                    template = getRandomTemplate(industryTemplates);
                } else {
                    // Generic tip (Twitter-optimized)
                    template = "üí° TIP: Consistent marketing builds trust!\n\n{business} | {phone}\n\n#{location} #BusinessTip";
                }
            }
            // Handle non-industry-specific content types
            else if (contentTemplateLibrary[contentType]) {
                const templates = contentTemplateLibrary[contentType];
                template = getRandomTemplate(templates);
            }
            // Fallback for missing content types
            else {
                template = "üéØ Great things happening at {business}!\n\nServing {location} with excellence.\n\nContact: {phone}\n\n#{location} #LocalBusiness";
            }
            
            // Generate job-specific placeholders
            const jobTitle = document.getElementById('jobTitle')?.value || 'Professional';
            const email = document.getElementById('jobEmail')?.value || `careers@${businessName.toLowerCase().replace(/\s+/g, '')}.com`;
            const positions = ['Full-time Positions', 'Part-time Opportunities', 'Contract Work'];
            const randomPosition = positions[Math.floor(Math.random() * positions.length)];
            
            // Replace placeholders with actual values
            let content = template
                .replace(/{business}/g, businessName)
                .replace(/{location}/g, location)
                .replace(/{phone}/g, phone)
                .replace(/{industry}/g, getIndustryName(industryType))
                .replace(/#{location}/g, '#' + location.replace(/\s+/g, ''))
                .replace(/{jobTitle}/g, jobTitle)
                .replace(/{email}/g, email)
                .replace(/{position1}/g, 'Full-time Positions')
                .replace(/{position2}/g, 'Part-time Opportunities')
                .replace(/{position3}/g, randomPosition);
            
            // Optimize for Twitter: trim if too long, ensure it fits in 280 chars
            if (content.length > 280) {
                // Try to shorten by removing some hashtags or shortening text
                const lines = content.split('\n');
                let shortened = '';
                let charCount = 0;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    if (charCount + line.length + 1 <= 250) { // Leave room for hashtags
                        shortened += (shortened ? '\n' : '') + line;
                        charCount += line.length + 1;
                    } else {
                        // Add essential hashtags if we have room
                        if (charCount < 240) {
                            shortened += '\n\n#' + location.replace(/\s+/g, '') + ' #LocalBusiness';
                        }
                        break;
                    }
                }
                
                if (shortened.length > 0) {
                    content = shortened;
                } else {
                    // Last resort: truncate
                    content = content.substring(0, 277) + '...';
                }
            }
            
            // Update preview
            const twitterTextarea = document.getElementById('previewContentTwitter');
            twitterTextarea.value = content;
            document.getElementById('contentPreviewTwitter').classList.remove('hidden');
            // Update character count
            updateTwitterCharCount();
        }
        
        // Generate LinkedIn content (professional, longer-form)
        function generateLinkedInContent() {
            const contentType = document.getElementById('contentTypeLinkedIn').value;
            const industryType = document.getElementById('professionTypeLinkedIn').value;
            const businessName = document.getElementById('clientBusinessNameLinkedIn').value || 'TNR Business Solutions';
            const location = 'Greensburg PA';
            const phone = '(412) 499-2987';
            
            let template;
            
            // LinkedIn-specific professional templates
            const linkedInTemplates = {
                'professional-insight': [
                    `As a professional in the {industry} industry, I've noticed a significant trend that's worth sharing.\n\n{content}\n\nWhat are your thoughts on this? I'd love to hear from fellow professionals in the comments.\n\n#ProfessionalDevelopment #IndustryInsights #BusinessGrowth #Networking`,
                    `After {years} years in {industry}, I've learned that success comes down to one key principle: {principle}.\n\nHere's why this matters:\n\n‚Ä¢ {point1}\n‚Ä¢ {point2}\n‚Ä¢ {point3}\n\nWhat principles guide your professional journey? Share your insights below.\n\n#Leadership #ProfessionalGrowth #BusinessStrategy #IndustryExpertise`
                ],
                'industry-news': [
                    `üì∞ Industry Update: The {industry} sector is experiencing significant changes.\n\nHere's what you need to know:\n\n{update}\n\nHow is your business adapting to these changes? Let's discuss in the comments.\n\n#IndustryNews #BusinessUpdate #ProfessionalNetwork #MarketTrends`,
                    `The {industry} landscape is evolving, and staying informed is crucial for business success.\n\nRecent developments include:\n\n‚Ä¢ {development1}\n‚Ä¢ {development2}\n‚Ä¢ {development3}\n\nAt {business}, we're committed to helping our clients navigate these changes effectively.\n\n#IndustryTrends #BusinessIntelligence #ProfessionalNetwork #MarketInsights`
                ]
            };
            
            // Handle test post
            if (contentType === 'test-post') {
                const testTemplates = contentTemplateLibrary['test-post'];
                template = testTemplates[Math.floor(Math.random() * testTemplates.length)];
            }
            // Handle LinkedIn-specific content types
            else if (linkedInTemplates[contentType]) {
                const templates = linkedInTemplates[contentType];
                template = templates[Math.floor(Math.random() * templates.length)];
            }
            // Handle service promotions (industry-specific, LinkedIn-optimized)
            else if (contentType === 'service-promotion') {
                const industryTemplates = contentTemplateLibrary[contentType]?.[industryType];
                if (industryTemplates && industryTemplates.length > 0) {
                    template = industryTemplates[Math.floor(Math.random() * industryTemplates.length)];
                    // Enhance for LinkedIn with professional tone
                    template = `üöÄ ${template}\n\nAt {business}, we're committed to delivering exceptional results for our clients. Our proven track record speaks for itself.\n\nInterested in learning more? Let's connect and discuss how we can help your business grow.\n\n#BusinessGrowth #ProfessionalServices #ClientSuccess #Networking`;
                } else {
                    template = `üöÄ Looking for quality {industry} services in {location}?\n\n{business} is here to help! Our experienced team delivers professional results you can count on.\n\nWe specialize in:\n‚Ä¢ Professional service delivery\n‚Ä¢ Client-focused solutions\n‚Ä¢ Proven results\n\nContact us today: {phone}\n\n#ProfessionalServices #BusinessGrowth #LocalBusiness #Networking`;
                }
            }
            // Handle industry tips (LinkedIn-optimized)
            else if (contentType === 'industry-tip') {
                const industryTemplates = contentTemplateLibrary[contentType]?.[industryType];
                if (industryTemplates && industryTemplates.length > 0) {
                    template = industryTemplates[Math.floor(Math.random() * industryTemplates.length)];
                } else {
                    template = `üí° Professional Tip: Stay consistent with your marketing strategy!\n\nIn my experience working with businesses in {location}, I've found that:\n\n‚Ä¢ Regular, consistent messaging builds brand recognition\n‚Ä¢ Professional content establishes authority\n‚Ä¢ Engaging with your network creates opportunities\n\n{business} helps businesses develop and execute effective marketing strategies.\n\nWhat marketing strategies have worked best for your business? Share your insights below.\n\n#MarketingStrategy #BusinessTips #ProfessionalAdvice #BusinessGrowth`;
                }
            }
            // Handle other content types
            else if (contentTemplateLibrary[contentType]) {
                const templates = contentTemplateLibrary[contentType];
                template = templates[Math.floor(Math.random() * templates.length)];
                // Add professional LinkedIn closing
                template += `\n\nAt {business}, we're dedicated to helping businesses succeed. Connect with us to learn more.\n\n#ProfessionalNetwork #BusinessGrowth #IndustryExpertise`;
            }
            // Fallback
            else {
                template = `üéØ Great things are happening at {business}!\n\nWe're dedicated to providing excellent service to {location} and beyond. Our commitment to quality and professionalism sets us apart.\n\nContact us: {phone}\n\n#ProfessionalServices #BusinessExcellence #LocalBusiness #Networking`;
            }
            
            // Generate job-specific placeholders
            const jobTitle = document.getElementById('jobTitle')?.value || 'Professional';
            const email = document.getElementById('jobEmail')?.value || `careers@${businessName.toLowerCase().replace(/\s+/g, '')}.com`;
            const positions = ['Full-time Positions', 'Part-time Opportunities', 'Contract Work'];
            const randomPosition = positions[Math.floor(Math.random() * positions.length)];
            
            // Replace placeholders
            let content = template
                .replace(/{business}/g, businessName)
                .replace(/{location}/g, location)
                .replace(/{phone}/g, phone)
                .replace(/{industry}/g, getIndustryName(industryType))
                .replace(/#{location}/g, '#' + location.replace(/\s+/g, ''))
                .replace(/{years}/g, '15+')
                .replace(/{principle}/g, 'consistency and client focus')
                .replace(/{point1}/g, 'Building strong relationships')
                .replace(/{point2}/g, 'Delivering value consistently')
                .replace(/{point3}/g, 'Adapting to market changes')
                .replace(/{content}/g, 'This approach has transformed how we serve our clients and drive business growth.')
                .replace(/{update}/g, 'These changes present both challenges and opportunities for businesses willing to adapt.')
                .replace(/{development1}/g, 'New technologies reshaping operations')
                .replace(/{development2}/g, 'Changing customer expectations')
                .replace(/{development3}/g, 'Regulatory updates affecting the industry')
                .replace(/{jobTitle}/g, jobTitle)
                .replace(/{email}/g, email)
                .replace(/{position1}/g, 'Full-time Positions')
                .replace(/{position2}/g, 'Part-time Opportunities')
                .replace(/{position3}/g, randomPosition);
            
            // Update preview
            const linkedInTextarea = document.getElementById('previewContentLinkedIn');
            linkedInTextarea.value = content;
            document.getElementById('contentPreviewLinkedIn').classList.remove('hidden');
            // Update character count
            updateLinkedInCharCount();
        }
        
        // Post generated content to LinkedIn
        async function postGeneratedToLinkedIn() {
            const content = document.getElementById('previewContentLinkedIn')?.value?.trim();
            
            if (!content) {
                alert('Please generate content first');
                return;
            }
            
            if (content.length > 3000) {
                alert('‚ö†Ô∏è Content is too long for LinkedIn (3,000 character limit). Please shorten it.');
                return;
            }
            
            try {
                const statusDiv = document.getElementById('linkedinStatus') || document.createElement('div');
                statusDiv.id = 'linkedinStatus';
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.style.padding = '10px';
                statusDiv.style.borderRadius = '4px';
                statusDiv.style.marginTop = '15px';
                statusDiv.textContent = 'Posting to LinkedIn...';
                
                if (!document.getElementById('linkedinStatus')) {
                    document.getElementById('contentPreviewLinkedIn').appendChild(statusDiv);
                }
                
                const response = await fetch('/api/social/post-to-linkedin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        useDatabaseToken: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.textContent = `‚úÖ Successfully posted to LinkedIn! ${data.postUrl ? `View post: ${data.postUrl}` : ''}`;
                    
                    // Clear preview after successful post
                    setTimeout(() => {
                        document.getElementById('contentPreviewLinkedIn').classList.add('hidden');
                        statusDiv.style.display = 'none';
                    }, 5000);
                } else {
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    
                    let errorMsg = `‚ùå Error: ${data.error || data.message || 'Failed to post to LinkedIn'}`;
                    
                    // Add helpful guidance for user ID missing error
                    if (data.help && data.help.steps) {
                        errorMsg += '\n\n' + data.help.title + ':\n';
                        errorMsg += data.help.steps.join('\n');
                    }
                    
                    statusDiv.textContent = errorMsg;
                    statusDiv.style.whiteSpace = 'pre-line';
                    
                    // If it's a user ID issue, suggest reconnecting
                    if (data.error && data.error.includes('User ID')) {
                        const reconnectBtn = document.createElement('button');
                        reconnectBtn.className = 'btn';
                        reconnectBtn.style.marginTop = '10px';
                        reconnectBtn.style.background = '#0077b5';
                        reconnectBtn.textContent = 'üíº Reconnect LinkedIn Account';
                        reconnectBtn.onclick = () => {
                            window.location.href = '/api/auth/linkedin';
                        };
                        statusDiv.appendChild(document.createElement('br'));
                        statusDiv.appendChild(reconnectBtn);
                    }
                }
            } catch (error) {
                console.error('LinkedIn posting error:', error);
                alert(`Error posting to LinkedIn: ${error.message}`);
            }
        }
        
        // Copy LinkedIn content to clipboard
        function copyLinkedInContent() {
            const content = document.getElementById('previewContentLinkedIn')?.value?.trim();
            if (!content) {
                alert('No content to copy');
                return;
            }
            
            navigator.clipboard.writeText(content).then(() => {
                alert('‚úÖ Content copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy content. Please select and copy manually.');
            });
        }
        
        // Post generated content to Twitter
        async function postGeneratedToTwitter() {
            const content = document.getElementById('previewContentTwitter')?.value?.trim();
            const statusDiv = document.getElementById('twitterStatus');
            
            if (!content) {
                alert('Please generate content first');
                return;
            }
            
            if (content.length > 280) {
                alert('‚ö†Ô∏è Content is too long for Twitter (280 character limit). Please shorten it.');
                return;
            }
            
            try {
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#fff3cd';
                    statusDiv.style.color = '#856404';
                    statusDiv.textContent = 'Posting to Twitter/X...';
                }
                
                const response = await fetch('/api/post-to-twitter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: content,
                        useDatabaseToken: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (statusDiv) {
                        statusDiv.style.background = '#d4edda';
                        statusDiv.style.color = '#155724';
                        statusDiv.innerHTML = `‚úÖ Tweet posted successfully!<br><a href="${data.tweetUrl}" target="_blank" style="color: #155724; text-decoration: underline;">View Tweet ‚Üí</a>`;
                    }
                    
                    // Clear preview after successful post
                    setTimeout(() => {
                        document.getElementById('contentPreviewTwitter').classList.add('hidden');
                        document.getElementById('previewContentTwitter').textContent = '';
                        if (statusDiv) {
                            statusDiv.style.display = 'none';
                        }
                    }, 3000);
                } else {
                    if (statusDiv) {
                        statusDiv.style.background = '#f8d7da';
                        statusDiv.style.color = '#721c24';
                        
                        let errorMsg = `‚ùå Failed to post: ${data.message || data.error || 'Unknown error'}`;
                        
                        // Add helpful guidance for permission errors
                        if (data.help) {
                            errorMsg += '\n\n' + data.help.title + ':\n';
                            if (data.help.steps) {
                                errorMsg += data.help.steps.join('\n');
                            } else if (data.help.solution) {
                                errorMsg += data.help.solution;
                            }
                        }
                        
                        statusDiv.textContent = errorMsg;
                        statusDiv.style.whiteSpace = 'pre-line';
                    }
                }
            } catch (error) {
                if (statusDiv) {
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    statusDiv.textContent = `‚ùå Error: ${error.message}`;
                }
                console.error('Twitter post error:', error);
            }
        }
        
        function generateHashtags() {
            const hashtagSets = {
                'digital-marketing': ['#DigitalMarketing', '#MarketingStrategy', '#BusinessGrowth', '#OnlineMarketing', '#MarketingTips'],
                'insurance': ['#Insurance', '#AutoInsurance', '#HomeInsurance', '#BusinessInsurance', '#LifeInsurance'],
                'web-design': ['#WebDesign', '#WebsiteDesign', '#WebDevelopment', '#ResponsiveDesign', '#UXDesign'],
                'seo': ['#SEO', '#SearchEngineOptimization', '#LocalSEO', '#SEOTips', '#GoogleRankings'],
                'social-media': ['#SocialMedia', '#SocialMediaMarketing', '#FacebookMarketing', '#InstagramMarketing', '#ContentCreation'],
                'local-business': ['#LocalBusiness', '#GreensburgPA', '#WestmorelandCounty', '#Pittsburgh', '#LocalMarketing']
            };
            
            const industry = document.getElementById('hashtagIndustry').value;
            const hashtags = hashtagSets[industry] || hashtagSets['digital-marketing'];
            const container = document.getElementById('hashtagResults');
            container.innerHTML = '';
            
            hashtags.forEach(hashtag => {
                const span = document.createElement('span');
                span.className = 'hashtag';
                span.textContent = hashtag;
                span.onclick = () => {
                    navigator.clipboard.writeText(hashtag);
                    alert('Copied: ' + hashtag);
                };
                container.appendChild(span);
            });
        }
        
        function addClient() {
            const clientName = document.getElementById('newClientName').value;
            if (!clientName) {
                alert('Please enter a client name');
                return;
            }
            
            const clientItem = document.createElement('div');
            clientItem.className = 'client-item';
            clientItem.innerHTML = `
                <div>
                    <div class="client-name">${clientName}</div>
                    <div style="font-size: 0.8rem; color: #6c757d;">New Client</div>
                </div>
                <span class="client-status status-active">Active</span>
            `;
            document.getElementById('clientList').appendChild(clientItem);
            document.getElementById('newClientName').value = '';
            alert('Client added successfully!');
        }
        
        function showApiConfig() {
            alert('API Configuration:\n\n1. Use "Connect Facebook/Instagram" button for Meta\n2. Visit test-facebook-posting.html to test your tokens\n3. Tokens are saved in browser localStorage');
        }
        
        function exportToBuffer() { alert('Export to Buffer feature coming soon!'); }
        function exportToHootsuite() { alert('Export to Hootsuite feature coming soon!'); }
        function exportToLater() { alert('Export to Later feature coming soon!'); }
        function exportToWebhook() { alert('Export to Webhook feature coming soon!'); }
        function schedulePostReal() { alert('Real-time scheduling coming soon!'); }
        function schedulePost() { alert('CSV Export coming soon!'); }
    </script>
</body>
</html>

