class TNRCRMData{constructor(){this.api=null,this.useAPI=!1,this.clients=[],this.leads=[],this.orders=[],this.formSubmissions=[],this.initialize(),this.checkForNewSubmissions(),this.initializeNotifications()}initialize(){try{"undefined"!=typeof TNRAdminAPI?(this.api=new TNRAdminAPI,this.useAPI=!0,this.loadFromAPI().catch(t=>{this.loadFromLocalStorage()})):this.loadFromLocalStorage()}catch(t){this.useAPI=!1,this.loadFromLocalStorage()}}async loadFromAPI(){if(!this.api)return;const[t,e,s]=await Promise.all([this.api.getClients().catch(()=>[]),this.api.getLeads().catch(()=>[]),this.api.getOrders().catch(()=>[])]);this.clients=t,this.leads=e,this.orders=s}loadFromLocalStorage(){this.clients=this.loadClients(),this.leads=this.loadLeads(),this.orders=this.loadOrders(),this.formSubmissions=this.loadFormSubmissions()}loadClients(){const t=localStorage.getItem("tnr_crm_clients");return t?JSON.parse(t):[]}loadLeads(){const t=localStorage.getItem("tnr_crm_leads");return t?JSON.parse(t):[]}loadOrders(){const t=localStorage.getItem("tnr_crm_orders");return t?JSON.parse(t):[]}loadFormSubmissions(){return[]}checkForNewSubmissions(){const t=localStorage.getItem("tnr_form_submissions");if(t){const e=JSON.parse(t);this.autoConvertSubmissionsToLeads(e)}}autoConvertSubmissionsToLeads(t){let e=0;return t.forEach(t=>{if(!t.convertedToLead){const s={name:t.name||"Unknown",email:t.email||"",phone:t.phone||"",company:t.company||"",website:t.website||"",industry:t.industry||"Not specified",services:Array.isArray(t.services)?t.services:[t.services||"Not specified"],budget:t.budget||"",timeline:t.timeline||"",message:t.message||"",additionalInfo:t.additionalInfo||"",contactMethod:t.contactMethod||"",source:t.source||"Website Form",status:"New",submissionDate:t.submissionDate||t.timestamp||(new Date).toLocaleString(),submissionDateTime:t.submissionDateTime||t.timestamp||(new Date).toISOString(),originalSubmissionId:t.id};this.addLead(s),e++,t.convertedToLead=!0}}),t.length>0&&localStorage.setItem("tnr_form_submissions",JSON.stringify(t)),this.saveToStorage(),e}addClient(t){return this.addClientAsync(t)}async addClientAsync(t){const e={id:"client-"+Date.now(),...t,joinDate:(new Date).toISOString().split("T")[0],lastContact:(new Date).toISOString().split("T")[0],status:"Active"};if(this.useAPI&&this.api)try{const t=await this.api.addClient(e);return this.clients.push(t),t}catch(t){}return this.clients.push(e),this.saveToStorage(),e}updateClient(t,e){return this.updateClientAsync(t,e)}async updateClientAsync(t,e){if(this.useAPI&&this.api)try{const s=await this.api.updateClient(t,e),i=this.clients.findIndex(e=>e.id===t);return-1!==i&&(this.clients[i]=s),s}catch(t){}const s=this.clients.findIndex(e=>e.id===t);return-1!==s?(this.clients[s]={...this.clients[s],...e},this.saveToStorage(),this.clients[s]):null}deleteClient(t){return this.deleteClientAsync(t)}async deleteClientAsync(t){if(this.useAPI&&this.api)try{return await this.api.deleteClient(t),this.clients=this.clients.filter(e=>e.id!==t),!0}catch(t){}this.clients=this.clients.filter(e=>e.id!==t),this.saveToStorage()}getClient(t){return this.clients.find(e=>e.id===t)}addLead(t){return this.addLeadAsync(t)}async addLeadAsync(t){const e={id:"lead-"+Date.now(),...t,date:(new Date).toISOString().split("T")[0],status:"New"};if(this.useAPI&&this.api)try{const t=await this.api.addLead(e);return this.leads.push(t),t}catch(t){}return this.leads.push(e),this.saveToStorage(),e}convertLeadToClient(t){return this.convertLeadToClientAsync(t)}async convertLeadToClientAsync(t){if(this.useAPI&&this.api)try{const e=await this.api.convertLeadToClient(t);return this.leads=this.leads.filter(e=>e.id!==t),this.clients.push(e),e}catch(t){}const e=this.leads.find(e=>e.id===t);if(e){const s=await this.addClient({name:e.name,email:e.email,phone:e.phone,industry:e.industry,address:e.address||"",services:e.services||[],notes:e.notes||"",source:e.source||"Lead Conversion"});return this.leads=this.leads.filter(e=>e.id!==t),this.saveToStorage(),s}return null}addOrder(t){const e={id:"order-"+Date.now(),...t,orderDate:(new Date).toISOString().split("T")[0],status:"Pending"};return this.orders.push(e),this.saveToStorage(),e}updateOrder(t,e){const s=this.orders.findIndex(e=>e.id===t);return-1!==s?(this.orders[s]={...this.orders[s],...e},this.saveToStorage(),this.orders[s]):null}getStats(){return{totalClients:this.clients.length,activeClients:this.clients.filter(t=>"Active"===t.status).length,newLeads:this.leads.filter(t=>"New"===t.status||"Viewed"===t.status).length,totalOrders:this.orders.length,completedOrders:this.orders.filter(t=>"Completed"===t.status).length,pendingOrders:this.orders.filter(t=>"Pending"===t.status).length,inProgressOrders:this.orders.filter(t=>"In Progress"===t.status).length,totalRevenue:this.orders.reduce((t,e)=>t+(e.amount||0),0)}}saveToStorage(){localStorage.setItem("tnr_crm_clients",JSON.stringify(this.clients)),localStorage.setItem("tnr_crm_leads",JSON.stringify(this.leads)),localStorage.setItem("tnr_crm_orders",JSON.stringify(this.orders)),localStorage.setItem("tnr_crm_form_submissions",JSON.stringify(this.formSubmissions))}loadFromStorage(){const t=localStorage.getItem("tnr_crm_clients"),e=localStorage.getItem("tnr_crm_leads"),s=localStorage.getItem("tnr_crm_orders"),i=localStorage.getItem("tnr_crm_form_submissions");t&&(this.clients=JSON.parse(t)),e&&(this.leads=JSON.parse(e)),s&&(this.orders=JSON.parse(s)),i&&(this.formSubmissions=JSON.parse(i))}initializeNotifications(){this.addNotificationCSS(),this.updateNotificationCount(),setInterval(()=>{this.updateNotificationCount()},5e3)}addNotificationCSS(){if("undefined"==typeof document||document.getElementById("crm-notification-css"))return;const t=document.createElement("style");t.id="crm-notification-css",t.textContent="\n      .crm-notification-bubble {\n        position: absolute;\n        top: -8px;\n        right: -8px;\n        background: #ff4444;\n        color: white;\n        border-radius: 50%;\n        width: 20px;\n        height: 20px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 12px;\n        font-weight: bold;\n        z-index: 1000;\n        animation: pulse 2s infinite;\n        box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n      }\n      \n      .crm-notification-bubble.hidden {\n        display: none;\n      }\n      \n      @keyframes pulse {\n        0% { transform: scale(1); }\n        50% { transform: scale(1.1); }\n        100% { transform: scale(1); }\n      }\n      \n      .crm-button-container {\n        position: relative;\n        display: inline-block;\n      }\n    ",document.head.appendChild(t)}updateNotificationCount(){const t=this.leads.filter(t=>"New"===t.status).length;"undefined"!=typeof document&&document.querySelectorAll('a[href*="admin-dashboard"], a[href*="crm"], .crm-button').forEach(e=>{if(!e.parentElement.classList.contains("crm-button-container")){const t=document.createElement("div");t.className="crm-button-container",e.parentNode.insertBefore(t,e),t.appendChild(e)}let s=e.parentElement.querySelector(".crm-notification-bubble");s||(s=document.createElement("div"),s.className="crm-notification-bubble",e.parentElement.appendChild(s)),t>0?(s.textContent=t>99?"99+":t.toString(),s.classList.remove("hidden")):s.classList.add("hidden")})}markLeadsAsViewed(){this.leads.forEach(t=>{"New"===t.status&&(t.status="Viewed")}),this.saveToStorage(),this.updateNotificationCount()}processFormSubmission(t){const e=this.addLead({name:t.name||"Unknown",email:t.email||"",phone:t.phone||"",industry:t.industry||"General",message:t.message||"",source:"Website Form",services:t.services||[]});return this.updateNotificationCount(),e}}window.TNRCRMData=TNRCRMData,"undefined"!=typeof window&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.tnrCRM=new TNRCRMData}):window.tnrCRM=new TNRCRMData);