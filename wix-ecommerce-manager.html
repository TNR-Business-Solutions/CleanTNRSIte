<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wix E-commerce Manager - TNR Business Solutions</title>
    <style>
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .btn { padding: 10px 25px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px; margin-bottom: 10px; }
        .btn:hover { background: #5568d3; }
        .btn-success { background: #28a745; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .product-card { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #ddd; }
        .product-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 5px; margin-bottom: 10px; }
        .product-card h3 { margin: 10px 0 5px 0; font-size: 1.1em; }
        .product-card .price { font-size: 1.3em; color: #667eea; font-weight: bold; }
        .filter-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .filter-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .loading { text-align: center; padding: 40px; color: #667eea; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõí Wix E-commerce Manager</h1>
            <p>Manage products, inventory, and orders for your Wix clients</p>
        </div>
        
        <div class="card">
            <h2>Select Client</h2>
            <select id="instanceSelect" class="form-group" onchange="selectInstance()">
                <option value="">-- Select a Wix Client --</option>
            </select>
        </div>
        
        <div id="ecommerceTools" style="display: none;">
            <!-- Quick Actions -->
            <div class="card">
                <h2>‚ö° Quick Actions</h2>
                <button class="btn" onclick="showAddProduct()">‚ûï Add New Product</button>
                <button class="btn btn-success" onclick="syncToShopify()">üîÑ Sync to Shopify</button>
                <button class="btn" onclick="bulkUpdate()">üì¶ Bulk Update</button>
                <button class="btn" onclick="viewOrders()">üìã View Orders</button>
            </div>
            
            <!-- Advanced Filters -->
            <div class="card">
                <h2>üîç Advanced Product Filters</h2>
                <div class="filter-section">
                    <div class="filter-row">
                        <div class="form-group">
                            <label>Min Price</label>
                            <input type="number" id="minPrice" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label>Max Price</label>
                            <input type="number" id="maxPrice" placeholder="999.99">
                        </div>
                        <div class="form-group">
                            <label>In Stock Only</label>
                            <select id="inStockOnly">
                                <option value="">All</option>
                                <option value="true">In Stock</option>
                                <option value="false">Out of Stock</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Collection</label>
                            <select id="collectionFilter">
                                <option value="">All Collections</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="applyFilters()">Apply Filters</button>
                    <button class="btn" onclick="clearFilters()">Clear Filters</button>
                </div>
            </div>
            
            <!-- Products Grid -->
            <div class="card">
                <h2>üì¶ Products</h2>
                <div id="productsGrid" class="loading">Loading products...</div>
            </div>
        </div>
    </div>
    
    <script>
        let selectedInstance = null;
        let allProducts = [];
        
        // Load clients
        async function loadClients() {
            try {
                const response = await fetch('/api/wix?action=listClients');
                const data = await response.json();
                
                const select = document.getElementById('instanceSelect');
                data.clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.instanceId;
                    option.textContent = `${client.clientId || 'Unnamed'} (${client.instanceId})`;
                    select.appendChild(option);
                });
                
                // Check URL params
                const urlParams = new URLSearchParams(window.location.search);
                const instanceId = urlParams.get('instanceId');
                if (instanceId) {
                    select.value = instanceId;
                    selectInstance();
                }
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }
        
        function selectInstance() {
            selectedInstance = document.getElementById('instanceSelect').value;
            if (selectedInstance) {
                document.getElementById('ecommerceTools').style.display = 'block';
                loadProducts();
                loadCollections();
            } else {
                document.getElementById('ecommerceTools').style.display = 'none';
            }
        }
        
        // Load products
        async function loadProducts() {
            if (!selectedInstance) return;
            
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '<div class="loading">Loading products...</div>';
            
            try {
                const response = await fetch('/api/wix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getProducts',
                        instanceId: selectedInstance,
                        options: { limit: 100 }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    allProducts = data.data.products || [];
                    displayProducts(allProducts);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                grid.innerHTML = `<p style="color: red;">Error loading products: ${error.message}</p>`;
            }
        }
        
        // Display products
        function displayProducts(products) {
            const grid = document.getElementById('productsGrid');
            
            if (products.length === 0) {
                grid.innerHTML = '<p>No products found</p>';
                return;
            }
            
            grid.innerHTML = products.map(product => `
                <div class="product-card">
                    ${product.media?.items?.[0]?.url ? 
                        `<img src="${product.media.items[0].url}" alt="${product.name}">` :
                        '<div style="height: 150px; background: #ddd; border-radius: 5px; margin-bottom: 10px;"></div>'}
                    <h3>${product.name}</h3>
                    <p class="price">$${product.price || '0.00'}</p>
                    <p>SKU: ${product.sku || 'N/A'}</p>
                    <p>Stock: ${product.stock?.quantity || 0}</p>
                    <button class="btn" onclick="editProduct('${product.id}')">Edit</button>
                </div>
            `).join('');
        }
        
        // Load collections
        async function loadCollections() {
            if (!selectedInstance) return;
            
            try {
                const response = await fetch('/api/wix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getCollections',
                        instanceId: selectedInstance
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('collectionFilter');
                    (data.data.collections || []).forEach(collection => {
                        const option = document.createElement('option');
                        option.value = collection.id;
                        option.textContent = collection.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading collections:', error);
            }
        }
        
        // Apply advanced filters
        async function applyFilters() {
            if (!selectedInstance) return;
            
            const filterConfig = {
                priceRange: {
                    min: parseFloat(document.getElementById('minPrice').value) || 0,
                    max: parseFloat(document.getElementById('maxPrice').value) || 999999
                },
                inStockOnly: document.getElementById('inStockOnly').value === 'true',
                collections: document.getElementById('collectionFilter').value ? 
                    [document.getElementById('collectionFilter').value] : []
            };
            
            try {
                const response = await fetch('/api/wix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'createAdvancedFilter',
                        instanceId: selectedInstance,
                        filterConfig
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayProducts(data.data.products || []);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                alert(`Error applying filters: ${error.message}`);
            }
        }
        
        function clearFilters() {
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            document.getElementById('inStockOnly').value = '';
            document.getElementById('collectionFilter').value = '';
            displayProducts(allProducts);
        }
        
        function showAddProduct() {
            alert('Add product form coming soon!');
        }
        
        function editProduct(productId) {
            alert(`Edit product: ${productId}\nProduct editing interface coming soon!`);
        }
        
        async function syncToShopify() {
            if (!confirm('Sync all products to Shopify?')) return;
            
            try {
                const response = await fetch('/api/wix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'syncProductsToExternal',
                        instanceId: selectedInstance,
                        platform: 'shopify',
                        productIds: []
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Prepared ${data.data.productsCount} products for Shopify sync!`);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }
        
        function bulkUpdate() {
            alert('Bulk update interface coming soon!');
        }
        
        function viewOrders() {
            alert('Orders interface coming soon!');
        }
        
        loadClients();
    </script>
</body>
</html>

