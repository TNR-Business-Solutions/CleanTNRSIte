<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Centralized content library for managing reusable content across all platforms">
    <title>Content Library - TNR Business Solutions</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header h1 { margin: 0 0 10px 0; font-size: 2.5em; }
        .header p { margin: 0; opacity: 0.9; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .btn { padding: 10px 25px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; margin-right: 10px; margin-bottom: 10px; transition: all 0.3s; }
        .btn:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-small { padding: 5px 15px; font-size: 0.9em; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em; font-family: inherit; }
        .form-group textarea { min-height: 150px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .content-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .content-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; transition: all 0.3s; }
        .content-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .content-card h3 { margin: 0 0 10px 0; color: #333; }
        .content-card .content-preview { color: #666; font-size: 0.9em; margin: 10px 0; max-height: 100px; overflow: hidden; }
        .content-card .meta { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; font-size: 0.85em; color: #999; }
        .content-card .tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .tag { background: #667eea; color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.8em; }
        .tag.category { background: #28a745; }
        .tag.platform { background: #17a2b8; }
        .search-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-bar input { flex: 1; }
        .filter-bar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .filter-chip { background: #e0e0e0; padding: 8px 15px; border-radius: 20px; cursor: pointer; transition: all 0.3s; }
        .filter-chip:hover { background: #d0d0d0; }
        .filter-chip.active { background: #667eea; color: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
        .modal.active { display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; }
        .close-btn { background: none; border: none; font-size: 2em; cursor: pointer; color: #666; }
        .close-btn:hover { color: #333; }
        .alert { padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; }
        .alert-success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .alert-error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .loading { text-align: center; padding: 40px; color: #667eea; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-card .value { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .stat-card .label { opacity: 0.9; font-size: 0.9em; }
        .quick-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .content-grid { grid-template-columns: 1fr; }
        }
    </style>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Content Library</h1>
            <p>Centralized repository for reusable content across all platforms</p>
        </div>

        <div id="alertContainer"></div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">Total Items</div>
                <div class="value" id="totalItems">0</div>
            </div>
            <div class="stat-card">
                <div class="label">Templates</div>
                <div class="value" id="templateCount">0</div>
            </div>
            <div class="stat-card">
                <div class="label">Categories</div>
                <div class="value" id="categoryCount">0</div>
            </div>
            <div class="stat-card">
                <div class="label">Platforms</div>
                <div class="value" id="platformCount">0</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <h2>‚ö° Quick Actions</h2>
            <div class="quick-actions">
                <button class="btn btn-success" onclick="showAddContentModal()">‚ûï Add Content</button>
                <button class="btn" onclick="showAddTemplateModal()">üìù Create Template</button>
                <button class="btn" onclick="exportLibrary()">üì• Export Library</button>
                <button class="btn" onclick="importLibrary()">üì§ Import Library</button>
                <button class="btn btn-secondary" onclick="loadContentLibrary()">üîÑ Refresh</button>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="card">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search content..." onkeyup="filterContent()">
                <button class="btn" onclick="filterContent()">üîç Search</button>
            </div>
            <div class="filter-bar">
                <div class="filter-chip" onclick="toggleFilter('category', 'all')" data-filter="category-all">All Categories</div>
                <div class="filter-chip" onclick="toggleFilter('platform', 'all')" data-filter="platform-all">All Platforms</div>
                <div class="filter-chip" onclick="toggleFilter('type', 'all')" data-filter="type-all">All Types</div>
            </div>
            <div id="activeFilters"></div>
        </div>

        <!-- Content Grid -->
        <div class="card">
            <h2>üìö Content Library</h2>
            <div id="contentGrid" class="loading">Loading content library...</div>
        </div>
    </div>

    <!-- Add/Edit Content Modal -->
    <div id="contentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="contentModalTitle">Add Content</h2>
                <button class="close-btn" onclick="closeModal('contentModal')">&times;</button>
            </div>
            <form id="contentForm" onsubmit="saveContent(event)">
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="contentTitle" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Category *</label>
                        <select id="contentCategory" required>
                            <option value="">Select Category</option>
                            <option value="social-media">Social Media</option>
                            <option value="email">Email</option>
                            <option value="blog">Blog</option>
                            <option value="website">Website</option>
                            <option value="advertising">Advertising</option>
                            <option value="general">General</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Platform</label>
                        <select id="contentPlatform" multiple style="height: 100px;">
                            <option value="facebook">Facebook</option>
                            <option value="instagram">Instagram</option>
                            <option value="twitter">Twitter/X</option>
                            <option value="linkedin">LinkedIn</option>
                            <option value="pinterest">Pinterest</option>
                            <option value="tiktok">TikTok</option>
                            <option value="youtube">YouTube</option>
                            <option value="email">Email</option>
                            <option value="blog">Blog</option>
                            <option value="website">Website</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Content *</label>
                    <div id="contentEditor" style="min-height: 300px;"></div>
                    <textarea id="contentText" style="display: none;" required></textarea>
                </div>
                <div class="form-group">
                    <label>Tags (comma-separated)</label>
                    <input type="text" id="contentTags" placeholder="marketing, promotion, sale">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="contentNotes" placeholder="Internal notes about this content..."></textarea>
                </div>
                <input type="hidden" id="contentId">
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success">üíæ Save Content</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('contentModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let contentLibrary = [];
        let contentEditor = null;
        let activeFilters = {
            category: 'all',
            platform: 'all',
            type: 'all',
            search: ''
        };

        // Initialize Quill editor
        function initializeEditor() {
            if (!contentEditor && document.getElementById('contentEditor')) {
                contentEditor = new Quill('#contentEditor', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'color': [] }, { 'background': [] }],
                            ['link', 'image'],
                            ['clean']
                        ]
                    }
                });
                contentEditor.on('text-change', function() {
                    document.getElementById('contentText').value = contentEditor.root.innerHTML;
                });
            }
        }

        // Load content library
        async function loadContentLibrary() {
            try {
                const response = await fetch('/api/content-library');
                const data = await response.json();
                
                if (data.success) {
                    contentLibrary = data.data || [];
                    displayContent();
                    updateStats();
                } else {
                    throw new Error(data.error || 'Failed to load content library');
                }
            } catch (error) {
                showAlert('error', `Error loading content library: ${error.message}`);
                document.getElementById('contentGrid').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        function displayContent() {
            const grid = document.getElementById('contentGrid');
            const filtered = filterContentLibrary();
            
            if (filtered.length === 0) {
                grid.innerHTML = '<p>No content found. Click "Add Content" to create your first item.</p>';
                return;
            }
            
            grid.innerHTML = '<div class="content-grid">' + filtered.map(item => `
                <div class="content-card">
                    <h3>${item.title}</h3>
                    <div class="content-preview">${stripHTML(item.content).substring(0, 150)}...</div>
                    <div class="tags">
                        <span class="tag category">${item.category}</span>
                        ${item.platforms ? item.platforms.map(p => `<span class="tag platform">${p}</span>`).join('') : ''}
                        ${item.tags ? item.tags.map(t => `<span class="tag">${t}</span>`).join('') : ''}
                    </div>
                    <div class="meta">
                        <span>${new Date(item.createdAt).toLocaleDateString()}</span>
                        <div>
                            <button class="btn btn-small" onclick="useContent('${item.id}')">üìã Use</button>
                            <button class="btn btn-small" onclick="editContent('${item.id}')">‚úèÔ∏è Edit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteContent('${item.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('') + '</div>';
        }

        function filterContentLibrary() {
            return contentLibrary.filter(item => {
                // Search filter
                if (activeFilters.search) {
                    const searchLower = activeFilters.search.toLowerCase();
                    if (!item.title.toLowerCase().includes(searchLower) &&
                        !stripHTML(item.content).toLowerCase().includes(searchLower) &&
                        !(item.tags && item.tags.some(t => t.toLowerCase().includes(searchLower)))) {
                        return false;
                    }
                }
                
                // Category filter
                if (activeFilters.category !== 'all' && item.category !== activeFilters.category) {
                    return false;
                }
                
                // Platform filter
                if (activeFilters.platform !== 'all' && 
                    (!item.platforms || !item.platforms.includes(activeFilters.platform))) {
                    return false;
                }
                
                return true;
            });
        }

        function filterContent() {
            activeFilters.search = document.getElementById('searchInput').value;
            displayContent();
        }

        function toggleFilter(type, value) {
            activeFilters[type] = value;
            updateFilterChips();
            displayContent();
        }

        function updateFilterChips() {
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            
            Object.keys(activeFilters).forEach(key => {
                if (activeFilters[key] !== 'all') {
                    const chip = document.querySelector(`[data-filter="${key}-${activeFilters[key]}"]`);
                    if (chip) chip.classList.add('active');
                }
            });
        }

        function updateStats() {
            document.getElementById('totalItems').textContent = contentLibrary.length;
            document.getElementById('templateCount').textContent = contentLibrary.filter(c => c.isTemplate).length;
            const categories = [...new Set(contentLibrary.map(c => c.category))];
            document.getElementById('categoryCount').textContent = categories.length;
            const platforms = [...new Set(contentLibrary.flatMap(c => c.platforms || []))];
            document.getElementById('platformCount').textContent = platforms.length;
        }

        function showAddContentModal() {
            document.getElementById('contentModalTitle').textContent = 'Add Content';
            document.getElementById('contentForm').reset();
            document.getElementById('contentId').value = '';
            if (contentEditor) contentEditor.setContents([]);
            document.getElementById('contentModal').classList.add('active');
            initializeEditor();
        }

        function editContent(id) {
            const item = contentLibrary.find(c => c.id === id);
            if (!item) return;
            
            document.getElementById('contentModalTitle').textContent = 'Edit Content';
            document.getElementById('contentId').value = item.id;
            document.getElementById('contentTitle').value = item.title;
            document.getElementById('contentCategory').value = item.category;
            if (item.platforms) {
                Array.from(document.getElementById('contentPlatform').options).forEach(opt => {
                    opt.selected = item.platforms.includes(opt.value);
                });
            }
            if (contentEditor) {
                contentEditor.root.innerHTML = item.content;
            }
            document.getElementById('contentText').value = item.content;
            document.getElementById('contentTags').value = item.tags ? item.tags.join(', ') : '';
            document.getElementById('contentNotes').value = item.notes || '';
            document.getElementById('contentModal').classList.add('active');
            initializeEditor();
        }

        async function saveContent(event) {
            event.preventDefault();
            
            const content = contentEditor ? contentEditor.root.innerHTML : document.getElementById('contentText').value;
            const selectedPlatforms = Array.from(document.getElementById('contentPlatform').selectedOptions).map(o => o.value);
            
            const contentData = {
                id: document.getElementById('contentId').value || undefined,
                title: document.getElementById('contentTitle').value,
                category: document.getElementById('contentCategory').value,
                platforms: selectedPlatforms,
                content: content,
                tags: document.getElementById('contentTags').value.split(',').map(t => t.trim()).filter(t => t),
                notes: document.getElementById('contentNotes').value,
                isTemplate: false
            };
            
            try {
                const response = await fetch('/api/content-library', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(contentData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', `‚úÖ Content ${contentData.id ? 'updated' : 'saved'} successfully!`);
                    closeModal('contentModal');
                    loadContentLibrary();
                } else {
                    throw new Error(data.error || 'Failed to save content');
                }
            } catch (error) {
                showAlert('error', `‚ùå Error: ${error.message}`);
            }
        }

        async function deleteContent(id) {
            if (!confirm('Are you sure you want to delete this content?')) return;
            
            try {
                const response = await fetch(`/api/content-library/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', '‚úÖ Content deleted successfully!');
                    loadContentLibrary();
                } else {
                    throw new Error(data.error || 'Failed to delete content');
                }
            } catch (error) {
                showAlert('error', `‚ùå Error: ${error.message}`);
            }
        }

        function useContent(id) {
            const item = contentLibrary.find(c => c.id === id);
            if (!item) return;
            
            // Check if opened from another module
            const opener = window.opener;
            const targetId = sessionStorage.getItem('contentLibraryTarget') || (opener ? opener.sessionStorage?.getItem('contentLibraryTarget') : null);
            
            if (targetId && opener) {
                // Insert into opener's textarea
                try {
                    const openerTextarea = opener.document.getElementById(targetId);
                    if (openerTextarea) {
                        const tmp = document.createElement('DIV');
                        tmp.innerHTML = item.content;
                        const textContent = tmp.textContent || tmp.innerText || item.content;
                        openerTextarea.value = textContent;
                        openerTextarea.dispatchEvent(new Event('input'));
                        
                        // Update usage count
                        fetch(`/api/content-library/${id}`, { method: 'PUT' });
                        
                        showAlert('success', '‚úÖ Content inserted!');
                        setTimeout(() => window.close(), 1000);
                        return;
                    }
                } catch (e) {
                    console.error('Error inserting into opener:', e);
                }
            }
            
            // Store in sessionStorage for use in other modules
            const contentData = {
                id: item.id,
                title: item.title,
                content: item.content,
                category: item.category,
                platforms: item.platforms
            };
            
            // Use localStorage for cross-window communication
            localStorage.setItem('selectedContent', JSON.stringify(contentData));
            
            // Trigger storage event for other windows
            window.dispatchEvent(new StorageEvent('storage', {
                key: 'selectedContent',
                newValue: JSON.stringify(contentData)
            }));
            
            // Update usage count
            fetch(`/api/content-library/${id}`, { method: 'PUT' });
            
            // Show options
            const platforms = item.platforms || [];
            if (platforms.length > 0 && !targetId) {
                const platform = prompt(`Select platform to use this content:\n${platforms.join(', ')}\n\nOr press Cancel to copy to clipboard.`);
                if (platform && platforms.includes(platform.toLowerCase())) {
                    window.location.href = getPlatformUrl(platform.toLowerCase(), item);
                    return;
                }
            }
            
            // Copy to clipboard
            const textContent = stripHTML(item.content);
            navigator.clipboard.writeText(textContent).then(() => {
                showAlert('success', '‚úÖ Content copied to clipboard!');
            });
        }

        function getPlatformUrl(platform, content) {
            const urls = {
                'facebook': '/social-media-automation-dashboard.html?tab=facebook&content=' + encodeURIComponent(content.id),
                'instagram': '/social-media-automation-dashboard.html?tab=instagram&content=' + encodeURIComponent(content.id),
                'twitter': '/social-media-automation-dashboard.html?tab=twitter&content=' + encodeURIComponent(content.id),
                'linkedin': '/social-media-automation-dashboard.html?tab=linkedin&content=' + encodeURIComponent(content.id),
                'email': '/admin/campaigns/?content=' + encodeURIComponent(content.id),
                'blog': '/wix-content-manager.html?content=' + encodeURIComponent(content.id),
                'website': '/wix-content-manager.html?content=' + encodeURIComponent(content.id)
            };
            return urls[platform] || '/content-library.html';
        }

        function showAddTemplateModal() {
            showAddContentModal();
            // Template creation can reuse the same modal
        }

        function exportLibrary() {
            const dataStr = JSON.stringify(contentLibrary, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `content-library-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showAlert('success', '‚úÖ Content library exported!');
        }

        function importLibrary() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const imported = JSON.parse(text);
                    
                    // Import items
                    for (const item of imported) {
                        await fetch('/api/content-library', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(item)
                        });
                    }
                    
                    showAlert('success', '‚úÖ Content library imported!');
                    loadContentLibrary();
                } catch (error) {
                    showAlert('error', `‚ùå Import error: ${error.message}`);
                }
            };
            input.click();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAlert(type, message) {
            const container = document.getElementById('alertContainer');
            const alertClass = `alert-${type}`;
            container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function stripHTML(html) {
            const tmp = document.createElement('DIV');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        // Initialize
        loadContentLibrary();
        initializeEditor();
    </script>
</body>
</html>

